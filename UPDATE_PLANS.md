# Планы обновления платформы

## Безопасность

### 1. Аутентификация и авторизация
**Задача:** Реализовать систему аутентификации пользователей с ролями (администратор, преподаватель, ученик).

**Инструменты:**
- Flask-Login для управления сессиями пользователей
- Flask-Bcrypt для хеширования паролей
- SQLAlchemy для хранения учетных данных в таблице Users
- Flask-Principal для управления ролями и правами доступа

**Действия:**
- Создать модель User с полями: id, username, email, password_hash, role, created_at
- Реализовать формы регистрации и входа через Flask-WTF
- Добавить декораторы @login_required и @role_required для защиты маршрутов
- Настроить сессии с secure cookies и httpOnly флагами

### 2. Защита от SQL-инъекций
**Задача:** Обеспечить полную защиту от SQL-инъекций во всех запросах к базе данных.

**Инструменты:**
- SQLAlchemy ORM для всех запросов (замена прямых SQL-запросов)
- Параметризованные запросы через text() с bindparam()

**Действия:**
- Заменить все прямые SQL-запросы в ensure_schema_columns() на SQLAlchemy методы
- Использовать db.session.execute(text("..."), params) вместо строковой интерполяции
- Добавить валидацию всех пользовательских входных данных перед запросами

### 3. CSRF защита
**Задача:** Расширить CSRF защиту на все формы и AJAX-запросы.

**Инструменты:**
- Flask-WTF CSRFProtect для всех форм
- CSRF токены в AJAX-запросах через заголовки X-CSRFToken

**Действия:**
- Включить CSRFProtect() глобально в приложении
- Добавить {% csrf_token %} во все формы
- Настроить AJAX-запросы для передачи CSRF токена в заголовках

### 4. Валидация входных данных
**Задача:** Реализовать строгую валидацию всех пользовательских данных на сервере и клиенте.

**Инструменты:**
- WTForms валидаторы для серверной валидации
- JavaScript валидация на клиенте
- Marshmallow для валидации JSON API запросов

**Действия:**
- Добавить валидаторы: Length, Regex, URL, Email для всех полей форм
- Реализовать кастомные валидаторы для platform_id, дат, времени
- Добавить санитизацию HTML контента через bleach или html_sanitizer
- Валидировать JSON payloads через Marshmallow схемы

### 5. Rate Limiting
**Задача:** Ограничить частоту запросов для предотвращения злоупотреблений.

**Инструменты:**
- Flask-Limiter для ограничения запросов по IP и пользователю
- Redis для хранения счетчиков (опционально, можно использовать in-memory)

**Действия:**
- Установить лимиты: 100 запросов/минуту для обычных маршрутов, 10/минуту для создания/удаления
- Добавить декоратор @limiter.limit() к критическим маршрутам
- Настроить обработку ошибок 429 Too Many Requests

### 6. Безопасное хранение секретов
**Задача:** Убрать все секреты из кода и использовать переменные окружения.

**Инструменты:**
- python-dotenv для загрузки .env файлов
- os.environ для доступа к переменным окружения
- secrets модуль Python для генерации SECRET_KEY

**Действия:**
- Создать .env.example с шаблоном переменных
- Перенести SECRET_KEY, DATABASE_URL в переменные окружения
- Добавить .env в .gitignore
- Реализовать проверку наличия обязательных переменных при старте приложения

### 7. Шифрование базы данных
**Задача:** Зашифровать чувствительные данные в базе данных.

**Инструменты:**
- SQLCipher для шифрования SQLite базы данных
- cryptography для шифрования отдельных полей (email, phone)

**Действия:**
- Мигрировать на SQLCipher или PostgreSQL с шифрованием на уровне БД
- Зашифровать поля: Student.email, Student.phone через Fernet (symmetric encryption)
- Хранить ключи шифрования в переменных окружения

## Архитектура и структура кода

### 8. Рефакторинг app.py на Blueprints
**Задача:** Разбить монолитный app.py на модульные blueprints.

**Инструменты:**
- Flask Blueprints для организации маршрутов
- Структура: routes/students.py, routes/lessons.py, routes/schedule.py, routes/tasks.py

**Действия:**
- Создать blueprints: students_bp, lessons_bp, schedule_bp, tasks_bp, auth_bp
- Перенести маршруты в соответствующие blueprints
- Вынести общую логику в utils/helpers.py
- Создать services/ для бизнес-логики (student_service.py, lesson_service.py)

### 9. Разделение слоев (MVC/MVP)
**Задача:** Четко разделить модель, представление и контроллер.

**Инструменты:**
- Структура папок: models/, views/, controllers/, services/
- Dependency Injection через Flask-приложение контекст

**Действия:**
- models/ - SQLAlchemy модели (уже в core/db_models.py)
- views/ - Flask routes (blueprints)
- services/ - бизнес-логика (создание уроков, валидация данных)
- repositories/ - доступ к данным (абстракция над SQLAlchemy)

### 10. Конфигурация через классы
**Задача:** Организовать конфигурацию через классы для разных окружений.

**Инструменты:**
- Flask config classes (Config, DevelopmentConfig, ProductionConfig)
- python-dotenv для переменных окружения

**Действия:**
- Создать config.py с базовым классом Config
- Наследовать DevelopmentConfig, ProductionConfig, TestingConfig
- Использовать app.config.from_object() для загрузки конфигурации
- Вынести все настройки из app.py в config.py

### 11. Логирование и мониторинг
**Задача:** Настроить структурированное логирование и мониторинг ошибок.

**Инструменты:**
- Python logging с ротацией файлов (RotatingFileHandler)
- Sentry для отслеживания ошибок в продакшене
- Prometheus + Grafana для метрик (опционально)

**Действия:**
- Настроить разные уровни логирования (DEBUG, INFO, WARNING, ERROR)
- Добавить логирование всех критических операций (создание/удаление уроков, студентов)
- Интегрировать Sentry для автоматического отслеживания исключений
- Добавить метрики: количество запросов, время ответа, ошибки

## Производительность

### 12. Оптимизация запросов к базе данных
**Задача:** Устранить оставшиеся N+1 запросы и оптимизировать медленные запросы.

**Инструменты:**
- SQLAlchemy eager loading (joinedload, selectinload)
- Database indexes для часто используемых полей
- Query profiling через SQLAlchemy events

**Действия:**
- Добавить joinedload для всех связанных объектов в запросах
- Создать индексы: Students.platform_id, Lessons.student_id, LessonTasks.lesson_id
- Использовать select_related для оптимизации JOIN запросов
- Добавить пагинацию для больших списков (уже частично реализовано)

### 13. Кэширование
**Задача:** Реализовать кэширование часто запрашиваемых данных.

**Инструменты:**
- Flask-Caching с Redis backend
- Memcached как альтернатива
- In-memory cache для простых случаев

**Действия:**
- Кэшировать списки студентов, уроков на день/неделю
- Кэш для статистики (количество уроков, студентов)
- TTL кэша: 5 минут для динамических данных, 1 час для статических
- Инвалидация кэша при изменении данных

### 14. Миграция на PostgreSQL
**Задача:** Перейти с SQLite на PostgreSQL для лучшей производительности и масштабируемости.

**Инструменты:**
- PostgreSQL 15+
- SQLAlchemy с psycopg2 драйвером
- Alembic для миграций схемы БД

**Действия:**
- Установить PostgreSQL и создать базу данных
- Изменить SQLALCHEMY_DATABASE_URI на PostgreSQL connection string
- Использовать Alembic для управления миграциями вместо ensure_schema_columns()
- Настроить connection pooling через SQLAlchemy engine

### 15. Асинхронная обработка задач
**Задача:** Вынести долгие операции в фоновые задачи.

**Инструменты:**
- Celery для фоновых задач
- Redis/RabbitMQ как message broker
- Flask-Mail для отправки email уведомлений

**Действия:**
- Вынести парсинг заданий в Celery task
- Асинхронная отправка email уведомлений
- Фоновая обработка импорта/экспорта данных
- Настроить мониторинг очереди задач через Flower

## Функциональность

### 16. REST API
**Задача:** Создать REST API для интеграции с внешними системами.

**Инструменты:**
- Flask-RESTful или Flask-RESTX для структурирования API
- Marshmallow для сериализации/десериализации
- Flask-JWT-Extended для аутентификации API

**Действия:**
- Создать endpoints: /api/v1/students, /api/v1/lessons, /api/v1/schedule
- Реализовать CRUD операции через API
- Добавить версионирование API (/api/v1/, /api/v2/)
- Документировать API через Swagger/OpenAPI (Flask-RESTX автоматически)

### 17. Экспорт данных в различные форматы
**Задача:** Расширить возможности экспорта данных.

**Инструменты:**
- pandas для работы с данными
- openpyxl для Excel экспорта
- reportlab для PDF генерации
- jinja2 для шаблонов отчетов

**Действия:**
- Экспорт расписания в iCal формат (.ics)
- Экспорт статистики в Excel с графиками
- Генерация PDF отчетов по урокам/студентам
- Экспорт в CSV для анализа в Excel/Google Sheets

### 18. Система уведомлений
**Задача:** Реализовать уведомления о важных событиях.

**Инструменты:**
- Flask-Mail для email уведомлений
- WebSocket (Flask-SocketIO) для real-time уведомлений
- Push уведомления через браузер API

**Действия:**
- Email уведомления: напоминания об уроках, результаты проверки ДЗ
- In-app уведомления через WebSocket
- Настройки уведомлений в профиле пользователя
- История уведомлений в базе данных

### 19. Статистика и аналитика
**Задача:** Добавить детальную статистику и аналитику.

**Инструменты:**
- SQLAlchemy для агрегации данных
- Chart.js или Plotly для визуализации
- pandas для анализа данных

**Действия:**
- Статистика по студентам: количество уроков, средний балл, прогресс
- Статистика по заданиям: популярность, сложность, процент выполнения
- Графики посещаемости, динамика прогресса
- Экспорт отчетов в PDF/Excel

### 20. Мобильная адаптация
**Задача:** Оптимизировать интерфейс для мобильных устройств.

**Инструменты:**
- CSS Media Queries для адаптивного дизайна
- Bootstrap или Tailwind CSS для grid системы
- Touch events для мобильных жестов

**Действия:**
- Адаптировать календарь для мобильных экранов
- Упростить формы для touch-ввода
- Оптимизировать изображения и ресурсы
- Тестирование на реальных устройствах

### 21. Поиск и фильтрация
**Задача:** Улучшить поиск и добавить расширенные фильтры.

**Инструменты:**
- SQLAlchemy фильтры для поиска в БД
- Full-text search через SQLite FTS5 или PostgreSQL tsvector
- JavaScript для клиентской фильтрации

**Действия:**
- Полнотекстовый поиск по заданиям, студентам, урокам
- Фильтры: по дате, статусу, категории, студенту
- Сохранение фильтров в URL параметрах
- Автодополнение при вводе поискового запроса

### 22. Импорт из внешних источников
**Задача:** Автоматизировать импорт данных из внешних систем.

**Инструменты:**
- requests для HTTP запросов к API
- pandas для обработки CSV/Excel файлов
- BeautifulSoup для парсинга HTML (уже используется)

**Действия:**
- Импорт студентов из CSV/Excel файлов
- Синхронизация расписания через API (если доступно)
- Импорт заданий из других источников
- Валидация и обработка ошибок при импорте

## DevOps и развертывание

### 23. Контейнеризация
**Задача:** Упаковать приложение в Docker контейнеры.

**Инструменты:**
- Docker для контейнеризации приложения
- Docker Compose для оркестрации (app + PostgreSQL + Redis)
- Nginx как reverse proxy

**Действия:**
- Создать Dockerfile для Flask приложения
- docker-compose.yml с сервисами: web, db, redis, nginx
- Настроить volumes для данных и статики
- Оптимизировать образы (multi-stage build)

### 24. CI/CD pipeline
**Задача:** Настроить автоматическую сборку и развертывание.

**Инструменты:**
- GitHub Actions или GitLab CI для CI/CD
- pytest для тестирования
- Docker Hub для хранения образов

**Действия:**
- Автоматические тесты при push в репозиторий
- Сборка Docker образа при создании тега
- Автоматическое развертывание на staging/production
- Откат к предыдущей версии при ошибках

### 25. Автоматические бэкапы
**Задача:** Настроить автоматическое резервное копирование базы данных.

**Инструменты:**
- pg_dump для PostgreSQL бэкапов
- cron или systemd timer для расписания
- AWS S3 или другой cloud storage для хранения

**Действия:**
- Ежедневные бэкапы базы данных
- Хранение бэкапов в облаке с ротацией (30 дней)
- Автоматическое восстановление из бэкапа при необходимости
- Уведомления об успешных/неуспешных бэкапах

### 26. Мониторинг и алертинг
**Задача:** Настроить мониторинг состояния приложения.

**Инструменты:**
- Prometheus для сбора метрик
- Grafana для визуализации
- Alertmanager для уведомлений

**Действия:**
- Метрики: uptime, response time, error rate, database connections
- Дашборды в Grafana с ключевыми метриками
- Алерты при критических ошибках или падении сервиса
- Логирование всех запросов в централизованное хранилище

## Тестирование

### 27. Unit тесты
**Задача:** Покрыть код unit тестами для критических функций.

**Инструменты:**
- pytest для тестирования
- pytest-cov для покрытия кода
- unittest.mock для мокирования зависимостей

**Действия:**
- Тесты для бизнес-логики (создание уроков, валидация данных)
- Тесты для моделей БД
- Тесты для утилит (конвертация времени, форматирование)
- Цель: 80% покрытия кода тестами

### 28. Integration тесты
**Задача:** Протестировать интеграцию компонентов системы.

**Инструменты:**
- pytest с фикстурами для тестовой БД
- Flask test client для тестирования маршрутов
- Factory pattern для создания тестовых данных

**Действия:**
- Тесты API endpoints с реальной БД
- Тесты форм и валидации
- Тесты интеграции с внешними сервисами (моки)
- Тесты миграций БД

### 29. E2E тесты
**Задача:** Автоматизировать тестирование пользовательских сценариев.

**Инструменты:**
- Playwright или Selenium для браузерной автоматизации
- pytest-playwright для интеграции с pytest

**Действия:**
- Тесты критических пользовательских потоков
- Тесты создания студента, урока, назначения ДЗ
- Тесты календаря и расписания
- Запуск в CI/CD pipeline

## Документация

### 30. API документация
**Задача:** Создать полную документацию API.

**Инструменты:**
- Flask-RESTX для автоматической генерации Swagger документации
- Sphinx для расширенной документации

**Действия:**
- Автогенерация Swagger UI из docstrings
- Примеры запросов и ответов
- Описание ошибок и кодов ответов
- Версионирование документации

### 31. Техническая документация
**Задача:** Документировать архитектуру и процессы разработки.

**Инструменты:**
- Markdown файлы в репозитории
- Sphinx для генерации HTML документации
- Диаграммы через PlantUML или Mermaid

**Действия:**
- Описание архитектуры системы
- Инструкции по развертыванию
- Руководство для разработчиков
- Диаграммы базы данных и потоков данных

## Приоритизация

### Высокий приоритет (критично для безопасности и стабильности)
1. Аутентификация и авторизация (#1)
2. Защита от SQL-инъекций (#2)
3. Валидация входных данных (#4)
4. Безопасное хранение секретов (#6)
5. Рефакторинг app.py на Blueprints (#8)
6. Автоматические бэкапы (#25)

### Средний приоритет (улучшение производительности и функциональности)
7. Оптимизация запросов к БД (#12)
8. Кэширование (#13)
9. REST API (#16)
10. Статистика и аналитика (#19)
11. Unit тесты (#27)
12. Контейнеризация (#23)

### Низкий приоритет (улучшения и расширения)
13. Миграция на PostgreSQL (#14)
14. Асинхронная обработка задач (#15)
15. Система уведомлений (#18)
16. Мобильная адаптация (#20)
17. CI/CD pipeline (#24)
18. Мониторинг и алертинг (#26)

