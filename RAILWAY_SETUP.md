# Настройка двух окружений в Railway

## Архитектура с использованием Environments

Railway поддерживает **Environments** (окружения) - это более элегантное решение, чем два отдельных проекта!

### Преимущества:
- ✅ Один проект, два окружения
- ✅ Легкая синхронизация конфигурации между окружениями
- ✅ Раздельные базы данных для каждого окружения
- ✅ Изоляция данных в реальном времени
- ✅ Меньше дублирования настроек

## Шаг 1: Создание окружений

### Production (основное окружение):
1. В вашем проекте Railway уже должно быть окружение `production` (по умолчанию)
2. Это ваша основная рабочая версия

### Sandbox (песочница для тестеров):
1. В Railway проекте нажмите на выпадающий список с названием окружения (обычно "production")
2. Выберите "New Environment"
3. В модальном окне:
   - **Environment Name**: `sandbox` или `staging`
   - **Duplicate Environment**: выберите "production"
   - Это скопирует все сервисы, переменные и конфигурацию из production
4. Нажмите "Create Environment"

## Шаг 2: Настройка баз данных

### Для каждого окружения нужна своя БД:

1. **Production окружение:**
   - Убедитесь, что PostgreSQL база подключена
   - `DATABASE_URL` будет автоматически установлен Railway

2. **Sandbox окружение:**
   - Переключитесь на окружение `sandbox`
   - Добавьте новую PostgreSQL базу данных
   - Railway автоматически установит `DATABASE_URL` для этого окружения

## Шаг 3: Настройка переменных окружения

### Production:
- `ENVIRONMENT=production`
- `SECRET_KEY` (уникальный ключ)
- `DATABASE_URL` (автоматически)

### Sandbox:
- `ENVIRONMENT=sandbox`
- `SECRET_KEY` (другой ключ, чем в production)
- `DATABASE_URL` (автоматически, другая БД)

## Шаг 4: Синхронизация данных

### Вариант A: Через скрипт (локально)

1. Получите URL баз данных из Railway:
   - Production: Railway → PostgreSQL → Connect → Public Network URL
   - Sandbox: Railway → PostgreSQL → Connect → Public Network URL

2. Установите переменные окружения:
```bash
export PRODUCTION_DATABASE_URL="postgresql://user:pass@host:port/db"
export SANDBOX_DATABASE_URL="postgresql://user:pass@host:port/db"
```

3. Запустите синхронизацию:
```bash
python scripts/sync_to_sandbox.py
```

### Вариант B: Через Railway CLI

Можно настроить автоматическую синхронизацию через Railway CLI и cron jobs.

## Шаг 5: Разделение доступа (опционально)

Если нужно ограничить доступ тестеров к production:
- Используйте разные домены для каждого окружения
- Настройте авторизацию на уровне приложения
- Используйте переменную `ENVIRONMENT` для условной логики

## Что синхронизируется при копировании окружения

При создании sandbox через "Duplicate Environment":
- ✅ Все сервисы (ваше Flask приложение)
- ✅ Переменные окружения (кроме `DATABASE_URL` - он будет свой)
- ✅ Конфигурация деплоя
- ❌ Данные в базе (каждое окружение имеет свою БД)

## Синхронизация данных между окружениями

Используйте скрипт `scripts/sync_to_sandbox.py` для копирования данных:
- Задания (Tasks)
- Ученики (Students)
- Уроки (Lessons)
- История использования
- Пропущенные/черный список заданий

**НЕ синхронизируются:**
- Логи действий (AuditLog)
- Пользователи (Users) - можно исключить для независимости

## Преимущества этого подхода

1. **Простота управления**: один проект, переключение между окружениями одним кликом
2. **Синхронизация конфигурации**: изменения в коде автоматически применяются к обоим окружениям
3. **Изоляция данных**: каждая БД полностью независима
4. **Экономия**: один проект вместо двух (хотя БД все равно две)
5. **Гибкость**: легко добавить третье окружение (например, `dev`)

## Рекомендации

1. **Регулярная синхронизация**: синхронизируйте данные перед важными тестами
2. **Резервные копии**: настройте автоматические бэкапы для обоих окружений
3. **Мониторинг**: используйте Railway метрики для отслеживания использования
4. **Тестирование**: используйте sandbox для тестирования новых функций перед production

## Переключение между окружениями

В Railway интерфейсе:
- Вверху страницы есть выпадающий список с названием текущего окружения
- Кликните на него и выберите нужное окружение
- Все сервисы и настройки переключатся автоматически

## Использование в коде

В приложении можно различать окружения:
```python
ENVIRONMENT = os.environ.get('ENVIRONMENT', 'local')
if ENVIRONMENT == 'sandbox':
    # Специфичные настройки для sandbox
    # Например, отключить некоторые функции
    pass
```
