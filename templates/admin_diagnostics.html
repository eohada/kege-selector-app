<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è ¬∑ –ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>
<body>
    <div class="app-shell">
        <header class="nav-primary">
            <div class="nav-brand">
                {% if current_user and current_user.is_authenticated %}
                <a href="{{ url_for('auth.user_profile') }}" class="user-profile-avatar {% if current_user.is_creator() %}creator{% endif %}" title="{{ current_user.username }} ({{ current_user.get_role_display() }})">
                    {{ current_user.username[0].upper() }}
                </a>
                {% endif %}
                <a href="{{ url_for('main.index') }}" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; color: inherit;">
                    <div class="brand-mark">LOGO</div>
                    <div class="brand-caption">–ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</div>
                </a>
            </div>
            {% include '_mobile_menu.html' %}
            <nav class="nav-links">
                <a href="{{ url_for('main.dashboard') }}" class="nav-link">
                    <span class="nav-link-content">
                        <img src="{{ url_for('static', filename='icons/students_white-no-bg-preview (carve.photos).png') }}" alt="–£—á–µ–Ω–∏–∫–∏" class="nav-link-icon">
                        <span class="nav-link-label">–£—á–µ–Ω–∏–∫–∏</span>
                    </span>
                </a>
                <a href="{{ url_for('schedule.schedule') }}" class="nav-link">
                    <span class="nav-link-content">
                        <img src="{{ url_for('static', filename='icons/schedule_white.png') }}" alt="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" class="nav-link-icon">
                        <span class="nav-link-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
                    </span>
                </a>
                <a href="{{ url_for('kege_generator.kege_generator') }}" class="nav-link">
                    <span class="nav-link-content">
                        <img src="{{ url_for('static', filename='icons/generator_white-no-bg-preview (carve.photos).png') }}" alt="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä" class="nav-link-icon">
                        <span class="nav-link-label">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</span>
                    </span>
                </a>
                <a href="{{ url_for('main.update_plans') }}" class="nav-link">
                    <span class="nav-link-content">
                        <img src="{{ url_for('static', filename='icons/notes_white-no-bg-preview (carve.photos).png') }}" alt="–ü–ª–∞–Ω—ã" class="nav-link-icon">
                        <span class="nav-link-label">–ü–ª–∞–Ω—ã</span>
                    </span>
                </a>
            </nav>
        </header>

        {% include '_ux_enhancements.html' %}

        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('admin.admin_panel') }}" class="neo-button ghost" style="text-decoration: none;">
                    ‚Üê –ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
                </a>
            </div>
            <p class="hero-eyebrow">–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</p>
            <h1 class="hero-title">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è</h1>
            <p class="hero-subtitle">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É production –∏ sandbox –æ–∫—Ä—É–∂–µ–Ω–∏—è–º–∏</p>
        </section>

        {% if diagnostics_data.errors %}
        <section class="glass-panel" style="margin-bottom: 2rem; border-left: 3px solid var(--danger);">
            <h2 style="color: var(--danger); margin-bottom: 1rem;">‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</h2>
            <ul style="margin: 0; padding-left: 1.5rem;">
                {% for error in diagnostics_data.errors %}
                <li style="color: var(--danger); margin-bottom: 0.5rem;">{{ error }}</li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            <section class="glass-panel">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">ENVIRONMENT</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-1);">{{ diagnostics_data.environment.ENVIRONMENT }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">RAILWAY_ENVIRONMENT</div>
                        <div style="font-size: 1.1em; font-weight: 600;">{{ diagnostics_data.environment.RAILWAY_ENVIRONMENT }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">RAILWAY_SERVICE_NAME</div>
                        <div style="font-size: 1.1em; font-weight: 600;">{{ diagnostics_data.environment.RAILWAY_SERVICE_NAME }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">PORT</div>
                        <div style="font-size: 1.1em; font-weight: 600;">{{ diagnostics_data.environment.PORT }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">PYTHON_VERSION</div>
                        <div style="font-size: 1.1em; font-weight: 600;">{{ diagnostics_data.environment.PYTHON_VERSION }}</div>
                    </div>
                </div>
            </section>

            <section class="glass-panel">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">–¢–∏–ø –ë–î</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-2);">{{ diagnostics_data.database.database_type }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
                        <div>
                            {% if diagnostics_data.database.connection_status == 'OK' %}
                            <span style="color: var(--accent-2); font-weight: 600;">‚úì OK</span>
                            {% else %}
                            <span style="color: var(--danger); font-weight: 600;">‚úó ERROR</span>
                            <div style="font-size: 0.85em; color: var(--danger); margin-top: 0.25rem;">{{ diagnostics_data.database.connection_error }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">DATABASE_URL</div>
                        <div>
                            {% if diagnostics_data.database.DATABASE_URL_set == 'YES' %}
                            <span style="color: var(--accent-2); font-weight: 600;">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 0.25rem; word-break: break-all;">{{ diagnostics_data.database.DATABASE_URL_preview }}</div>
                            {% else %}
                            <span style="color: var(--danger); font-weight: 600;">–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">EXTERNAL_URL</div>
                        <div>
                            {% if diagnostics_data.database.DATABASE_EXTERNAL_URL_set == 'YES' %}
                            <span style="color: var(--accent-1); font-weight: 600;">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 0.25rem; word-break: break-all;">{{ diagnostics_data.database.DATABASE_EXTERNAL_URL_preview }}</div>
                            {% else %}
                            <span style="color: var(--text-muted);">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if diagnostics_data.database.postgres_version %}
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">PostgreSQL –≤–µ—Ä—Å–∏—è</div>
                        <div style="font-size: 0.9em;">{{ diagnostics_data.database.postgres_version }}</div>
                    </div>
                    {% endif %}
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">–¢–∞–±–ª–∏—Ü –≤ –ë–î</div>
                        <div>
                            {% if diagnostics_data.database.tables_count is defined %}
                            <span style="font-size: 1.1em; font-weight: 600; color: var(--accent-1);">{{ diagnostics_data.database.tables_count }}</span>
                            {% else %}
                            <span style="color: var(--danger);">–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            <section class="glass-panel">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">üìä –î–∞–Ω–Ω—ã–µ –≤ –ë–î</h2>
                {% if diagnostics_data.database.data_counts %}
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div style="padding: 1rem; background: var(--surface-2); border-radius: var(--radius-md); border: 1px solid var(--stroke-1);">
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.5rem;">–£—á–µ–Ω–∏–∫–æ–≤</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--accent-1);">{{ diagnostics_data.database.data_counts.students }}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--surface-2); border-radius: var(--radius-md); border: 1px solid var(--stroke-1);">
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.5rem;">–£—Ä–æ–∫–æ–≤</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--accent-1);">{{ diagnostics_data.database.data_counts.lessons }}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--surface-2); border-radius: var(--radius-md); border: 1px solid var(--stroke-1);">
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.5rem;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--accent-1);">{{ diagnostics_data.database.data_counts.users }}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--surface-2); border-radius: var(--radius-md); border: 1px solid var(--stroke-1);">
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.5rem;">–ó–∞–¥–∞–Ω–∏–π</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--accent-1);">{{ diagnostics_data.database.data_counts.tasks }}</div>
                    </div>
                </div>
                {% else %}
                <div style="padding: 1rem; background: rgba(255, 108, 145, 0.12); border-left: 3px solid var(--danger); border-radius: var(--radius-sm); color: var(--danger);">
                    <small>{{ diagnostics_data.database.data_counts_error }}</small>
                </div>
                {% endif %}
            </section>

            <section class="glass-panel">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">‚öôÔ∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">SECRET_KEY</div>
                        <div>
                            {% if diagnostics_data.application.SECRET_KEY_set == 'YES' %}
                            <span style="color: var(--accent-2); font-weight: 600;">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 0.25rem;">–î–ª–∏–Ω–∞: {{ diagnostics_data.application.SECRET_KEY_length }} —Å–∏–º–≤–æ–ª–æ–≤</div>
                            {% else %}
                            <span style="color: var(--danger); font-weight: 600;">–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 0.25rem;">CSRF –∑–∞—â–∏—Ç–∞</div>
                        <div>
                            {% if diagnostics_data.application.flask_config.WTF_CSRF_ENABLED %}
                            <span style="color: var(--accent-2); font-weight: 600;">–í–∫–ª—é—á–µ–Ω–∞</span>
                            {% else %}
                            <span style="color: var(--warning); font-weight: 600;">–í—ã–∫–ª—é—á–µ–Ω–∞</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>
        </div>

        {% if diagnostics_data.database.tables %}
        <section class="glass-panel" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">üìã –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for table in diagnostics_data.database.tables %}
                <span style="padding: 0.5rem 1rem; background: var(--surface-2); border-radius: var(--radius-sm); border: 1px solid var(--stroke-1); font-size: 0.9em;">{{ table }}</span>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <section class="glass-panel" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem; color: var(--text-primary);">üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:</h2>
            <ol style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ <strong>production</strong> –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ</li>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ <strong>sandbox</strong> –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ</li>
                <li>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–∏—è –≤:
                    <ul style="margin-top: 0.5rem;">
                        <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–∞—è –ë–î –≤ sandbox)</li>
                        <li>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è</li>
                        <li>–°—Ç–∞—Ç—É—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</li>
                        <li>–ù–∞–ª–∏—á–∏–∏ —Ç–∞–±–ª–∏—Ü</li>
                    </ul>
                </li>
            </ol>
        </section>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('admin.admin_panel') }}" class="neo-button ghost" style="text-decoration: none;">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</a>
            <button onclick="location.reload()" class="neo-button accent">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <a href="{{ url_for('admin.diagnostics_api') }}" class="neo-button outline" target="_blank" style="text-decoration: none;">üìÑ JSON API</a>
        </div>
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'error' or category == 'danger' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error({{ message|tojson }});
                            }
                        {% elif category == 'warning' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.warning({{ message|tojson }});
                            }
                        {% elif category == 'info' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.info({{ message|tojson }});
                            }
                        {% else %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success({{ message|tojson }});
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>
