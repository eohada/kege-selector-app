{% extends "base.html" %}

{% block title %}–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è</h1>
    <p class="text-muted">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É production –∏ sandbox –æ–∫—Ä—É–∂–µ–Ω–∏—è–º–∏</p>
    
    {% if diagnostics_data.errors %}
    <div class="alert alert-danger">
        <h5>‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</h5>
        <ul>
            {% for error in diagnostics_data.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5>üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>ENVIRONMENT</th>
                            <td><span class="badge bg-info">{{ diagnostics_data.environment.ENVIRONMENT }}</span></td>
                        </tr>
                        <tr>
                            <th>RAILWAY_ENVIRONMENT</th>
                            <td><span class="badge bg-secondary">{{ diagnostics_data.environment.RAILWAY_ENVIRONMENT }}</span></td>
                        </tr>
                        <tr>
                            <th>RAILWAY_SERVICE_NAME</th>
                            <td>{{ diagnostics_data.environment.RAILWAY_SERVICE_NAME }}</td>
                        </tr>
                        <tr>
                            <th>PORT</th>
                            <td>{{ diagnostics_data.environment.PORT }}</td>
                        </tr>
                        <tr>
                            <th>PYTHON_VERSION</th>
                            <td>{{ diagnostics_data.environment.PYTHON_VERSION }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5>üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>–¢–∏–ø –ë–î</th>
                            <td><span class="badge bg-success">{{ diagnostics_data.database.database_type }}</span></td>
                        </tr>
                        <tr>
                            <th>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</th>
                            <td>
                                {% if diagnostics_data.database.connection_status == 'OK' %}
                                <span class="badge bg-success">‚úì OK</span>
                                {% else %}
                                <span class="badge bg-danger">‚úó ERROR</span>
                                <small class="text-danger d-block">{{ diagnostics_data.database.connection_error }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>DATABASE_URL</th>
                            <td>
                                {% if diagnostics_data.database.DATABASE_URL_set == 'YES' %}
                                <span class="badge bg-success">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                <small class="d-block text-muted">{{ diagnostics_data.database.DATABASE_URL_preview }}</small>
                                {% else %}
                                <span class="badge bg-danger">–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>EXTERNAL_URL</th>
                            <td>
                                {% if diagnostics_data.database.DATABASE_EXTERNAL_URL_set == 'YES' %}
                                <span class="badge bg-info">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                <small class="d-block text-muted">{{ diagnostics_data.database.DATABASE_EXTERNAL_URL_preview }}</small>
                                {% else %}
                                <span class="badge bg-secondary">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if diagnostics_data.database.postgres_version %}
                        <tr>
                            <th>PostgreSQL –≤–µ—Ä—Å–∏—è</th>
                            <td><small>{{ diagnostics_data.database.postgres_version }}</small></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>–¢–∞–±–ª–∏—Ü –≤ –ë–î</th>
                            <td>
                                {% if diagnostics_data.database.tables_count is defined %}
                                <span class="badge bg-info">{{ diagnostics_data.database.tables_count }}</span>
                                {% else %}
                                <span class="badge bg-danger">–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5>üìä –î–∞–Ω–Ω—ã–µ –≤ –ë–î</h5>
                </div>
                <div class="card-body">
                    {% if diagnostics_data.database.data_counts %}
                    <table class="table table-sm">
                        <tr>
                            <th>–£—á–µ–Ω–∏–∫–æ–≤</th>
                            <td><span class="badge bg-primary">{{ diagnostics_data.database.data_counts.students }}</span></td>
                        </tr>
                        <tr>
                            <th>–£—Ä–æ–∫–æ–≤</th>
                            <td><span class="badge bg-primary">{{ diagnostics_data.database.data_counts.lessons }}</span></td>
                        </tr>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                            <td><span class="badge bg-primary">{{ diagnostics_data.database.data_counts.users }}</span></td>
                        </tr>
                        <tr>
                            <th>–ó–∞–¥–∞–Ω–∏–π</th>
                            <td><span class="badge bg-primary">{{ diagnostics_data.database.data_counts.tasks }}</span></td>
                        </tr>
                    </table>
                    {% else %}
                    <div class="alert alert-danger">
                        <small>{{ diagnostics_data.database.data_counts_error }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5>‚öôÔ∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>SECRET_KEY</th>
                            <td>
                                {% if diagnostics_data.application.SECRET_KEY_set == 'YES' %}
                                <span class="badge bg-success">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                <small class="d-block text-muted">–î–ª–∏–Ω–∞: {{ diagnostics_data.application.SECRET_KEY_length }} —Å–∏–º–≤–æ–ª–æ–≤</small>
                                {% else %}
                                <span class="badge bg-danger">–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>CSRF –∑–∞—â–∏—Ç–∞</th>
                            <td>
                                {% if diagnostics_data.application.flask_config.WTF_CSRF_ENABLED %}
                                <span class="badge bg-success">–í–∫–ª—é—á–µ–Ω–∞</span>
                                {% else %}
                                <span class="badge bg-warning">–í—ã–∫–ª—é—á–µ–Ω–∞</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    {% if diagnostics_data.database.tables %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5>üìã –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for table in diagnostics_data.database.tables %}
                <div class="col-md-3 mb-2">
                    <span class="badge bg-secondary">{{ table }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="alert alert-info mt-4">
        <h5>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:</h5>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ <strong>production</strong> –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ</li>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ <strong>sandbox</strong> –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ</li>
            <li>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–∏—è –≤:
                <ul>
                    <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–∞—è –ë–î –≤ sandbox)</li>
                    <li>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è</li>
                    <li>–°—Ç–∞—Ç—É—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</li>
                    <li>–ù–∞–ª–∏—á–∏–∏ —Ç–∞–±–ª–∏—Ü</li>
                </ul>
            </li>
        </ol>
    </div>
    
    <div class="mt-3">
        <a href="{{ url_for('admin.admin_panel') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</a>
        <button onclick="location.reload()" class="btn btn-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <a href="{{ url_for('admin.diagnostics_api') }}" class="btn btn-info" target="_blank">üìÑ JSON API</a>
    </div>
</div>
{% endblock %}

