<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - {{ student.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson and active_student %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        üéß –£—Ä–æ–∫ –∏–¥–µ—Ç: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">—Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>–£—á–µ–Ω–∏–∫:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–¢–µ–º–∞:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–î–∞—Ç–∞:</strong> {{ active_lesson.lesson_date.strftime('%d.%m.%Y %H:%M') }}</p>
        <p style="margin: 0;"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ active_lesson.duration }} –º–∏–Ω—É—Ç</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </form>
            <a href="{{ url_for('student_profile', student_id=active_student.student_id) }}" class="neo-button ghost">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
    </script>
    {% endif %}
    
    <header class="nav-primary">
        <div class="nav-brand">
            <a href="{{ url_for('index') }}" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; color: inherit;">
                <div class="brand-mark">LOGO</div>
                <div class="brand-caption">–°–ª–æ—Ç –ø–æ–¥ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –∑–Ω–∞–∫</div>
            </a>
        </div>
        {% include '_mobile_menu.html' %}
        <nav class="nav-links">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/students_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –£—á–µ–Ω–∏–∫–∏" class="nav-link-icon">
                    <span class="nav-link-label">–£—á–µ–Ω–∏–∫–∏</span>
                </span>
            </a>
            <a href="{{ url_for('schedule') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/schedule_white.png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" class="nav-link-icon">
                    <span class="nav-link-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
                </span>
            </a>
            <a href="{{ url_for('kege_generator') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/generator_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä" class="nav-link-icon">
                    <span class="nav-link-label">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</span>
                </span>
            </a>
            <a href="{{ url_for('update_plans') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/notes_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ü–ª–∞–Ω—ã" class="nav-link-icon">
                    <span class="nav-link-label">–ü–ª–∞–Ω—ã</span>
                </span>
            </a>
        </nav>
        <div class="nav-actions">
            <div class="brand-caption icon-slot">
                <img src="{{ url_for('static', filename='icons/schedule_white.png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" class="brand-icon">
            </div>
        </div>
    </header>
    
    <div class="app-shell">
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('student_profile', student_id=student.student_id) }}" class="neo-button ghost" style="text-decoration: none;">
                    ‚Üê –ö –ø—Ä–æ—Ñ–∏–ª—é
                </a>
            </div>
            <p class="hero-eyebrow">—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
            <h1 class="hero-title">üìä {{ student.name }}</h1>
            <p class="hero-subtitle">–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –ø–æ –Ω–æ–º–µ—Ä–∞–º</p>
        </section>
        
        {% if chart_data %}
        <section class="glass-panel">
            <div class="panel-head">
                <div>
                    <p class="eyebrow">–¥–∏–∞–≥—Ä–∞–º–º–∞</p>
                    <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π</h2>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <canvas id="statisticsChart" style="max-height: 500px;"></canvas>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--stroke-1);">
                <h3 style="margin-bottom: 1rem; font-size: 1.1em;">–õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤:</h3>
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                        <span>0-40% (—Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #eab308; border-radius: 4px;"></div>
                        <span>40-80% (—Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 4px;"></div>
                        <span>80-100% (–æ—Ç–ª–∏—á–Ω–æ)</span>
                    </div>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9em;">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å –≤–µ—Å–æ–º √ó2 (–æ–¥–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ = –¥–≤–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö).
                </p>
            </div>
        </section>
        {% else %}
        <section class="glass-panel">
            <div class="empty-state">
                <div style="font-size: 4rem; margin-bottom: 0.6rem;">üìä</div>
                <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
                <p style="color: var(--text-muted);">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>
            </div>
        </section>
        {% endif %}
    </div>
    
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='flash-to-toast.js') }}"></script>
    
    {% if chart_data %}
    <script>
        const chartData = {{ chart_data|tojson }};
        
        const ctx = document.getElementById('statisticsChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(item => '–ó–∞–¥–∞–Ω–∏–µ ' + item.task_number),
                datasets: [{
                    label: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (%)',
                    data: chartData.map(item => item.percent),
                    backgroundColor: chartData.map(item => item.color),
                    borderColor: chartData.map(item => item.color),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                const item = chartData[dataIndex];
                                return `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${item.correct}/${item.total} (${item.percent}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–ù–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è'
                        }
                    }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>

