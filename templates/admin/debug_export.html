{% extends "base.html" %}

{% block title %}–û—Ç–ª–∞–¥–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Markdown{% endblock %}

{% block content %}
<div class="app-shell">
    <header class="nav-primary">
        <nav class="nav-link">
            <a href="{{ url_for('main.dashboard') }}" class="nav-link">–£—á–µ–Ω–∏–∫–∏</a>
            <a href="{{ url_for('admin.admin_panel') }}" class="nav-link active">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
        </nav>
    </header>

    <section class="glass-panel" style="margin: 2rem auto; max-width: 1600px; padding: 2rem;">
        <h1 style="font-size: 2em; margin-bottom: 1.5rem; color: var(--text-primary);">üîß –û—Ç–ª–∞–¥–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Markdown</h1>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í—ã–±–æ—Ä –∑–∞–¥–∞–Ω–∏—è –∏ –∏—Å—Ö–æ–¥–Ω—ã–π HTML -->
            <div>
                <h2 style="font-size: 1.5em; margin-bottom: 1rem; color: var(--text-primary);">–ò—Å—Ö–æ–¥–Ω—ã–π HTML</h2>
                
                <form method="GET" action="{{ url_for('admin.debug_export') }}" style="margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ:</label>
                        <select name="task_id" style="width: 100%; padding: 0.75rem; background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-sm); color: var(--text-primary);">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ --</option>
                            {% for task in tasks_list %}
                            <option value="{{ task.task_id }}" {% if selected_task_id == task.task_id %}selected{% endif %}>
                                –ó–∞–¥–∞–Ω–∏–µ {{ task.task_number }} (ID: {{ task.task_id }}, Site ID: {{ task.site_task_id or 'N/A' }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="neo-button accent" style="width: 100%;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
                </form>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π HTML:</label>
                    <form method="GET" action="{{ url_for('admin.debug_export') }}">
                        <textarea name="custom_html" rows="10" style="width: 100%; padding: 0.75rem; background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-sm); color: var(--text-primary); font-family: monospace; font-size: 0.9em;" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ HTML –∑–¥–µ—Å—å...">{{ original_html }}</textarea>
                        <button type="submit" class="neo-button outline" style="width: 100%; margin-top: 0.5rem;">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HTML</button>
                    </form>
                </div>
                
                {% if original_html %}
                <div style="background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-sm); padding: 1rem; max-height: 500px; overflow-y: auto;">
                    <h3 style="font-size: 1.2em; margin-bottom: 0.5rem; color: var(--text-primary);">–ò—Å—Ö–æ–¥–Ω—ã–π HTML:</h3>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: var(--text-secondary); font-size: 0.85em; margin: 0;">{{ original_html }}</pre>
                </div>
                {% endif %}
                
                {% if task_info %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--surface-2); border-radius: var(--radius-sm);">
                    <p style="margin: 0.25rem 0; color: var(--text-secondary);"><strong>ID –∑–∞–¥–∞–Ω–∏—è:</strong> {{ task_info.task_id }}</p>
                    <p style="margin: 0.25rem 0; color: var(--text-secondary);"><strong>–ù–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è:</strong> {{ task_info.task_number }}</p>
                    <p style="margin: 0.25rem 0; color: var(--text-secondary);"><strong>Site ID:</strong> {{ task_info.site_task_id or 'N/A' }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
            <div>
                <h2 style="font-size: 1.5em; margin-bottom: 1rem; color: var(--text-primary);">–†–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (Markdown)</h2>
                
                {% if exported_markdown %}
                <div style="background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-sm); padding: 1rem; max-height: 500px; overflow-y: auto;">
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: var(--text-primary); font-size: 0.9em; margin: 0; font-family: 'Monaspace Neon', monospace;">{{ exported_markdown }}</pre>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button onclick="copyToClipboard()" class="neo-button outline" style="width: 100%;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Markdown</button>
                </div>
                {% else %}
                <div style="background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-sm); padding: 2rem; text-align: center; color: var(--text-muted);">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ HTML –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞</p>
                </div>
                {% endif %}
            </div>
        </div>
    </section>
</div>

<script>
function copyToClipboard() {
    const markdown = `{{ exported_markdown|replace('`', '\\`')|replace('\n', '\\n')|replace('\r', '\\r') }}`;
    navigator.clipboard.writeText(markdown).then(() => {
        alert('Markdown —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
    });
}
</script>
{% endblock %}

