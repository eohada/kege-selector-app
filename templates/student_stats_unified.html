<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика - {{ student.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        /* Табы */
        .stats-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--stroke-1);
            padding-bottom: 0;
        }
        
        .stats-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-family: var(--font-base);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            top: 1px;
        }
        
        .stats-tab:hover {
            color: var(--text-primary);
        }
        
        .stats-tab.active {
            color: var(--accent-1);
            border-bottom-color: var(--accent-1);
        }
        
        .stats-tab-content {
            display: none;
        }
        
        .stats-tab-content.active {
            display: block;
        }
        
        /* Выравнивание графиков */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: start; /* Выравнивание по верху */
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            height: 400px; /* Фиксированная высота для выравнивания */
        }
        
        .chart-container canvas {
            flex: 1;
            max-height: 100%;
        }
        
        /* Метрики в стиле премиум минимализма */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: var(--surface-2);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            border-color: var(--accent-1);
            transform: translateY(-2px);
        }
        
        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-1);
            line-height: 1.2;
        }
        
        .metric-delta {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        .metric-delta.positive {
            color: #22c55e;
        }
        
        .metric-delta.negative {
            color: #ef4444;
        }
        
        /* Heatmap посещаемости */
        .heatmap-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
            padding: 1rem 0;
        }
        
        .heatmap-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .heatmap-days-header {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
            margin-left: 60px; /* Отступ для меток месяцев */
        }
        
        .heatmap-day-header-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .heatmap-main {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        
        .heatmap-months {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 60px;
        }
        
        .heatmap-month-label {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 600;
            height: 20px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            border-left: 3px solid var(--accent-1);
            margin-bottom: 2px;
        }
        
        .heatmap-month-spacer {
            height: 20px;
        }
        
        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .heatmap-week {
            display: flex;
            gap: 2px;
        }
        
        .heatmap-day {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: var(--surface-3);
            border: 1px solid var(--stroke-1);
            cursor: pointer;
            transition: transform 0.1s ease, border-color 0.1s ease;
        }
        
        .heatmap-day:hover {
            transform: scale(1.3);
            z-index: 10;
            position: relative;
            border-color: var(--accent-1);
        }
        
        .heatmap-day.status-none {
            background: var(--surface-3);
        }
        
        .heatmap-day.status-completed {
            background: rgba(0, 255, 213, 0.7);
        }
        
        .heatmap-day.status-canceled-student {
            background: rgba(239, 68, 68, 0.7);
        }
        
        .heatmap-day.status-canceled-teacher {
            background: rgba(234, 179, 8, 0.7);
        }
        
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--surface-2);
            border-radius: var(--radius-md);
            border: 1px solid var(--stroke-1);
            flex-wrap: wrap;
        }
        
        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .heatmap-legend-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Пунктуальность */
        .punctuality-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .punctuality-item {
            text-align: center;
            padding: 1rem;
            background: var(--surface-2);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-md);
        }
        
        .punctuality-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-1);
        }
        
        .punctuality-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson and active_student %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        <img src="{{ url_for('static', filename='icons/icons8-наушники-100.png') }}" alt="Урок" class="ui-icon ui-icon--sm"> Урок идет: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">текущий урок</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>Ученик:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>Тема:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        <p style="margin: 0 0 0.4rem 0;"><strong>Дата:</strong> {{ active_lesson.lesson_date.strftime('%d.%m.%Y %H:%M') }}</p>
        <p style="margin: 0;"><strong>Длительность:</strong> {{ active_lesson.duration }} минут</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lessons.lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent"><img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Завершить" class="ui-icon ui-icon--sm">Завершить</button>
            </form>
            <a href="{{ url_for('students.student_profile', student_id=active_student.student_id) }}" class="neo-button ghost"><img src="{{ url_for('static', filename='icons/icons8-пользователь-100.png') }}" alt="Профиль" class="ui-icon ui-icon--sm">Профиль</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
    </script>
    {% endif %}
    
    <div class="app-shell">
        {% set active_page = 'dashboard' %}
        {% include '_primary_nav.html' %}
        
        <!-- Заголовок страницы -->
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('students.student_profile', student_id=student.student_id) }}" class="neo-button ghost" style="text-decoration: none;">
                    ← К профилю
                </a>
            </div>
            <p class="hero-eyebrow">статистика и аналитика</p>
            <h1 class="hero-title"><img src="{{ url_for('static', filename='icons/icons8-bar-chart-100.png') }}" alt="Статистика" class="ui-icon ui-icon--md"> {{ student.name }}</h1>
        </section>
        
        <!-- Табы -->
        <div class="stats-tabs">
            <button class="stats-tab active" onclick="switchTab('skills')">Навыки</button>
            <button class="stats-tab" onclick="switchTab('discipline')">Дисциплина</button>
        </div>
        
        <!-- Вкладка: Навыки -->
        <div id="tab-skills" class="stats-tab-content active">
            <!-- Метрики -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Процент выполнения работ</div>
                    <div class="metric-value">{{ metrics.current_gpa }}%</div>
                    {% if metrics.delta != 0 %}
                    <div class="metric-delta {% if metrics.delta > 0 %}positive{% else %}negative{% endif %}">
                        {% if metrics.delta > 0 %}+{% endif %}{{ metrics.delta }}% за месяц
                    </div>
                    {% endif %}
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">GPA по ДЗ</div>
                    <div class="metric-value">{{ gpa_by_type.homework }}%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">GPA по контрольным</div>
                    <div class="metric-value">{{ gpa_by_type.exam }}%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Проведено уроков</div>
                    <div class="metric-value">{{ metrics.completed_lessons }}</div>
                    <div class="metric-delta">из {{ metrics.total_lessons }}</div>
                </div>
            </div>
            
            <!-- Графики -->
            <div class="charts-grid">
                <!-- График динамики GPA -->
                <section class="glass-panel">
                    <div class="panel-head">
                        <div>
                            <p class="eyebrow">динамика успеваемости</p>
                            <h2>Изменение процента выполнения</h2>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </section>
                
                <!-- График навыков (радар) -->
                <section class="glass-panel">
                    <div class="panel-head">
                        <div>
                            <p class="eyebrow">карта навыков</p>
                            <h2>Уровень владения темами</h2>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="skillsChart"></canvas>
                    </div>
                </section>
            </div>
            
            <!-- Статистика по заданиям -->
            {% if chart_data %}
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">выполнение заданий</p>
                        <h2>Процент выполнения по номерам</h2>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">
                    Показаны только задания, по которым есть выполненные работы (всего: {{ chart_data|length }})
                </p>
                <div style="margin-top: 2rem;">
                    <canvas id="statisticsChart" style="max-height: 400px;"></canvas>
                </div>
            </section>
            
            <!-- Редактор статистики -->
            {% if can_edit %}
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">ручное редактирование</p>
                        <h2>Изменить статистику</h2>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" id="resetAllStats" class="neo-button" style="font-size: 0.85em; padding: 0.5rem 1rem;">
                            Сбросить все
                        </button>
                    </div>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9em;">
                    Гибкая система редактирования статистики. Выберите режим редактирования и введите значения для каждого задания.
                </p>
                
                <!-- Глобальный выбор режима редактирования и массовое редактирование -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Режим редактирования -->
                        <div>
                            <label style="display: block; font-size: 0.9em; margin-bottom: 0.75rem; color: var(--text-muted); font-weight: 500;">
                                Режим редактирования:
                            </label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="editMode" value="add" checked style="cursor: pointer;">
                                    <span>Добавить</span>
                                    <small style="color: var(--text-muted); font-size: 0.85em;">(прибавить к текущему)</small>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="editMode" value="set" style="cursor: pointer;">
                                    <span>Установить</span>
                                    <small style="color: var(--text-muted); font-size: 0.85em;">(абсолютное значение)</small>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="editMode" value="subtract" style="cursor: pointer;">
                                    <span>Вычесть</span>
                                    <small style="color: var(--text-muted); font-size: 0.85em;">(отнять от текущего)</small>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Массовое редактирование -->
                        <div>
                            <label style="display: block; font-size: 0.9em; margin-bottom: 0.75rem; color: var(--text-muted); font-weight: 500;">
                                Массовое редактирование:
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                                <div>
                                    <label style="display: block; font-size: 0.85em; margin-bottom: 0.25rem; color: var(--text-muted);">
                                        Правильно:
                                    </label>
                                    <input type="number" 
                                           min="0" 
                                           step="1"
                                           id="bulkCorrect" 
                                           class="neo-input" 
                                           value="0"
                                           placeholder="0"
                                           style="width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85em; margin-bottom: 0.25rem; color: var(--text-muted);">
                                        Неправильно:
                                    </label>
                                    <input type="number" 
                                           min="0" 
                                           step="1"
                                           id="bulkIncorrect" 
                                           class="neo-input" 
                                           value="0"
                                           placeholder="0"
                                           style="width: 100%;">
                                </div>
                                <div>
                                    <button type="button" 
                                            id="bulkApplyBtn" 
                                            class="neo-button accent"
                                            style="white-space: nowrap;">
                                        Применить ко всем
                                    </button>
                                </div>
                            </div>
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85em;">
                                Значения будут применены ко всем заданиям с выбранным режимом
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Форма добавления нового задания -->
                <div style="margin-top: 2rem; padding: 1rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1); border-style: dashed;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-muted); font-weight: 500;">
                                Добавить новое задание:
                            </label>
                            <input type="number" 
                                   min="1" 
                                   max="27" 
                                   step="1"
                                   id="newTaskNumber" 
                                   class="neo-input" 
                                   placeholder="Номер задания (1-27)"
                                   style="width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-muted); font-weight: 500;">
                                Правильно:
                            </label>
                            <input type="number" 
                                   min="0" 
                                   step="1"
                                   id="newTaskCorrect" 
                                   class="neo-input" 
                                   value="0"
                                   placeholder="0"
                                   style="width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-muted); font-weight: 500;">
                                Неправильно:
                            </label>
                            <input type="number" 
                                   min="0" 
                                   step="1"
                                   id="newTaskIncorrect" 
                                   class="neo-input" 
                                   value="0"
                                   placeholder="0"
                                   style="width: 100%;">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button type="button" 
                                    id="addNewTaskBtn" 
                                    class="neo-button accent"
                                    style="white-space: nowrap;">
                                <img src="{{ url_for('static', filename='icons/icons8-плюс-100.png') }}" alt="Добавить" class="ui-icon ui-icon--sm" style="width: 16px; height: 16px; vertical-align: middle;"> Добавить задание
                            </button>
                        </div>
                    </div>
                    <small style="display: block; margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85em;">
                        Добавьте статистику для задания, которого еще нет в списке. После добавления оно появится в списке ниже, и к нему будут добавляться результаты автопроверки.
                    </small>
                </div>
                
                <div style="margin-top: 2rem;">
                    <div id="statisticsEditor" style="display: grid; gap: 1rem;">
                        {% for item in chart_data %}
                        <div class="stat-edit-item" data-task-number="{{ item.task_number }}" style="padding: 1.25rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1);">
                            <!-- Заголовок с информацией -->
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--stroke-1);">
                                <div>
                                    <strong style="font-size: 1.1em;">Задание {{ item.task_number }}</strong>
                                    <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 0.5rem;">
                                        <div>Итого: <strong>{{ item.correct }}/{{ item.total }}</strong> ({{ item.percent }}%)</div>
                                        <div style="margin-top: 0.25rem;">
                                            Авто: {{ item.auto_correct }}/{{ item.auto_total }}
                                            {% if item.manual_correct > 0 or item.manual_incorrect > 0 %}
                                            | Ручное: +{{ item.manual_correct }}/-{{ item.manual_incorrect }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% if item.manual_correct > 0 or item.manual_incorrect > 0 %}
                                <button type="button" 
                                        class="stat-reset-btn neo-button" 
                                        data-task-number="{{ item.task_number }}"
                                        style="font-size: 0.85em; padding: 0.4rem 0.8rem;"
                                        title="Сбросить ручные изменения">
                                    Сбросить
                                </button>
                                {% endif %}
                            </div>
                            
                            <!-- Поля редактирования -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-muted); font-weight: 500;">
                                        <img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Правильно" class="ui-icon ui-icon--sm" style="width: 16px; height: 16px; vertical-align: middle;"> Правильно:
                                    </label>
                                    <input type="number" 
                                           min="0" 
                                           step="1"
                                           class="stat-input-correct neo-input" 
                                           value="0"
                                           placeholder="0"
                                           style="width: 100%;">
                                    {% if item.manual_correct > 0 %}
                                    <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85em;">
                                        Текущее ручное значение: {{ item.manual_correct }}
                                    </small>
                                    {% endif %}
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-muted); font-weight: 500;">
                                        <img src="{{ url_for('static', filename='icons/icons8-умножение-96.png') }}" alt="Неправильно" class="ui-icon ui-icon--sm" style="width: 16px; height: 16px; vertical-align: middle;"> Неправильно:
                                    </label>
                                    <input type="number" 
                                           min="0" 
                                           step="1"
                                           class="stat-input-incorrect neo-input" 
                                           value="0"
                                           placeholder="0"
                                           style="width: 100%;">
                                    {% if item.manual_incorrect > 0 %}
                                    <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85em;">
                                        Текущее ручное значение: {{ item.manual_incorrect }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Кнопка сохранения -->
                            <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
                                <button type="button" 
                                        class="neo-button accent stat-save-btn" 
                                        data-task-number="{{ item.task_number }}">
                                    <img src="{{ url_for('static', filename='icons/icons8-сохранить-100.png') }}" alt="Сохранить" class="ui-icon ui-icon--sm" style="width: 16px; height: 16px; vertical-align: middle;"> Сохранить
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% else %}
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">выполнение заданий</p>
                        <h2>Процент выполнения по номерам</h2>
                    </div>
                </div>
                <p style="color: var(--text-muted); text-align: center; padding: 2rem;">
                    Нет данных для отображения. Выполните задания, чтобы увидеть статистику.
                </p>
            </section>
            {% endif %}
            
            <!-- Проблемные темы -->
            {% if problem_topics %}
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">требует внимания</p>
                        <h2>Проблемные темы</h2>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <div style="display: grid; gap: 1rem;">
                        {% for topic in problem_topics %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1);">
                            <div>
                                <span style="font-weight: 500;">{{ topic.name }}</span>
                                <span style="color: var(--text-muted); margin-left: 1rem;">{{ topic.avg_score }}%</span>
                            </div>
                            <a href="{{ url_for('kege_generator.kege_generator') }}?student_id={{ student.student_id }}" class="neo-button accent" style="text-decoration: none;">
                                Создать отработку
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}
        </div>
        
        <!-- Вкладка: Дисциплина -->
        <div id="tab-discipline" class="stats-tab-content">
            <!-- Метрики дисциплины -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Rate выполнения ДЗ</div>
                    <div class="metric-value">{{ metrics.hw_submit_rate }}%</div>
                    <div class="metric-delta">{{ punctuality.total }} заданий</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Проведено</div>
                    <div class="metric-value">{{ metrics.completed_lessons }}</div>
                    <div class="metric-delta">из {{ metrics.total_lessons }}</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Пропущено</div>
                    <div class="metric-value">{{ metrics.missed_lessons }}</div>
                </div>
            </div>
            
            <!-- Heatmap посещаемости -->
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">посещаемость</p>
                        <h2>Календарь активности</h2>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                    Статусы уроков по дням за последний год. Наведите курсор на день для подробностей.
                </p>
                <div class="heatmap-wrapper">
                    <div class="heatmap-container">
                        <!-- Заголовок дней недели -->
                        <div class="heatmap-days-header">
                            <div class="heatmap-day-header-label">Пн</div>
                            <div class="heatmap-day-header-label">Вт</div>
                            <div class="heatmap-day-header-label">Ср</div>
                            <div class="heatmap-day-header-label">Чт</div>
                            <div class="heatmap-day-header-label">Пт</div>
                            <div class="heatmap-day-header-label">Сб</div>
                            <div class="heatmap-day-header-label">Вс</div>
                        </div>
                        <!-- Основная часть с месяцами и сеткой -->
                        <div class="heatmap-main">
                            <div id="heatmapMonths" class="heatmap-months"></div>
                            <div id="attendanceHeatmap" class="heatmap-grid"></div>
                        </div>
                    </div>
                </div>
                <div class="heatmap-legend">
                    <div class="heatmap-legend-item">
                        <span class="heatmap-legend-label">Статусы уроков:</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-day status-completed"></div>
                        <span>Проведен</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-day status-canceled-teacher"></div>
                        <span>Отменен учителем</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-day status-canceled-student"></div>
                        <span>Отменен учеником</span>
                    </div>
                </div>
            </section>
            
            <!-- График посещаемости (pie) -->
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">статусы уроков</p>
                        <h2>Распределение посещаемости</h2>
                    </div>
                </div>
                <div style="margin-top: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <canvas id="attendanceChart" style="max-height: 300px;"></canvas>
                </div>
            </section>
            
            <!-- Пунктуальность сдачи -->
            <section class="glass-panel" style="margin-bottom: 2rem;">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">пунктуальность</p>
                        <h2>Время сдачи ДЗ</h2>
                    </div>
                </div>
                <div class="punctuality-stats">
                    <div class="punctuality-item">
                        <div class="punctuality-value">{{ punctuality.early }}</div>
                        <div class="punctuality-label">Сдано заранее</div>
                    </div>
                    <div class="punctuality-item">
                        <div class="punctuality-value">{{ punctuality.on_time }}</div>
                        <div class="punctuality-label">Вовремя</div>
                    </div>
                    <div class="punctuality-item">
                        <div class="punctuality-value">{{ punctuality.late }}</div>
                        <div class="punctuality-label">С опозданием</div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        // Переключение табов
        function switchTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.stats-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Убираем активный класс у всех табов
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Активируем соответствующий таб
            event.target.classList.add('active');
        }
        
        // Инициализация графиков
        document.addEventListener("DOMContentLoaded", function() {
            const accent1 = getComputedStyle(document.documentElement).getPropertyValue('--accent-1').trim();
            const textPrimary = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
            const textMuted = getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim();
            const stroke1 = getComputedStyle(document.documentElement).getPropertyValue('--stroke-1').trim();
            
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
            
            const accentRgb = hexToRgb(accent1);
            const accentRgba = accentRgb ? `rgba(${accentRgb.r}, ${accentRgb.g}, ${accentRgb.b}, 0.25)` : 'rgba(0, 255, 213, 0.25)';
            
            // График динамики GPA
            const ctxTrend = document.getElementById('trendChart');
            if (ctxTrend) {
                new Chart(ctxTrend.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: {{ charts.trend_dates | safe }},
                        datasets: [{
                            label: 'Процент выполнения (%)',
                            data: {{ charts.trend_scores | safe }},
                            borderColor: accent1,
                            backgroundColor: accentRgba,
                            tension: 0.4,
                            fill: {
                                target: 'origin',
                                above: accentRgba
                            },
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: accent1,
                            pointBorderColor: textPrimary,
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { 
                                    color: textPrimary,
                                    padding: 15,
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: textMuted,
                                    padding: 8,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { 
                                    color: stroke1,
                                    drawBorder: false
                                }
                            },
                            x: {
                                ticks: { 
                                    color: textMuted,
                                    padding: 8
                                },
                                grid: { 
                                    color: stroke1,
                                    drawBorder: false
                                }
                            }
                        }
                    }
                });
            }
            
            // График навыков (Radar)
            const ctxSkills = document.getElementById('skillsChart');
            if (ctxSkills && {{ charts.skill_labels | safe }}.length > 0) {
                new Chart(ctxSkills.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: {{ charts.skill_labels | safe }},
                        datasets: [{
                            label: 'Уровень владения',
                            data: {{ charts.skill_values | safe }},
                            backgroundColor: accentRgba,
                            borderColor: accent1,
                            borderWidth: 3,
                            pointBackgroundColor: accent1,
                            pointBorderColor: textPrimary,
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { top: 20, bottom: 20, left: 20, right: 20 }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                min: 0,
                                max: 100,
                                ticks: {
                                    stepSize: 20,
                                    color: textMuted,
                                    font: { size: 11, family: 'MonaspaceNeon, monospace' },
                                    backdropColor: 'transparent',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: stroke1, lineWidth: 1 },
                                angleLines: { color: stroke1, lineWidth: 1 },
                                pointLabels: {
                                    color: textPrimary,
                                    font: { size: 10, family: 'MonaspaceNeon, monospace', weight: '500' },
                                    padding: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: textPrimary }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(8, 10, 18, 0.95)',
                                titleColor: accent1,
                                bodyColor: textPrimary,
                                borderColor: accent1,
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.r + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // График статистики по заданиям
            const ctxStats = document.getElementById('statisticsChart');
            if (ctxStats && {{ chart_data | tojson | safe }}.length > 0) {
                const statsData = {{ chart_data | tojson | safe }};
                new Chart(ctxStats.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: statsData.map(d => '№' + d.task_number),
                        datasets: [{
                            label: 'Процент выполнения',
                            data: statsData.map(d => d.percent),
                            backgroundColor: statsData.map(d => d.color),
                            borderColor: statsData.map(d => d.color),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const data = statsData[context.dataIndex];
                                        return `Выполнено: ${data.correct}/${data.total} (${data.percent}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: textMuted,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: stroke1 }
                            },
                            x: {
                                ticks: { color: textMuted },
                                grid: { color: stroke1 }
                            }
                        }
                    }
                });
            }
            
            // График посещаемости (Pie)
            const ctxAttendance = document.getElementById('attendanceChart');
            if (ctxAttendance && {{ charts.attendance_labels | safe }}.length > 0) {
                new Chart(ctxAttendance.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: {{ charts.attendance_labels | safe }},
                        datasets: [{
                            data: {{ charts.attendance_values | safe }},
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(234, 179, 8, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(147, 51, 234, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(168, 85, 247, 0.8)'
                            ],
                            borderColor: [
                                'rgb(34, 197, 94)',
                                'rgb(234, 179, 8)',
                                'rgb(239, 68, 68)',
                                'rgb(147, 51, 234)',
                                'rgb(59, 130, 246)',
                                'rgb(168, 85, 247)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: { color: textPrimary }
                            }
                        }
                    }
                });
            }
            
            // Heatmap посещаемости
            const heatmapContainer = document.getElementById('attendanceHeatmap');
            const heatmapMonthsContainer = document.getElementById('heatmapMonths');
            if (heatmapContainer && heatmapMonthsContainer) {
                const dates = {{ charts.heatmap_dates | safe }};
                const statuses = {{ charts.heatmap_statuses | safe }};
                
                // Функция форматирования даты
                function formatDate(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                }
                
                // Группируем по неделям (7 дней), начиная с понедельника
                const weeks = [];
                let currentWeek = [];
                
                // Находим первый понедельник
                let firstMondayIdx = 0;
                for (let i = 0; i < dates.length; i++) {
                    const dateObj = new Date(dates[i]);
                    const dayOfWeek = dateObj.getDay(); // 0 = воскресенье, 1 = понедельник
                    if (dayOfWeek === 1) { // Понедельник
                        firstMondayIdx = i;
                        break;
                    }
                }
                
                // Заполняем первую неделю до понедельника пустыми днями
                for (let i = 0; i < firstMondayIdx; i++) {
                    currentWeek.push(null);
                }
                
                // Группируем остальные дни по неделям
                for (let i = firstMondayIdx; i < dates.length; i++) {
                    const date = dates[i];
                    const status = statuses[i];
                    const dateObj = new Date(date);
                    const dayOfWeek = dateObj.getDay();
                    
                    currentWeek.push({
                        date: date,
                        status: status,
                        dayOfWeek: dayOfWeek
                    });
                    
                    // Если неделя заполнена (7 дней) или это последний день
                    if (currentWeek.length === 7 || i === dates.length - 1) {
                        // Дополняем последнюю неделю пустыми днями если нужно
                        while (currentWeek.length < 7) {
                            currentWeek.push(null);
                        }
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                }
                
                // Определяем месяцы для подписей (группируем недели по месяцам)
                const monthLabels = [];
                let currentMonth = '';
                let currentMonthWeeks = 0;
                
                weeks.forEach((week, weekIdx) => {
                    const firstDay = week.find(d => d !== null);
                    if (firstDay) {
                        const date = new Date(firstDay.date);
                        const month = date.toLocaleDateString('ru-RU', { month: 'short' });
                        
                        if (month !== currentMonth) {
                            // Если сменился месяц, добавляем метку для предыдущего месяца
                            if (currentMonth && currentMonthWeeks > 0) {
                                monthLabels.push({ 
                                    weekIdx: weekIdx - currentMonthWeeks, 
                                    month: currentMonth,
                                    weeks: currentMonthWeeks
                                });
                            }
                            currentMonth = month;
                            currentMonthWeeks = 1;
                        } else {
                            currentMonthWeeks++;
                        }
                    }
                });
                
                // Добавляем последний месяц
                if (currentMonth && currentMonthWeeks > 0) {
                    monthLabels.push({ 
                        weekIdx: weeks.length - currentMonthWeeks, 
                        month: currentMonth,
                        weeks: currentMonthWeeks
                    });
                }
                
                // Создаем heatmap
                weeks.forEach((week, weekIdx) => {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = 'heatmap-week';
                    
                    // Заполняем неделю (7 дней)
                    for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                        const day = week[dayIdx];
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'heatmap-day';
                        
                        if (day && day.status) {
                            if (day.status === 'completed') {
                                dayDiv.classList.add('status-completed');
                            } else if (day.status === 'canceled_student') {
                                dayDiv.classList.add('status-canceled-student');
                            } else if (day.status === 'canceled_teacher') {
                                dayDiv.classList.add('status-canceled-teacher');
                            } else {
                                dayDiv.classList.add('status-none');
                            }
                            
                            // Форматируем подсказку
                            const dateFormatted = formatDate(day.date);
                            let tooltipText = `${dateFormatted}`;
                            if (day.status === 'completed') {
                                tooltipText += `\nПроведен`;
                            } else if (day.status === 'canceled_student') {
                                tooltipText += `\nОтменен учеником`;
                            } else if (day.status === 'canceled_teacher') {
                                tooltipText += `\nОтменен учителем`;
                            }
                            dayDiv.title = tooltipText;
                        } else {
                            dayDiv.classList.add('status-none');
                        }
                        
                        weekDiv.appendChild(dayDiv);
                    }
                    
                    heatmapContainer.appendChild(weekDiv);
                });
                
                // Добавляем подписи месяцев с правильным распределением
                let currentWeekIdx = 0;
                monthLabels.forEach(({ weekIdx, month, weeks: monthWeeks }) => {
                    // Добавляем отступы до нужной недели
                    while (currentWeekIdx < weekIdx) {
                        const spacer = document.createElement('div');
                        spacer.className = 'heatmap-month-spacer';
                        heatmapMonthsContainer.appendChild(spacer);
                        currentWeekIdx++;
                    }
                    
                    // Добавляем метку месяца
                    const monthLabel = document.createElement('div');
                    monthLabel.className = 'heatmap-month-label';
                    monthLabel.textContent = month;
                    monthLabel.style.height = (monthWeeks * 22) + 'px'; // 20px высота недели + 2px gap
                    heatmapMonthsContainer.appendChild(monthLabel);
                    currentWeekIdx += monthWeeks;
                });
                
                // Добавляем отступы до конца если нужно
                while (currentWeekIdx < weeks.length) {
                    const spacer = document.createElement('div');
                    spacer.className = 'heatmap-month-spacer';
                    heatmapMonthsContainer.appendChild(spacer);
                    currentWeekIdx++;
                }
            }
        });
        
        // Обработка сохранения статистики
        document.addEventListener('DOMContentLoaded', function() {
            const saveButtons = document.querySelectorAll('.stat-save-btn');
            const resetButtons = document.querySelectorAll('.stat-reset-btn');
            const resetAllBtn = document.getElementById('resetAllStats');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            if (!csrfToken) {
                console.warn('CSRF токен не найден');
            }
            
            // Функция для временного уведомления
            function showTemporaryNotification(message, type) {
                if (typeof toast !== 'undefined' && toast && typeof toast.show === 'function') {
                    toast.show(message, type);
                    return;
                }
                if (window.toast && typeof window.toast.show === 'function') {
                    window.toast.show(message, type);
                    return;
                }
                
                // Fallback: создаем уведомление вручную
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    background: ${type === 'success' ? '#22c55e' : '#ef4444'};
                    color: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            // Функция для получения выбранного режима редактирования
            function getEditMode() {
                const selectedMode = document.querySelector('input[name="editMode"]:checked');
                return selectedMode ? selectedMode.value : 'add';
            }
            
            // Функция для обновления плейсхолдеров в зависимости от режима
            function updatePlaceholders() {
                const mode = getEditMode();
                const items = document.querySelectorAll('.stat-edit-item');
                items.forEach(item => {
                    const correctInput = item.querySelector('.stat-input-correct');
                    const incorrectInput = item.querySelector('.stat-input-incorrect');
                    
                    if (mode === 'add') {
                        correctInput.placeholder = 'Добавить';
                        incorrectInput.placeholder = 'Добавить';
                    } else if (mode === 'set') {
                        correctInput.placeholder = 'Установить значение';
                        incorrectInput.placeholder = 'Установить значение';
                    } else if (mode === 'subtract') {
                        correctInput.placeholder = 'Вычесть';
                        incorrectInput.placeholder = 'Вычесть';
                    }
                });
            }
            
            // Обновляем плейсхолдеры при изменении режима
            document.querySelectorAll('input[name="editMode"]').forEach(radio => {
                radio.addEventListener('change', updatePlaceholders);
            });
            
            // Обработка сохранения статистики
            saveButtons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const taskNumber = parseInt(this.dataset.taskNumber);
                    const item = this.closest('.stat-edit-item');
                    const correctInput = item.querySelector('.stat-input-correct');
                    const incorrectInput = item.querySelector('.stat-input-incorrect');
                    
                    const manualCorrect = parseInt(correctInput.value) || 0;
                    const manualIncorrect = parseInt(incorrectInput.value) || 0;
                    const editMode = getEditMode();
                    
                    // Валидация для режимов add и subtract
                    if (editMode !== 'set' && (manualCorrect < 0 || manualIncorrect < 0)) {
                        showTemporaryNotification('Значения должны быть неотрицательными', 'error');
                        return;
                    }
                    
                    // Показываем индикатор загрузки
                    const originalText = this.innerHTML;
                    this.innerHTML = '⏳ Сохранение...';
                    this.disabled = true;
                    
                    try {
                        const url = `{{ url_for('students.update_statistics', student_id=student.student_id) }}`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({
                                task_number: taskNumber,
                                mode: editMode,
                                manual_correct: manualCorrect,
                                manual_incorrect: manualIncorrect
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data && data.success) {
                            showTemporaryNotification('Статистика успешно обновлена', 'success');
                            // Очищаем поля ввода
                            correctInput.value = '0';
                            incorrectInput.value = '0';
                            // Перезагружаем страницу с принудительным обновлением кеша
                            setTimeout(() => {
                                const url = new URL(window.location.href);
                                url.searchParams.set('_t', Date.now());
                                window.location.href = url.toString();
                            }, 1000);
                        } else {
                            const errorMsg = data?.error || 'Ошибка при сохранении';
                            showTemporaryNotification(errorMsg, 'error');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('Ошибка при сохранении статистики:', error);
                        showTemporaryNotification('Ошибка при сохранении: ' + error.message, 'error');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                });
            });
            
            // Обработка сброса для отдельного задания
            resetButtons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const taskNumber = parseInt(this.dataset.taskNumber);
                    
                    if (!confirm(`Вы уверены, что хотите сбросить ручные изменения для задания ${taskNumber}?`)) {
                        return;
                    }
                    
                    const originalText = this.innerHTML;
                    this.innerHTML = '⏳ Сброс...';
                    this.disabled = true;
                    
                    try {
                        const url = `{{ url_for('students.reset_statistics', student_id=student.student_id) }}`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({
                                task_number: taskNumber
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data && data.success) {
                            showTemporaryNotification('Ручные изменения сброшены', 'success');
                            setTimeout(() => {
                                const url = new URL(window.location.href);
                                url.searchParams.set('_t', Date.now());
                                window.location.href = url.toString();
                            }, 1000);
                        } else {
                            const errorMsg = data?.error || 'Ошибка при сбросе';
                            showTemporaryNotification(errorMsg, 'error');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('Ошибка при сбросе статистики:', error);
                        showTemporaryNotification('Ошибка при сбросе: ' + error.message, 'error');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                });
            });
            
            // Обработка добавления нового задания
            const addNewTaskBtn = document.getElementById('addNewTaskBtn');
            if (addNewTaskBtn) {
                addNewTaskBtn.addEventListener('click', async function() {
                    const taskNumberInput = document.getElementById('newTaskNumber');
                    const correctInput = document.getElementById('newTaskCorrect');
                    const incorrectInput = document.getElementById('newTaskIncorrect');
                    
                    const taskNumber = parseInt(taskNumberInput.value);
                    const manualCorrect = parseInt(correctInput.value) || 0;
                    const manualIncorrect = parseInt(incorrectInput.value) || 0;
                    
                    // Валидация
                    if (!taskNumber || taskNumber < 1 || taskNumber > 27) {
                        showTemporaryNotification('Введите корректный номер задания (1-27)', 'error');
                        taskNumberInput.focus();
                        return;
                    }
                    
                    if (manualCorrect < 0 || manualIncorrect < 0) {
                        showTemporaryNotification('Значения должны быть неотрицательными', 'error');
                        return;
                    }
                    
                    // Проверяем, не существует ли уже это задание в списке
                    const existingItem = document.querySelector(`.stat-edit-item[data-task-number="${taskNumber}"]`);
                    if (existingItem) {
                        showTemporaryNotification(`Задание ${taskNumber} уже есть в списке. Используйте редактирование выше.`, 'error');
                        taskNumberInput.focus();
                        return;
                    }
                    
                    // Показываем индикатор загрузки
                    const originalText = this.innerHTML;
                    this.innerHTML = '⏳ Добавление...';
                    this.disabled = true;
                    
                    try {
                        const url = `{{ url_for('students.update_statistics', student_id=student.student_id) }}`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({
                                task_number: taskNumber,
                                mode: 'set', // Устанавливаем абсолютное значение для нового задания
                                manual_correct: manualCorrect,
                                manual_incorrect: manualIncorrect
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data && data.success) {
                            showTemporaryNotification(`Задание ${taskNumber} успешно добавлено`, 'success');
                            // Очищаем поля ввода
                            taskNumberInput.value = '';
                            correctInput.value = '0';
                            incorrectInput.value = '0';
                            // Перезагружаем страницу с принудительным обновлением кеша
                            setTimeout(() => {
                                const url = new URL(window.location.href);
                                url.searchParams.set('_t', Date.now());
                                window.location.href = url.toString();
                            }, 1000);
                        } else {
                            const errorMsg = data?.error || 'Ошибка при добавлении задания';
                            showTemporaryNotification(errorMsg, 'error');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('Ошибка при добавлении задания:', error);
                        showTemporaryNotification('Ошибка при добавлении: ' + error.message, 'error');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                });
                
                // Разрешаем добавление по Enter в поле номера задания
                const taskNumberInput = document.getElementById('newTaskNumber');
                if (taskNumberInput) {
                    taskNumberInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addNewTaskBtn.click();
                        }
                    });
                }
            }
            
            // Обработка массового редактирования
            const bulkApplyBtn = document.getElementById('bulkApplyBtn');
            if (bulkApplyBtn) {
                bulkApplyBtn.addEventListener('click', async function() {
                    const bulkCorrect = parseInt(document.getElementById('bulkCorrect').value) || 0;
                    const bulkIncorrect = parseInt(document.getElementById('bulkIncorrect').value) || 0;
                    const editMode = getEditMode();
                    
                    if (bulkCorrect === 0 && bulkIncorrect === 0) {
                        showTemporaryNotification('Введите значения для массового редактирования', 'error');
                        return;
                    }
                    
                    if (editMode !== 'set' && (bulkCorrect < 0 || bulkIncorrect < 0)) {
                        showTemporaryNotification('Значения должны быть неотрицательными', 'error');
                        return;
                    }
                    
                    if (!confirm(`Применить значения (${bulkCorrect} правильно, ${bulkIncorrect} неправильно) ко всем заданиям в режиме "${editMode === 'add' ? 'Добавить' : editMode === 'set' ? 'Установить' : 'Вычесть'}"?`)) {
                        return;
                    }
                    
                    const originalText = this.innerHTML;
                    this.innerHTML = '⏳ Применение...';
                    this.disabled = true;
                    
                    const items = document.querySelectorAll('.stat-edit-item');
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const item of items) {
                        const taskNumber = parseInt(item.dataset.taskNumber);
                        
                        try {
                            const url = `{{ url_for('students.update_statistics', student_id=student.student_id) }}`;
                            
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken || ''
                                },
                                body: JSON.stringify({
                                    task_number: taskNumber,
                                    mode: editMode,
                                    manual_correct: bulkCorrect,
                                    manual_incorrect: bulkIncorrect
                                })
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data && data.success) {
                                    successCount++;
                                } else {
                                    errorCount++;
                                }
                            } else {
                                errorCount++;
                            }
                        } catch (error) {
                            console.error(`Ошибка при обновлении задания ${taskNumber}:`, error);
                            errorCount++;
                        }
                    }
                    
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    // Очищаем поля массового редактирования
                    document.getElementById('bulkCorrect').value = '0';
                    document.getElementById('bulkIncorrect').value = '0';
                    
                    if (errorCount === 0) {
                        showTemporaryNotification(`Успешно применено к ${successCount} заданиям`, 'success');
                        setTimeout(() => {
                            const url = new URL(window.location.href);
                            url.searchParams.set('_t', Date.now());
                            window.location.href = url.toString();
                        }, 1000);
                    } else {
                        showTemporaryNotification(`Применено к ${successCount} заданиям, ошибок: ${errorCount}`, 'error');
                    }
                });
            }
            
            // Обработка сброса всех изменений
            if (resetAllBtn) {
                resetAllBtn.addEventListener('click', async function() {
                    if (!confirm('Вы уверены, что хотите сбросить ВСЕ ручные изменения статистики? Это действие нельзя отменить.')) {
                        return;
                    }
                    
                    const originalText = this.innerHTML;
                    this.innerHTML = '⏳ Сброс...';
                    this.disabled = true;
                    
                    try {
                        const url = `{{ url_for('students.reset_statistics', student_id=student.student_id) }}`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({})
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data && data.success) {
                            showTemporaryNotification(data.message || 'Все ручные изменения сброшены', 'success');
                            setTimeout(() => {
                                const url = new URL(window.location.href);
                                url.searchParams.set('_t', Date.now());
                                window.location.href = url.toString();
                            }, 1000);
                        } else {
                            const errorMsg = data?.error || 'Ошибка при сбросе';
                            showTemporaryNotification(errorMsg, 'error');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('Ошибка при сбросе статистики:', error);
                        showTemporaryNotification('Ошибка при сбросе: ' + error.message, 'error');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                });
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
</body>
</html>
