<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_new %}–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %} ¬∑ URep</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    {% include '_ux_enhancements.html' %}
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'templates' %}
        {% include '_primary_nav.html' %}
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('templates.templates_list') }}" class="neo-button ghost" style="text-decoration: none;">‚Üê –ö –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</a>
                {% if is_new %}
                {% set _m = (mode or '') %}
                <div style="display:flex; gap: .5rem; flex-wrap: wrap;">
                    <a href="{{ url_for('templates.template_new') }}" class="neo-button {{ 'accent' if _m != 'manual' else 'outline' }}" style="text-decoration:none;">–ë—ã—Å—Ç—Ä–æ</a>
                    <a href="{{ url_for('templates.template_new', mode='manual') }}" class="neo-button {{ 'accent' if _m == 'manual' else 'outline' }}" style="text-decoration:none;">–í—Ä—É—á–Ω—É—é</a>
                </div>
                {% endif %}
            </div>
            <p class="hero-eyebrow">{% if is_new %}—Å–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% else %}—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% endif %}</p>
            <h1 class="hero-title">{% if is_new %}<img src="{{ url_for('static', filename='icons/SULP.png') }}" alt="–°–æ–∑–¥–∞—Ç—å" class="ui-icon ui-icon--md">–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}<img src="{{ url_for('static', filename='icons/REDACT.png') }}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="ui-icon ui-icon--md">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %}</h1>
        </section>

        <form id="templateForm" class="glass-panel">
            <div style="margin-bottom: 2rem;">
                <label class="neo-label" for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ *</label>
                <input type="text" id="name" name="name" class="neo-input" 
                       value="{{ template.name if template else '' }}" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –∑–∞–¥–∞–Ω–∏–π 1-5" required>
            </div>

            <div style="margin-bottom: 2rem;">
                <label class="neo-label" for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" class="neo-input" rows="3" 
                          placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">{{ template.description if template else '' }}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div>
                    <label class="neo-label" for="template_type">–¢–∏–ø —à–∞–±–ª–æ–Ω–∞ *</label>
                    <select id="template_type" name="template_type" class="neo-select" required>
                        <option value="homework" {% if (template and template.template_type == 'homework') or (is_new and preset_type == 'homework') %}selected{% endif %}>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</option>
                        <option value="classwork" {% if (template and template.template_type == 'classwork') or (is_new and preset_type == 'classwork') %}selected{% endif %}>–ö–ª–∞—Å—Å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                        <option value="exam" {% if (template and template.template_type == 'exam') or (is_new and preset_type == 'exam') %}selected{% endif %}>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                        <option value="lesson" {% if (template and template.template_type == 'lesson') or (is_new and preset_type == 'lesson') %}selected{% endif %}>–£—Ä–æ–∫–∏</option>
                    </select>
                </div>

                <div>
                    <label class="neo-label" for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="category" name="category" class="neo-select">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                        <option value="–ï–ì–≠" {% if (template and template.category == '–ï–ì–≠') or (is_new and preset_category == '–ï–ì–≠') %}selected{% endif %}>–ï–ì–≠</option>
                        <option value="–û–ì–≠" {% if (template and template.category == '–û–ì–≠') or (is_new and preset_category == '–û–ì–≠') %}selected{% endif %}>–û–ì–≠</option>
                        <option value="–õ–ï–í–ï–õ–ê–ü" {% if (template and template.category == '–õ–ï–í–ï–õ–ê–ü') or (is_new and preset_category == '–õ–ï–í–ï–õ–ê–ü') %}selected{% endif %}>–õ–ï–í–ï–õ–ê–ü</option>
                        <option value="–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï" {% if (template and template.category == '–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï') or (is_new and preset_category == '–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï') %}selected{% endif %}>–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï</option>
                    </select>
                </div>
            </div>

            {% if not is_new and template %}
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--surface-2); border-radius: var(--radius-lg); border: 1px solid var(--stroke-1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1em;">–ó–∞–¥–∞–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ ({{ template.template_tasks|length }})</h3>
                <p style="color: var(--text-muted); margin: 0 0 1rem 0;">–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω.</p>
                <a href="{{ url_for('kege_generator.kege_generator') }}?template_id={{ template.template_id }}" class="neo-button accent">üé≤ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
            </div>
            {% endif %}

            {% if is_new and (mode or '') == 'manual' %}
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px dashed var(--stroke-1); border-radius: var(--radius-lg); background: rgba(255,255,255,0.02);">
                    <div class="hero-eyebrow">–≤—Ä—É—á–Ω—É—é</div>
                    <div style="font-weight: 900; margin-top: .25rem;">–î–æ–±–∞–≤—å –∑–∞–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω¬ª.</div>
                    <div style="color: var(--text-muted); margin-top: .35rem; line-height: 1.4;">–≠—Ç–æ —Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω, –ø—Ä–æ—Å—Ç–æ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ ‚Äî –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π `/templates/new`.</div>
                </div>

                {% include '_manual_task_cards.html' %}

                <section class="glass-panel" style="position: sticky; bottom: 2rem; margin-top: 2rem; z-index: 100;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div id="status-text" style="color: var(--text-muted);">–ó–∞–¥–∞–Ω–∏–π: <span id="tasks-count">0</span></div>
                        <button type="button" onclick="saveManualTemplate()" class="neo-button accent">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
                        </button>
                    </div>
                </section>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <a href="{{ url_for('templates.templates_list') }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                </div>
            {% else %}
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <a href="{{ url_for('templates.templates_list') }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                    <button type="submit" class="neo-button outline" data-after="generator">{% if is_new %}–°–æ–∑–¥–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è{% endif %}</button>
                    <button type="submit" class="neo-button accent" data-after="list">{% if is_new %}–°–æ–∑–¥–∞—Ç—å{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% endif %}</button>
                </div>
            {% endif %}
        </form>
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='flash-to-toast.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <script>
        {% if not (is_new and (mode or '') == 'manual') %}
        document.getElementById('templateForm').addEventListener('submit', async function(e) { // –°–∞–±–º–∏—Ç —Ñ–æ—Ä–º—ã —à–∞–±–ª–æ–Ω–∞
            e.preventDefault(); // –ù–µ –¥–∞—ë–º –±—Ä–∞—É–∑–µ—Ä—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            
            const submitter = e.submitter || null; // –ö–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ñ–æ—Ä–º—É (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
            const after = (submitter && submitter.dataset && submitter.dataset.after) ? submitter.dataset.after : 'list'; // –ö—É–¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            
            const formData = { // –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±–µ–∫–µ–Ω–¥
                name: document.getElementById('name').value.trim(), // –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
                description: document.getElementById('description').value.trim(), // –û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
                template_type: document.getElementById('template_type').value, // –¢–∏–ø —à–∞–±–ª–æ–Ω–∞ (homework/classwork/exam/lesson)
                category: document.getElementById('category').value || null, // –ö–∞—Ç–µ–≥–æ—Ä–∏—è —à–∞–±–ª–æ–Ω–∞
                task_ids: [] // –ó–∞–¥–∞–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (template_id)
            }; // –ö–æ–Ω–µ—Ü payload

            const url = {% if is_new %}'{{ url_for('templates.template_new') }}'{% else %}'{{ url_for('templates.template_edit', template_id=template.template_id) }}'{% endif %};
            const method = 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) { // –ï—Å–ª–∏ –±–µ–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω–∏–ª —à–∞–±–ª–æ–Ω
                    toast.success('{% if is_new %}–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω{% else %}–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω{% endif %}'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    const templateId = data.template_id || {{ template.template_id if template else 'null' }}; // –ü–æ–ª—É—á–∞–µ–º id —à–∞–±–ª–æ–Ω–∞ (–¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞)
                    if (after === 'generator' && templateId) { // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª ‚Äú–¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è‚Äù
                        const params = new URLSearchParams(); // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                        params.set('template_id', String(templateId)); // –ü–µ—Ä–µ–¥–∞—ë–º template_id –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
                        params.set('assignment_type', String(formData.template_type || 'homework')); // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–∏–ø (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
                        window.location.href = '{{ url_for('kege_generator.kege_generator') }}' + '?' + params.toString(); // –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
                        return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    } // –ö–æ–Ω–µ—Ü –≤–µ—Ç–∫–∏ generator
                    setTimeout(() => { // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Ç–æ—Å—Ç —É—Å–ø–µ–ª –ø–æ–∫–∞–∑–∞—Ç—å—Å—è
                        window.location.href = '{% if is_new %}{{ url_for('templates.templates_list') }}{% else %}{{ url_for('templates.template_view', template_id=template.template_id) }}{% endif %}'; // –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –≤ —Å–ø–∏—Å–æ–∫/–ø—Ä–æ—Å–º–æ—Ç—Ä
                    }, 800); // –¢–∞–π–º–∞—É—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
                } else {
                    toast.error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞');
            }
        });
        {% else %}
        async function saveManualTemplate() {
            const name = (document.getElementById('name') || {}).value ? document.getElementById('name').value.trim() : '';
            if (!name) {
                toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞');
                document.getElementById('name') && document.getElementById('name').focus();
                return;
            }
            const description = (document.getElementById('description') || {}).value ? document.getElementById('description').value.trim() : '';
            const template_type = (document.getElementById('template_type') || {}).value || 'homework';
            const category = (document.getElementById('category') || {}).value || null;

            const cards = document.querySelectorAll('.task-card-entry');
            if (!cards || cards.length === 0) {
                toast.warning('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ');
                return;
            }

            const tasks = [];
            let hasError = false;
            cards.forEach((card) => {
                const number = (card.querySelector('.task-number-input') || {}).value || '1';
                const content = (card.querySelector('.task-content-input') || {}).value || '';
                const answer = (card.querySelector('.task-answer-input') || {}).value || '';
                if (!content.trim()) {
                    try { card.querySelector('.task-content-input').style.borderColor = 'var(--danger-color)'; } catch (e) {}
                    hasError = true;
                } else {
                    tasks.push({ number: parseInt(number, 10) || 1, content, answer });
                }
            });
            if (hasError) {
                toast.error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π');
                return;
            }

            const loaderId = (window.loading && typeof loading.show === 'function') ? loading.show(document.body, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞...') : null;
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            try {
                const res = await fetch('{{ url_for('templates.template_new') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken ? csrfToken.content : ''
                    },
                    body: JSON.stringify({ name, description, template_type, category, tasks })
                });
                const data = await res.json();
                if (data && data.success) {
                    toast.success('–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω');
                    const tid = data.template_id;
                    setTimeout(() => {
                        window.location.href = tid ? ('{{ url_for('templates.template_view', template_id=0) }}'.replace('/0', '/' + String(tid))) : '{{ url_for('templates.templates_list') }}';
                    }, 800);
                } else {
                    toast.error((data && data.error) ? data.error : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                }
            } catch (e) {
                console.error(e);
                toast.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            } finally {
                if (loaderId && window.loading && typeof loading.hide === 'function') {
                    loading.hide(loaderId);
                }
            }
        }
        {% endif %}
    </script>
</body>
</html>










