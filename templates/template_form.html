<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_new %}–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %} ¬∑ –ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    {% include '_ux_enhancements.html' %}
</head>
<body>
    <header class="nav-primary">
        <div class="nav-brand">
            {% if current_user and current_user.is_authenticated %}
            <a href="{{ url_for('auth.user_profile') }}" class="user-profile-avatar {% if current_user.is_creator() %}creator{% endif %}" title="{{ current_user.username }} ({{ current_user.get_role_display() }})">
                {{ current_user.username[0].upper() }}
            </a>
            {% endif %}
            <a href="{{ url_for('main.index') }}" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; color: inherit;">
                <div class="brand-mark">LOGO</div>
                <div class="brand-caption">–°–ª–æ—Ç –ø–æ–¥ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –∑–Ω–∞–∫</div>
            </a>
        </div>
        {% include '_mobile_menu.html' %}
        <nav class="nav-links">
            <a href="{{ url_for('main.dashboard') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/students_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –£—á–µ–Ω–∏–∫–∏" class="nav-link-icon">
                    <span class="nav-link-label">–£—á–µ–Ω–∏–∫–∏</span>
                </span>
            </a>
            <a href="{{ url_for('schedule.schedule') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/schedule_white.png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" class="nav-link-icon">
                    <span class="nav-link-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
                </span>
            </a>
            <a href="{{ url_for('kege_generator.kege_generator') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/generator_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä" class="nav-link-icon">
                    <span class="nav-link-label">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</span>
                </span>
            </a>
            <a href="{{ url_for('main.update_plans') }}" class="nav-link">
                <span class="nav-link-content">
                    <img src="{{ url_for('static', filename='icons/notes_white-no-bg-preview (carve.photos).png') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ü–ª–∞–Ω—ã" class="nav-link-icon">
                    <span class="nav-link-label">–ü–ª–∞–Ω—ã</span>
                </span>
            </a>
        </nav>
    </header>

    <div class="app-shell">
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('templates_manager.templates_list') }}" class="neo-button ghost" style="text-decoration: none;">‚Üê –ö –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</a>
            </div>
            <p class="hero-eyebrow">{% if is_new %}—Å–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% else %}—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% endif %}</p>
            <h1 class="hero-title">{% if is_new %}‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %}</h1>
        </section>

        <form id="templateForm" class="glass-panel">
            <div style="margin-bottom: 2rem;">
                <label class="neo-label" for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ *</label>
                <input type="text" id="name" name="name" class="neo-input" 
                       value="{{ template.name if template else '' }}" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –∑–∞–¥–∞–Ω–∏–π 1-5" required>
            </div>

            <div style="margin-bottom: 2rem;">
                <label class="neo-label" for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" class="neo-input" rows="3" 
                          placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">{{ template.description if template else '' }}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div>
                    <label class="neo-label" for="template_type">–¢–∏–ø —à–∞–±–ª–æ–Ω–∞ *</label>
                    <select id="template_type" name="template_type" class="neo-select" required>
                        <option value="homework" {% if template and template.template_type == 'homework' %}selected{% endif %}>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</option>
                        <option value="classwork" {% if template and template.template_type == 'classwork' %}selected{% endif %}>–ö–ª–∞—Å—Å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                        <option value="exam" {% if template and template.template_type == 'exam' %}selected{% endif %}>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                        <option value="lesson" {% if template and template.template_type == 'lesson' %}selected{% endif %}>–£—Ä–æ–∫–∏</option>
                    </select>
                </div>

                <div>
                    <label class="neo-label" for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="category" name="category" class="neo-select">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                        <option value="–ï–ì–≠" {% if template and template.category == '–ï–ì–≠' %}selected{% endif %}>–ï–ì–≠</option>
                        <option value="–û–ì–≠" {% if template and template.category == '–û–ì–≠' %}selected{% endif %}>–û–ì–≠</option>
                        <option value="–õ–ï–í–ï–õ–ê–ü" {% if template and template.category == '–õ–ï–í–ï–õ–ê–ü' %}selected{% endif %}>–õ–ï–í–ï–õ–ê–ü</option>
                        <option value="–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï" {% if template and template.category == '–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï' %}selected{% endif %}>–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï</option>
                    </select>
                </div>
            </div>

            {% if not is_new and template %}
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--surface-2); border-radius: var(--radius-lg); border: 1px solid var(--stroke-1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1em;">–ó–∞–¥–∞–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ ({{ template.template_tasks|length }})</h3>
                <p style="color: var(--text-muted); margin: 0 0 1rem 0;">–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω.</p>
                <a href="{{ url_for('kege_generator.kege_generator') }}?template_id={{ template.template_id }}" class="neo-button accent">üé≤ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
            </div>
            {% endif %}

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <a href="{{ url_for('templates_manager.templates_list') }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                <button type="submit" class="neo-button accent">{% if is_new %}–°–æ–∑–¥–∞—Ç—å{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% endif %}</button>
            </div>
        </form>
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='flash-to-toast.js') }}"></script>
    <script>
        document.getElementById('templateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('description').value.trim(),
                template_type: document.getElementById('template_type').value,
                category: document.getElementById('category').value || null,
                task_ids: [] // –ü–æ–∫–∞ –ø—É—Å—Ç–æ–π, –∑–∞–¥–∞–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
            };

            const url = {% if is_new %}'{{ url_for('templates_manager.template_new') }}'{% else %}'{{ url_for('templates_manager.template_edit', template_id=template.template_id) }}'{% endif %};
            const method = 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    toast.success('{% if is_new %}–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω{% else %}–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω{% endif %}');
                    setTimeout(() => {
                        window.location.href = '{{ url_for('templates_manager.templates_list') }}';
                    }, 1000);
                } else {
                    toast.error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞');
            }
        });
    </script>
</body>
</html>










