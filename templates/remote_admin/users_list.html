<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пользователи · Удаленная админка</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='relationship-graph.css') }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-2);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 1.5rem;
        }
        .users-table th {
            background: var(--surface-3);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--stroke-2);
        }
        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--stroke-1);
        }
        .users-table tr:hover {
            background: var(--surface-3);
        }
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
        }
        .role-admin { background: rgba(255, 46, 46, 0.15); color: #ff2e2e; }
        .role-tutor { background: rgba(46, 125, 255, 0.15); color: #2e7dff; }
        .role-student { background: rgba(46, 255, 125, 0.15); color: #2eff7d; }
        .role-parent { background: rgba(255, 200, 46, 0.15); color: #ffc82e; }
        .role-tester { background: rgba(150, 150, 150, 0.15); color: #969696; }
        .role-creator { background: rgba(200, 46, 255, 0.15); color: #c82eff; }
        .role-chief_tester { background: rgba(255, 150, 46, 0.15); color: #ff962e; }
        .role-designer { background: rgba(46, 255, 200, 0.15); color: #2effc8; }
        .status-active { color: #2eff7d; }
        .status-inactive { color: #ff2e2e; }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0 0 0;
            flex-wrap: wrap;
        }
        .tab-btn {
            border: 1px solid var(--stroke-2);
            background: var(--surface-2);
            color: var(--text-primary);
            padding: 0.55rem 0.9rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-btn.active {
            background: var(--accent-1);
            color: #000;
            border-color: rgba(0,0,0,0.15);
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1.8fr 1fr auto;
            gap: 1rem;
            align-items: end;
            margin-top: 1rem;
        }
        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .chip {
            display: inline-flex;
            gap: 0.45rem;
            align-items: center;
            padding: 0.45rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--stroke-2);
            background: var(--surface-3);
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.92rem;
        }
        .chip.muted { opacity: 0.8; }
        .chip.active { background: rgba(46, 125, 255, 0.18); border-color: rgba(46, 125, 255, 0.35); }
        .chip small { opacity: 0.8; font-weight: 700; }

        .graph-shell {
            margin-top: 1.5rem;
            border: 1px solid var(--stroke-2);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            overflow: hidden;
        }
        .graph-toolbar {
            padding: 1rem;
            border-bottom: 1px solid var(--stroke-2);
            display: grid;
            grid-template-columns: 1.2fr 1.2fr 1.2fr 1fr;
            gap: 1rem;
            align-items: end;
            background: var(--surface-3);
        }
        .graph-stage {
            position: relative;
            padding: 1rem;
            min-height: 520px;
            overflow: auto;
        }
        .graph-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            min-width: 980px;
        }
        .graph-col {
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-md);
            background: rgba(255,255,255,0.02);
            padding: 0.75rem;
        }
        .graph-col h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .node-card {
            border: 1px solid var(--stroke-2);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }
        .node-card:hover { background: var(--surface-3); }
        .node-title { font-weight: 800; color: var(--text-primary); display:flex; gap:0.5rem; align-items:center; }
        .node-sub { color: var(--text-muted); font-size: 0.88rem; margin-top: 0.25rem; }
        .node-dim { opacity: 0.55; }
        .graph-svg {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        .graph-svg path {
            pointer-events: auto;
            cursor: pointer;
        }
        .edge-label {
            font-size: 12px;
            fill: var(--text-muted);
        }

        dialog.link-dialog {
            border: 1px solid var(--stroke-2);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            color: var(--text-primary);
            padding: 0;
            width: min(680px, 92vw);
        }
        dialog.link-dialog::backdrop {
            background: rgba(0,0,0,0.55);
        }
        .dlg-head {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--stroke-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface-3);
        }
        .dlg-body { padding: 1rem 1.25rem; display: grid; gap: 0.9rem; }
        .dlg-actions { padding: 1rem 1.25rem; border-top: 1px solid var(--stroke-2); display:flex; justify-content:flex-end; gap:0.6rem; }
    </style>
</head>
<body>
    <div class="app-shell">
        {% include 'remote_admin/_header.html' %}
        {% include 'remote_admin/_sidebar.html' %}

        <main style="margin-left: 250px; margin-top: 70px; padding: 2rem;">
        <section class="glass-panel" style="max-width: 1400px; padding: 2rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <div>
                    <h1 style="margin: 0;">Пользователи</h1>
                    <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">
                        Окружение: <strong>{{ environment_name }}</strong>
                    </p>
                </div>
                <a href="{{ url_for('remote_admin.user_new') }}" class="neo-button" style="text-decoration: none;">
                    + Создать пользователя
                </a>
            </div>

            <div class="tabs" role="tablist" aria-label="Users tabs">
                <button class="tab-btn active" type="button" data-tab="list">Список</button>
                <button class="tab-btn" type="button" data-tab="graph">Связи (граф)</button>
            </div>

            <div id="tab-list" role="tabpanel">
                <form method="GET" class="filters-row" style="margin-top: 1rem;">
                    <div class="neo-field">
                        <label class="neo-label" for="q">Поиск (логин/email/роль)</label>
                        <input id="q" name="q" class="neo-input" value="{{ q or '' }}" placeholder="например: student_1 или parent@example.com">
                    </div>
                    <div class="neo-field">
                        <label class="neo-label" for="is_active">Статус</label>
                        <select id="is_active" name="is_active" class="neo-input">
                            <option value="" {% if not is_active_filter %}selected{% endif %}>Все</option>
                            <option value="true" {% if is_active_filter == 'true' %}selected{% endif %}>Активные</option>
                            <option value="false" {% if is_active_filter == 'false' %}selected{% endif %}>Неактивные</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:0.6rem; justify-content:flex-end; align-items:end;">
                        <button class="neo-button outline" type="submit">Применить</button>
                        <a class="neo-button ghost" href="{{ url_for('remote_admin.users_list') }}">Сбросить</a>
                    </div>
                </form>

                <div class="chip-row" aria-label="Быстрые фильтры по ролям">
                    {% set all_url = url_for('remote_admin.users_list', q=q or None, is_active=is_active_filter or None) %}
                    <a class="chip {% if not selected_roles %}active{% endif %}" href="{{ all_url }}">Все <small>{{ users|length }}</small></a>
                    {% set roles = [
                        ('creator','Создатели'),
                        ('admin','Админы'),
                        ('tutor','Преподаватели'),
                        ('student','Ученики'),
                        ('parent','Родители'),
                        ('tester','Тестеры'),
                        ('chief_tester','Главные тестеры'),
                        ('designer','Дизайнеры')
                    ] %}
                    {% for r, label in roles %}
                        {% set url = url_for('remote_admin.users_list', roles=r, q=q or None, is_active=is_active_filter or None) %}
                        <a class="chip {% if selected_roles and (selected_roles|length == 1) and (selected_roles[0] == r) %}active{% else %}muted{% endif %}"
                           href="{{ url }}">
                           {{ label }} <small>{{ role_stats.get(r, 0) }}</small>
                        </a>
                    {% endfor %}
                </div>

                {% if users %}
                <table class="users-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Роль</th>
                        <th>Email</th>
                        <th>Статус</th>
                        <th>Создан</th>
                        <th>Последний вход</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: var(--text-primary);">{{ user.username }}</div>
                        </td>
                        <td>
                            <span class="role-badge role-{{ user.role }}">
                                {% if user.role == 'creator' %}Создатель
                                {% elif user.role == 'admin' %}Администратор
                                {% elif user.role == 'tutor' %}Преподаватель
                                {% elif user.role == 'student' %}Ученик
                                {% elif user.role == 'parent' %}Родитель
                                {% elif user.role == 'tester' %}Тестировщик
                                {% elif user.role == 'chief_tester' %}Главный тестировщик
                                {% elif user.role == 'designer' %}Графический дизайнер
                                {% else %}{{ user.role }}{% endif %}
                            </span>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">{{ user.email or '—' }}</div>
                        </td>
                        <td>
                            {% if user.is_active %}
                            <span class="status-active">● Активен</span>
                            {% else %}
                            <span class="status-inactive">● Неактивен</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                {% if user.created_at %}{{ user.created_at[:10] }}{% else %}—{% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                {% if user.last_login %}{{ user.last_login[:10] }}{% else %}—{% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem;">
                                <a href="{{ url_for('remote_admin.user_edit', user_id=user.id) }}" class="neo-button ghost" style="padding:0.5rem 0.75rem; text-decoration: none;" title="Редактировать">
                                    <img src="{{ url_for('static', filename='icons/icons8-редактировать-100.png') }}" alt="Редактировать" class="ui-icon ui-icon--sm">
                                </a>
                                {% if user.role != 'creator' %}
                                <button type="button" class="neo-button danger action-delete-btn" style="padding:0.5rem 0.75rem;" title="Удалить" 
                                        data-url="{{ url_for('remote_admin.api_user_manage', user_id=user.id) }}" 
                                        data-method="DELETE"
                                        data-confirm-message="Вы уверены, что хотите удалить пользователя '{{ user.username }}'? Это действие нельзя отменить.">
                                    <img src="{{ url_for('static', filename='icons/icons8-умножение-96.png') }}" alt="Удалить" class="ui-icon ui-icon--sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span style="display:none;">✕</span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>Пользователи не найдены или произошла ошибка загрузки</p>
            </div>
            {% endif %}
            </div>

            <div id="tab-graph" role="tabpanel" style="display:none;">
                <p style="color: var(--text-muted); margin-top: 1rem;">
                    Наглядно показывает связи: <strong>преподаватель → ученик</strong> (Enrollment) и <strong>родитель → ученик</strong> (FamilyTie).
                    Клик по стрелке — редактирование “настройки” связи.
                </p>
                <div id="rel-graph-remote"
                     data-graph-url="{{ url_for('remote_admin.api_users_graph') }}"
                     data-ft-prefix="{{ url_for('remote_admin.api_family_tie_manage', tie_id=0)[:-1] }}"
                     data-enr-prefix="{{ url_for('remote_admin.api_enrollment_manage', enrollment_id=0)[:-1] }}"
                     data-storage-key="relationshipGraph:remote:{{ environment_name|e }}">
                </div>
            </div>
        </section>
        </main>
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script src="{{ url_for('static', filename='confirm-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='relationship-graph.js') }}"></script>
    <script>
        // Обработка удаления через AJAX
        document.addEventListener('DOMContentLoaded', function() {
            // Tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabList = document.getElementById('tab-list');
            const tabGraph = document.getElementById('tab-graph');
            function setTab(name) {
                tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
                tabList.style.display = (name === 'list') ? '' : 'none';
                tabGraph.style.display = (name === 'graph') ? '' : 'none';
            }
            tabButtons.forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));

            document.querySelectorAll('.action-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.dataset.url;
                    const method = this.dataset.method || 'POST';
                    const confirmMsg = this.dataset.confirmMessage;
                    
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success || data.error === undefined) {
                            toast.success('Пользователь удален');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            toast.error(data.error || 'Ошибка удаления');
                        }
                    })
                    .catch(e => {
                        console.error('Error:', e);
                        toast.error('Ошибка при удалении пользователя');
                    });
                });
            });
            // Relationship graph (lazy init)
            let relGraphInited = false;
            let relGraph = null;
            function initRelGraphOnce() {
                if (relGraphInited) return;
                relGraphInited = true;
                const host = document.getElementById('rel-graph-remote');
                if (!host || !window.RelationshipGraph) return;
                relGraph = new window.RelationshipGraph(host, {
                    graphUrl: host.dataset.graphUrl,
                    ftUrlPrefix: host.dataset.ftPrefix,
                    enrUrlPrefix: host.dataset.enrPrefix,
                    storageKey: host.dataset.storageKey || 'relationshipGraph:remote',
                    enableEdgeEdit: true,
                });
                relGraph.reload().catch(e => {
                    console.error(e);
                    toast?.error?.('Не удалось загрузить граф связей');
                });
            }
            const _oldSetTab = setTab;
            setTab = function(name) {
                _oldSetTab(name);
                if (name === 'graph') initRelGraphOnce();
            }
        });
    </script>
</body>
</html>
