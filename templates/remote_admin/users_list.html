<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пользователи · Удаленная админка</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <style>
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-2);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 1.5rem;
        }
        .users-table th {
            background: var(--surface-3);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--stroke-2);
        }
        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--stroke-1);
        }
        .users-table tr:hover {
            background: var(--surface-3);
        }
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
        }
        .role-admin { background: rgba(255, 46, 46, 0.15); color: #ff2e2e; }
        .role-tutor { background: rgba(46, 125, 255, 0.15); color: #2e7dff; }
        .role-student { background: rgba(46, 255, 125, 0.15); color: #2eff7d; }
        .role-parent { background: rgba(255, 200, 46, 0.15); color: #ffc82e; }
        .role-tester { background: rgba(150, 150, 150, 0.15); color: #969696; }
        .role-creator { background: rgba(200, 46, 255, 0.15); color: #c82eff; }
        .role-chief_tester { background: rgba(255, 150, 46, 0.15); color: #ff962e; }
        .role-designer { background: rgba(46, 255, 200, 0.15); color: #2effc8; }
        .status-active { color: #2eff7d; }
        .status-inactive { color: #ff2e2e; }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'remote_admin' %}
        {% include '_primary_nav.html' %}

        <section class="glass-panel" style="margin: 2rem auto; max-width: 1400px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <a href="{{ url_for('remote_admin.dashboard') }}" class="neo-button ghost" style="text-decoration: none;">
                        ← К удаленной админке
                    </a>
                    <div>
                        <h1 style="margin: 0;">Пользователи</h1>
                        <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">
                            Окружение: <strong>{{ environment_name }}</strong>
                        </p>
                    </div>
                </div>
            </div>

            {% if users %}
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Роль</th>
                        <th>Email</th>
                        <th>Статус</th>
                        <th>Создан</th>
                        <th>Последний вход</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: var(--text-primary);">{{ user.username }}</div>
                        </td>
                        <td>
                            <span class="role-badge role-{{ user.role }}">
                                {% if user.role == 'creator' %}Создатель
                                {% elif user.role == 'admin' %}Администратор
                                {% elif user.role == 'tutor' %}Преподаватель
                                {% elif user.role == 'student' %}Ученик
                                {% elif user.role == 'parent' %}Родитель
                                {% elif user.role == 'tester' %}Тестировщик
                                {% elif user.role == 'chief_tester' %}Главный тестировщик
                                {% elif user.role == 'designer' %}Графический дизайнер
                                {% else %}{{ user.role }}{% endif %}
                            </span>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">{{ user.email or '—' }}</div>
                        </td>
                        <td>
                            {% if user.is_active %}
                            <span class="status-active">● Активен</span>
                            {% else %}
                            <span class="status-inactive">● Неактивен</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                {% if user.created_at %}{{ user.created_at[:10] }}{% else %}—{% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                {% if user.last_login %}{{ user.last_login[:10] }}{% else %}—{% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem;">
                                <button type="button" class="neo-button ghost" style="padding:0.5rem 0.75rem;" 
                                        onclick="editUser({{ user.id }})" title="Редактировать">
                                    <img src="{{ url_for('static', filename='icons/icons8-редактировать-100.png') }}" alt="Редактировать" class="ui-icon ui-icon--sm">
                                </button>
                                {% if user.role != 'creator' %}
                                <button type="button" class="neo-button danger action-delete-btn" style="padding:0.5rem 0.75rem;" title="Удалить" 
                                        data-url="{{ url_for('remote_admin.api_user_manage', user_id=user.id) }}" 
                                        data-method="DELETE"
                                        data-confirm-message="Вы уверены, что хотите удалить пользователя '{{ user.username }}'? Это действие нельзя отменить.">
                                    <img src="{{ url_for('static', filename='icons/icons8-умножение-96.png') }}" alt="Удалить" class="ui-icon ui-icon--sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span style="display:none;">✕</span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>Пользователи не найдены или произошла ошибка загрузки</p>
            </div>
            {% endif %}
        </section>
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script src="{{ url_for('static', filename='confirm-modal.js') }}"></script>
    <script>
        function editUser(userId) {
            // В будущем можно добавить модальное окно редактирования
            alert('Редактирование пользователя будет доступно в следующей версии');
        }
        
        // Обработка удаления через AJAX
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.action-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.dataset.url;
                    const method = this.dataset.method || 'POST';
                    const confirmMsg = this.dataset.confirmMessage;
                    
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success || data.error === undefined) {
                            toast.success('Пользователь удален');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            toast.error(data.error || 'Ошибка удаления');
                        }
                    })
                    .catch(e => {
                        console.error('Error:', e);
                        toast.error('Ошибка при удалении пользователя');
                    });
                });
            });
        });
    </script>
</body>
</html>
