<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–±–æ—Ç—ã - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</title>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    <style>
        .assignments-hero {
            background: radial-gradient(900px 420px at 14% 10%, rgba(0, 255, 213, 0.10), transparent 60%),
                        radial-gradient(900px 420px at 85% 20%, rgba(31, 123, 255, 0.10), transparent 55%);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .assignments-title {
            font-size: 2.2rem;
            font-weight: 900;
            margin: 0.35rem 0 0 0;
            letter-spacing: -0.01em;
        }
        .assignments-subtitle {
            color: var(--text-muted);
            margin-top: 0.65rem;
            font-size: 1rem;
            line-height: 1.5;
            max-width: 980px;
        }
        .hero-actions {
            margin-top: 1.1rem;
            display: flex;
            gap: 0.65rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 0.75rem;
            margin-top: 1.1rem;
        }
        @media (max-width: 980px) {
            .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .kpi-card {
            display: block;
            text-decoration: none;
            color: inherit;
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            border-radius: var(--radius-lg);
            padding: 0.9rem 1rem;
            transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
        }
        .kpi-card:hover {
            transform: translateY(-1px);
            border-color: rgba(0,255,213,0.35);
            background: rgba(255,255,255,0.035);
        }
        .kpi-label {
            color: var(--text-muted);
            font-weight: 800;
            font-size: 0.9rem;
        }
        .kpi-value {
            margin-top: 0.35rem;
            font-size: 1.35rem;
            font-weight: 900;
        }
        .kpi-card.active {
            border-color: rgba(0,255,213,0.55);
            box-shadow: 0 0 0 3px rgba(0,255,213,0.10);
        }

        .filters-card {
            border: 1px solid var(--stroke-1);
            background: var(--surface-1);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: 1.5fr 0.85fr 0.85fr 0.95fr auto;
            gap: 0.75rem;
            align-items: end;
        }
        @media (max-width: 980px) {
            .filters-grid { grid-template-columns: 1fr; }
        }
        .filter-label {
            color: var(--text-muted);
            font-weight: 800;
            font-size: 0.9rem;
            margin-bottom: 0.35rem;
            display: block;
        }
        .status-tabs {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
            margin-top: 0.9rem;
        }
        .tab {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.55rem 0.8rem;
            border: 1px solid var(--stroke-1);
            border-radius: 999px;
            background: rgba(255,255,255,0.02);
            text-decoration: none;
            color: inherit;
            font-weight: 900;
            font-size: 0.92rem;
            transition: background 0.18s ease, border-color 0.18s ease, transform 0.18s ease;
        }
        .tab:hover { transform: translateY(-1px); border-color: rgba(0,255,213,0.30); }
        .tab.active {
            background: rgba(0, 255, 213, 0.10);
            border-color: rgba(0, 255, 213, 0.55);
        }
        .tab-count {
            color: var(--text-muted);
            font-weight: 800;
        }

        .assignments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 0.9rem;
        }
        @media (max-width: 520px) {
            .assignments-grid { grid-template-columns: 1fr; }
        }
        .assignment-card {
            border: 1px solid var(--stroke-1);
            background: var(--surface-1);
            border-radius: var(--radius-lg);
            padding: 1.1rem;
            transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
        }
        .assignment-card:hover {
            transform: translateY(-1px);
            border-color: rgba(0,255,213,0.30);
            background: rgba(255,255,255,0.02);
        }
        .assignment-top {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .assignment-title {
            font-size: 1.15rem;
            font-weight: 900;
            margin: 0;
            line-height: 1.2;
        }
        .assignment-title a {
            color: var(--text-primary);
            text-decoration: none;
        }
        .assignment-title a:hover { text-decoration: underline; }
        .pill-row {
            margin-top: 0.55rem;
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            padding: 0.25rem 0.55rem;
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            font-weight: 900;
            font-size: 0.82rem;
            color: var(--text-primary);
        }
        .pill--danger { border-color: rgba(255, 77, 107, 0.55); background: rgba(255, 77, 107, 0.10); }
        .pill--success { border-color: rgba(45, 212, 191, 0.55); background: rgba(45, 212, 191, 0.10); }
        .pill--warning { border-color: rgba(255, 179, 71, 0.55); background: rgba(255, 179, 71, 0.10); }
        .pill--accent { border-color: rgba(0, 255, 213, 0.55); background: rgba(0, 255, 213, 0.10); }
        .meta-row {
            margin-top: 0.8rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.92rem;
            align-items: center;
        }
        .meta-strong { color: var(--text-primary); font-weight: 900; }

        .progress-wrap { margin-top: 0.9rem; }
        .progress-track {
            height: 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--stroke-1);
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
        .progress-bar.submitted { background: rgba(0, 255, 213, 0.25); }
        .progress-bar.graded { background: rgba(31, 123, 255, 0.35); }
        .progress-labels {
            margin-top: 0.55rem;
            display: flex;
            justify-content: space-between;
            gap: 0.6rem;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .actions-row {
            margin-top: 1rem;
            padding-top: 0.9rem;
            border-top: 1px solid var(--stroke-1);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        .actions-left, .actions-right {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .ghost-link {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 900;
        }
        .ghost-link:hover { color: var(--text-primary); text-decoration: underline; }

        .empty-card {
            text-align: center;
            padding: 3.25rem 1.25rem;
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
        }
        .steps {
            margin: 1.1rem auto 0 auto;
            max-width: 760px;
            text-align: left;
            display: grid;
            gap: 0.75rem;
        }
        .step {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            border-radius: var(--radius-lg);
            padding: 0.9rem 1rem;
        }
        .step-no {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            background: rgba(0,255,213,0.12);
            border: 1px solid rgba(0,255,213,0.35);
            font-weight: 900;
        }
        .step-title { font-weight: 900; }
        .step-sub { color: var(--text-muted); margin-top: 0.2rem; line-height: 1.45; }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'assignments' %}
        {% include '_primary_nav.html' %}

        <main style="margin-top: 1.25rem;">
            <section class="assignments-hero">
                <div class="hero-eyebrow">–£—á—ë–±–∞</div>
                <h1 class="assignments-title">–†–∞–±–æ—Ç—ã</h1>
                <div class="assignments-subtitle">
                    –ó–¥–µ—Å—å —Ç—ã —É–ø—Ä–∞–≤–ª—è–µ—à—å —Ä–∞–±–æ—Ç–∞–º–∏ –∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç—è–º–∏: –≤–∏–¥–∏—à—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–¥–∞—á, —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–æ–º—É –≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É –∏ –∫–∞–∫–∏–µ —Ä–∞–±–æ—Ç—ã —É–∂–µ –∑–∞–∫—Ä—ã—Ç—ã.
                </div>

                <div class="hero-actions">
                    {% if can_create %}
                    <a href="{{ url_for('kege_generator.show_accepted', create='1', assignment_type='homework') }}" class="neo-button accent" style="text-decoration:none;">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É –∏–∑ –ø—Ä–∏–Ω—è—Ç—ã—Ö
                    </a>
                    {% endif %}
                    <a href="{{ url_for('kege_generator.kege_generator') }}" class="neo-button outline" style="text-decoration:none;">
                        ‚ö° –û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
                    </a>
                    <a href="{{ url_for('lessons.review_queue', source='assignments', status='submitted') }}" class="neo-button ghost" style="text-decoration:none;">
                        ‚úÖ –û—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏
                    </a>
                    <span style="color: var(--text-muted); font-weight: 800;">
                        –°–æ–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–∏ –∑–∞–¥–∞–Ω–∏—è –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ ‚Üí –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞–π —Ä–∞–±–æ—Ç—É –∏–∑ ¬´–ü—Ä–∏–Ω—è—Ç—ã—Ö¬ª.
                    </span>
                </div>

                <div class="kpi-grid">
                    <a class="kpi-card {% if filters.status in ['all', 'active'] %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='active') }}">
                        <div class="kpi-label">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                        <div class="kpi-value">{{ (kpis.active if kpis is defined else 0) }}</div>
                    </a>
                    <a class="kpi-card {% if filters.status == 'needs_grading' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='needs_grading') }}">
                        <div class="kpi-label">–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
                        <div class="kpi-value">{{ (kpis.needs_grading if kpis is defined else 0) }}</div>
                    </a>
                    <a class="kpi-card {% if filters.status == 'returned' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='returned') }}">
                        <div class="kpi-label">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ</div>
                        <div class="kpi-value">{{ (kpis.returned if kpis is defined else 0) }}</div>
                    </a>
                    <a class="kpi-card {% if filters.status == 'overdue' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='overdue') }}">
                        <div class="kpi-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                        <div class="kpi-value">{{ (kpis.overdue if kpis is defined else 0) }}</div>
                    </a>
                    <a class="kpi-card {% if filters.status == 'completed' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='completed') }}">
                        <div class="kpi-label">–ì–æ—Ç–æ–≤–æ</div>
                        <div class="kpi-value">{{ (kpis.completed if kpis is defined else 0) }}</div>
                    </a>
                    <a class="kpi-card {% if filters.status == 'archived' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived='1', status='archived') }}">
                        <div class="kpi-label">–ê—Ä—Ö–∏–≤</div>
                        <div class="kpi-value">{{ (kpis.archived if kpis is defined else 0) }}</div>
                    </a>
                </div>
            </section>

            <section class="filters-card">
                <form method="GET" class="filters-grid" id="assignmentsFilterForm">
                    <div>
                        <label class="filter-label" for="q">–ü–æ–∏—Å–∫</label>
                        <input class="neo-input" id="q" name="q" value="{{ filters.q if filters is defined else '' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã‚Ä¶">
                    </div>

                    <div>
                        <label class="filter-label" for="type">–¢–∏–ø</label>
                        <select class="neo-select" id="type" name="type">
                            <option value="" {% if not filters.type %}selected{% endif %}>–í—Å–µ</option>
                            <option value="homework" {% if filters.type == 'homework' %}selected{% endif %}>–î–ó</option>
                            <option value="classwork" {% if filters.type == 'classwork' %}selected{% endif %}>–ö–†</option>
                            <option value="exam" {% if filters.type == 'exam' %}selected{% endif %}>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è</option>
                            <option value="test" {% if filters.type == 'test' %}selected{% endif %}>–¢–µ—Å—Ç</option>
                        </select>
                    </div>

                    <div>
                        <label class="filter-label" for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                        <select class="neo-select" id="sort" name="sort">
                            <option value="created_desc" {% if (filters.sort if filters is defined else '') == 'created_desc' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                            <option value="deadline_asc" {% if (filters.sort if filters is defined else '') == 'deadline_asc' %}selected{% endif %}>–î–µ–¥–ª–∞–π–Ω –±–ª–∏–∂–µ</option>
                            <option value="deadline_desc" {% if (filters.sort if filters is defined else '') == 'deadline_desc' %}selected{% endif %}>–î–µ–¥–ª–∞–π–Ω –¥–∞–ª—å—à–µ</option>
                            <option value="title_asc" {% if (filters.sort if filters is defined else '') == 'title_asc' %}selected{% endif %}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                        </select>
                    </div>

                    <div>
                        <label class="filter-label" for="archivedToggle">–ê—Ä—Ö–∏–≤</label>
                        <label style="display:flex; align-items:center; gap:.55rem; user-select:none;">
                            <input id="archivedToggle" type="checkbox" name="archived" value="1" {% if (filters.archived if filters is defined else '0') == '1' %}checked{% endif %}>
                            <span style="color: var(--text-muted); font-weight: 800;">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤</span>
                        </label>
                    </div>

                    <div style="display:flex; gap:.6rem; flex-wrap: wrap; justify-content:flex-end;">
                        <input type="hidden" name="status" value="{{ filters.status if filters is defined else 'all' }}">
                        <button type="submit" class="neo-button accent">
                            <i class="fas fa-filter ui-icon ui-icon--sm"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                        <a href="{{ url_for('assignments.assignments_list') }}" class="neo-button outline" style="text-decoration:none;">
                            <i class="fas fa-rotate-left ui-icon ui-icon--sm"></i> –°–±—Ä–æ—Å
                        </a>
                    </div>
                </form>

                <div class="status-tabs">
                    <a class="tab {% if filters.status == 'all' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='all') }}">
                        –í—Å–µ <span class="tab-count">({{ (kpis.total if kpis is defined else 0) }})</span>
                    </a>
                    <a class="tab {% if filters.status == 'active' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='active') }}">
                        –ê–∫—Ç–∏–≤–Ω—ã–µ <span class="tab-count">({{ (kpis.active if kpis is defined else 0) }})</span>
                    </a>
                    <a class="tab {% if filters.status == 'needs_grading' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='needs_grading') }}">
                        –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å <span class="tab-count">({{ (kpis.needs_grading if kpis is defined else 0) }})</span>
                    </a>
                    <a class="tab {% if filters.status == 'returned' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='returned') }}">
                        –ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ <span class="tab-count">({{ (kpis.returned if kpis is defined else 0) }})</span>
                    </a>
                    <a class="tab {% if filters.status == 'overdue' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='overdue') }}">
                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ <span class="tab-count">({{ (kpis.overdue if kpis is defined else 0) }})</span>
                    </a>
                    <a class="tab {% if filters.status == 'completed' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived=filters.archived, status='completed') }}">
                        –ì–æ—Ç–æ–≤–æ <span class="tab-count">({{ (kpis.completed if kpis is defined else 0) }})</span>
                    </a>
                    {% if (filters.archived if filters is defined else '0') == '1' %}
                    <a class="tab {% if filters.status == 'archived' %}active{% endif %}" href="{{ url_for('assignments.assignments_list', q=filters.q, type=filters.type, sort=filters.sort, archived='1', status='archived') }}">
                        –ê—Ä—Ö–∏–≤ <span class="tab-count">({{ (kpis.archived if kpis is defined else 0) }})</span>
                    </a>
                    {% endif %}
                </div>
            </section>

            {% if assignments_data and assignments_data|length > 0 %}
            <section class="assignments-grid" id="assignmentsGrid">
                {% for item in assignments_data %}
                {% set total = item.total_students %}
                {% set submitted = item.submitted %}
                {% set graded = item.graded %}
                {% set submitted_pct = ( (submitted * 100 / total) if total else 0 ) %}
                {% set graded_pct = ( (graded * 100 / total) if total else 0 ) %}
                <article class="assignment-card" data-assignment-id="{{ item.assignment.assignment_id }}">
                    <div class="assignment-top">
                        <div style="min-width:0;">
                            <h3 class="assignment-title">
                                <a href="{{ url_for('assignments.assignment_view', assignment_id=item.assignment.assignment_id) }}">{{ item.assignment.title }}</a>
                            </h3>

                            <div class="pill-row">
                                <span class="pill">–¢–∏–ø: <span class="meta-strong">{{ item.type_short }}</span></span>
                                {% if item.is_archived %}
                                    <span class="pill">–ê—Ä—Ö–∏–≤</span>
                                {% endif %}
                                {% if item.is_overdue %}
                                    <span class="pill pill--danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                {% endif %}
                                {% if item.to_grade and item.to_grade > 0 %}
                                    <span class="pill pill--accent">–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: <span class="meta-strong">{{ item.to_grade }}</span></span>
                                {% endif %}
                                {% if item.returned and item.returned > 0 %}
                                    <span class="pill pill--warning">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ: <span class="meta-strong">{{ item.returned }}</span></span>
                                {% endif %}
                                {% if item.is_completed %}
                                    <span class="pill pill--success">–ì–æ—Ç–æ–≤–æ</span>
                                {% endif %}
                            </div>

                            <div class="meta-row">
                                <span>üìÖ –î–µ–¥–ª–∞–π–Ω: <span class="meta-strong">{{ item.assignment.deadline.strftime('%d.%m.%Y %H:%M') }}</span></span>
                                <span>üë• –£—á–µ–Ω–∏–∫–æ–≤: <span class="meta-strong">{{ total }}</span></span>
                                <span>üß© –ó–∞–¥–∞—á: <span class="meta-strong">{{ item.tasks_count }}</span></span>
                            </div>
                        </div>

                        <div style="display:flex; align-items:flex-start; gap:.5rem; flex-wrap:wrap; justify-content:flex-end;">
                            {% if item.to_grade and item.to_grade > 0 %}
                            <a class="neo-button accent sm" style="text-decoration:none;" href="{{ url_for('assignments.assignment_view', assignment_id=item.assignment.assignment_id) }}">
                                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ({{ item.to_grade }})
                            </a>
                            {% endif %}
                            <a class="neo-button outline sm" style="text-decoration:none;" href="{{ url_for('assignments.assignment_view', assignment_id=item.assignment.assignment_id) }}">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </a>
                        </div>
                    </div>

                    <div class="progress-wrap">
                        <div class="progress-track" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–¥–∞—á">
                            <div class="progress-bar submitted" style="width: {{ submitted_pct }}%;"></div>
                            <div class="progress-bar graded" style="width: {{ graded_pct }}%;"></div>
                        </div>
                        <div class="progress-labels">
                            <span>–°–¥–∞–Ω–æ: <span class="meta-strong">{{ submitted }}</span>/<span class="meta-strong">{{ total }}</span></span>
                            <span>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: <span class="meta-strong">{{ graded }}</span>/<span class="meta-strong">{{ total }}</span></span>
                        </div>
                    </div>

                    <div class="actions-row">
                        <div class="actions-left">
                            <a class="ghost-link" href="{{ url_for('assignments.assignment_view', assignment_id=item.assignment.assignment_id) }}">–î–µ—Ç–∞–ª–∏ ‚Üí</a>
                        </div>

                        <div class="actions-right">
                            {% if can_create and (not item.is_archived) %}
                            <button type="button" class="neo-button outline sm" onclick="duplicateAssignment({{ item.assignment.assignment_id }})">
                                <i class="fas fa-clone ui-icon ui-icon--sm"></i> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button type="button" class="neo-button ghost sm" onclick="archiveAssignment({{ item.assignment.assignment_id }})" style="color: var(--danger);">
                                <i class="fas fa-archive ui-icon ui-icon--sm"></i> –í –∞—Ä—Ö–∏–≤
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </article>
                {% endfor %}
            </section>
            {% else %}
            <section class="empty-card">
                <div style="font-size: 3.2rem; margin-bottom: .65rem;">üìù</div>
                <div style="font-size: 1.55rem; font-weight: 900; margin-bottom: .45rem;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞–±–æ—Ç</div>
                <div style="color: var(--text-muted); line-height: 1.55; max-width: 820px; margin: 0 auto;">
                    –†–∞–±–æ—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–∑ –Ω–∞–±–æ—Ä–∞ –∑–∞–¥–∞—á (–æ–±—ã—á–Ω–æ ‚Äî –∏–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞). –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –±—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ.
                </div>

                <div class="steps">
                    <div class="step">
                        <div class="step-no">1</div>
                        <div>
                            <div class="step-title">–ü–æ–¥–±–µ—Ä–∏ –∑–∞–¥–∞–Ω–∏—è</div>
                            <div class="step-sub">–í –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ —Å–æ–±–µ—Ä–∏ –Ω–∞–±–æ—Ä –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª.</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-no">2</div>
                        <div>
                            <div class="step-title">–°–æ–∑–¥–∞–π —Ä–∞–±–æ—Ç—É</div>
                            <div class="step-sub">–û—Ç–∫—Ä–æ–π ¬´–ü—Ä–∏–Ω—è—Ç—ã–µ¬ª –∏ —Å–æ–∑–¥–∞–π —Ä–∞–±–æ—Ç—É —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏.</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-no">3</div>
                        <div>
                            <div class="step-title">–ü—Ä–æ–≤–µ—Ä—å –∏ –≤–µ—Ä–Ω–∏</div>
                            <div class="step-sub">–ü–æ—Å–ª–µ —Å–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É–π ¬´–û—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏¬ª –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–∞–±–æ—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–¥–æ—Ä–∞–±–æ—Ç–∫–∏.</div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:.75rem; justify-content:center; flex-wrap: wrap; margin-top: 1.2rem;">
                    {% if can_create %}
                    <a href="{{ url_for('kege_generator.show_accepted', create='1', assignment_type='homework') }}" class="neo-button accent" style="text-decoration:none;">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É –∏–∑ –ø—Ä–∏–Ω—è—Ç—ã—Ö
                    </a>
                    {% endif %}
                    <a href="{{ url_for('kege_generator.kege_generator') }}" class="neo-button outline" style="text-decoration:none;">
                        ‚ö° –û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
                    </a>
                    <a href="{{ url_for('lessons.review_queue', source='assignments', status='submitted') }}" class="neo-button ghost" style="text-decoration:none;">
                        ‚úÖ –û—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏
                    </a>
                </div>
            </section>
            {% endif %}
        </main>
    </div>

    <script>
        (function () {
            'use strict';

            const CSRF_TOKEN = (document.querySelector('meta[name="csrf-token"]') || { getAttribute: () => null }).getAttribute('content') || '';

            function toastAny(type, msg) {
                try {
                    const t = (window.toast || (typeof toast !== 'undefined' ? toast : null));
                    if (!t) return;
                    if (type === 'success') t.success(msg);
                    else if (type === 'warning') t.warning(msg);
                    else if (type === 'info') t.info(msg);
                    else t.error(msg);
                } catch (e) {}
            }

            async function postJson(url, payload) {
                const headers = { 'Content-Type': 'application/json' };
                if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

                const res = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: payload ? JSON.stringify(payload) : JSON.stringify({}),
                    credentials: 'same-origin',
                });

                let data = null;
                try { data = await res.json(); } catch (e) { data = null; }
                return { ok: res.ok, status: res.status, data };
            }

            window.archiveAssignment = async function (assignmentId) {
                try {
                    if (!assignmentId) return;
                    const confirmed = window.confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É? –û–Ω–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–Ω–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–µ).');
                    if (!confirmed) return;

                    const url = '/assignments/' + encodeURIComponent(String(assignmentId)) + '/archive';
                    const { ok, data } = await postJson(url, {});
                    if (!ok || !data || !data.success) {
                        toastAny('error', (data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å.');
                        return;
                    }
                    toastAny('success', '–†–∞–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤.');
                    window.location.reload();
                } catch (e) {
                    toastAny('error', '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.');
                }
            };

            window.duplicateAssignment = async function (assignmentId) {
                try {
                    if (!assignmentId) return;
                    const confirmed = window.confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —Ä–∞–±–æ—Ç—ã –∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ–º –∂–µ —É—á–µ–Ω–∏–∫–∞–º (–¥–µ–¥–ª–∞–π–Ω +7 –¥–Ω–µ–π)?');
                    if (!confirmed) return;

                    const url = '/assignments/' + encodeURIComponent(String(assignmentId)) + '/duplicate';
                    const { ok, data } = await postJson(url, {});
                    if (!ok || !data || !data.success) {
                        toastAny('error', (data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é.');
                        return;
                    }
                    const newId = data.assignment_id;
                    toastAny('success', '–ö–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶');
                    if (newId) {
                        window.location.href = '/assignments/' + encodeURIComponent(String(newId));
                    } else {
                        window.location.reload();
                    }
                } catch (e) {
                    toastAny('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–ø–∏–∏.');
                }
            };

            // UX: –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤" ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É
            try {
                const archivedToggle = document.getElementById('archivedToggle');
                const form = document.getElementById('assignmentsFilterForm');
                if (archivedToggle && form) {
                    archivedToggle.addEventListener('change', function () {
                        form.submit();
                    });
                }
            } catch (e) {}
        })();
    </script>
</body>
</html>
