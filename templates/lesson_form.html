<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} ¬∑ {{ student.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    {% include '_ux_enhancements.html' %}
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .form-hero {
            margin-bottom: 2rem;
        }
        
        .form-section {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--stroke-1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .form-grid-full {
            grid-column: 1 / -1;
        }
        
        .student-context {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .student-context h3 {
            color: var(--text-primary);
            margin: 0;
            font-weight: 700;
        }
        
        .tasks-preview {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .tasks-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .tasks-preview-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .task-preview-card {
            background: var(--surface-2);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .task-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .task-preview-number {
            font-weight: 700;
            color: var(--accent-1);
        }
        
        .task-preview-content {
            margin-top: 0.8em;
            padding: 0.8em;
            background: var(--surface-3);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .task-preview-answer {
            margin-top: 0.5em;
            padding: 0.5em;
            background: rgba(0, 254, 202, 0.12);
            border-left: 3px solid var(--success);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
        }
    </style>
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        <img src="{{ url_for('static', filename='icons/icons8-–Ω–∞—É—à–Ω–∏–∫–∏-100.png') }}" alt="–£—Ä–æ–∫" class="ui-icon ui-icon--sm"> –£—Ä–æ–∫ –∏–¥–µ—Ç: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">—Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>–£—á–µ–Ω–∏–∫:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–¢–µ–º–∞:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        {% set tz_name = (current_user.profile.timezone if current_user.profile and current_user.profile.timezone else 'Europe/Moscow') %}
        {% set active_local = (active_lesson.lesson_date|to_tz(tz_name)) %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–î–∞—Ç–∞:</strong> {{ active_local.strftime('%d.%m.%Y %H:%M') if active_local else '‚Äî' }}</p>
        <p style="margin: 0;"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ active_lesson.duration }} –º–∏–Ω—É—Ç</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lessons.lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ó–∞–≤–µ—Ä—à–∏—Ç—å" class="ui-icon ui-icon--sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </form>
            <a href="{{ url_for('students.student_profile', student_id=active_student.student_id) }}" class="neo-button ghost"><img src="{{ url_for('static', filename='icons/icons8-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-100.png') }}" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="ui-icon ui-icon--sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('lessonMenu');
            const badge = document.querySelector('.now-playing-pill');
            if (!menu || !badge) return;
            if (!menu.contains(event.target) && !badge.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
    {% endif %}

    <div class="app-shell">
        {% set active_page = 'dashboard' %}
        {% include '_primary_nav.html' %}

        {# Flash messages –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —á–µ—Ä–µ–∑ toast #}

        <section class="glass-panel student-context">
            <h3><img src="{{ url_for('static', filename='icons/icons8-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-100.png') }}" alt="–£—á–µ–Ω–∏–∫" class="ui-icon ui-icon--sm"> –£—á–µ–Ω–∏–∫: {{ student.name }}</h3>
            <a href="{{ url_for('students.student_profile', student_id=student.student_id) }}" class="neo-button ghost">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
        </section>

        <section class="glass-panel form-hero">
            <div>
                <p class="hero-eyebrow">—Ñ–æ—Ä–º–∞ —É—Ä–æ–∫–∞</p>
                <h1 class="hero-title">{{ title }}</h1>
            </div>
        </section>

        {% if form.errors %}
        <section class="glass-panel" style="border-left: 4px solid var(--danger);">
            <div style="background: rgba(255, 108, 145, 0.12); border-left: 3px solid var(--danger); border-radius: var(--radius-sm); padding: 1rem; color: var(--danger);">
                <strong style="display: block; margin-bottom: 0.5rem;">‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã:</strong>
                <ul style="margin: 0.5em 0 0 1.5em; list-style: disc;">
                {% for field_name, error_list in form.errors.items() %}
                    {% for error in error_list %}
                    <li>{{ field_name }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                </ul>
            </div>
        </section>
        {% endif %}

        <form method="POST">
            {{ form.hidden_tag() }}
            
            <section class="form-section">
                <div class="form-section-title"><img src="{{ url_for('static', filename='icons/schedule_white.png') }}" alt="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" class="ui-icon ui-icon--sm"> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="form-grid">
                    <div class="neo-field">
                        {{ form.lesson_type.label(class='neo-label') }}
                        {{ form.lesson_type(class='neo-select') }}
                        {% if form.lesson_type.errors %}
                            <div class="field-error">{{ form.lesson_type.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Ä–æ–∫–∞ (–æ–±—ã—á–Ω—ã–π, –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∏–ª–∏ –≤–≤–æ–¥–Ω—ã–π)</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.timezone.label(class='neo-label') }}
                        {{ form.timezone(class='neo-select') }}
                        {% if form.timezone.errors %}
                            <div class="field-error">{{ form.timezone.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —É—Ä–æ–∫–∞</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.lesson_date.label(class='neo-label') }}
                        {{ form.lesson_date(class='neo-input') }}
                        {% if form.lesson_date.errors %}
                            <div class="field-error">{{ form.lesson_date.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É—Ä–æ–∫–∞ (–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ)</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.duration.label(class='neo-label') }}
                        {{ form.duration(class='neo-input', placeholder='60') }}
                        {% if form.duration.errors %}
                            <div class="field-error">{{ form.duration.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.status.label(class='neo-label') }}
                        {{ form.status(class='neo-select') }}
                        {% if form.status.errors %}
                            <div class="field-error">{{ form.status.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —É—Ä–æ–∫–∞</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-section-title"><img src="{{ url_for('static', filename='icons/icons8-–¥–æ–∫—É–º–µ–Ω—Ç-100.png') }}" alt="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" class="ui-icon ui-icon--sm"> –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞</div>
                <div class="form-grid">
                    <div class="neo-field form-grid-full">
                        {{ form.topic.label(class='neo-label') }}
                        {{ form.topic(class='neo-input', placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–≥–æ—Ä–∏—Ç–º—ã, –∑–∞–¥–∞–Ω–∏—è 19-21') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–¢–µ–º–∞ –∏–ª–∏ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–∑—É—á–µ–Ω—ã</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.notes.label(class='neo-label') }}
                        {{ form.notes(class='neo-input', placeholder='–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —É—Ä–æ–∫–µ...', rows=4) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ó–∞–º–µ—Ç–∫–∏ –æ —Ö–æ–¥–µ —É—Ä–æ–∫–∞, —É—Å–ø–µ—Ö–∞—Ö, –ø—Ä–æ–±–ª–µ–º–∞—Ö</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section" data-section="homework">
                <div class="form-section-title">üìã –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
                <div class="form-grid">
                    <div class="neo-field form-grid-full">
                        {{ form.homework.label(class='neo-label') }}
                        {{ form.homework(class='neo-input', placeholder='–ß—Ç–æ –∑–∞–¥–∞–Ω–æ –Ω–∞ –¥–æ–º...', rows=4) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.homework_status.label(class='neo-label') }}
                        {{ form.homework_status(class='neo-select') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-actions" style="display: flex; gap: 1em; justify-content: flex-end; margin-top: 0;">
                    {% if is_new %}
                    <button type="submit" class="neo-button outline" name="next" value="homework">–°–æ–∑–¥–∞—Ç—å ‚Üí –î–ó</button>
                    <button type="submit" class="neo-button outline" name="next" value="classwork">–°–æ–∑–¥–∞—Ç—å ‚Üí –ö–†</button>
                    <button type="submit" class="neo-button outline" name="next" value="exam">–°–æ–∑–¥–∞—Ç—å ‚Üí –ü—Ä–æ–≤–µ—Ä.</button>
                    {% endif %}
                    {{ form.submit(class='neo-button accent') }}
                    <a href="{{ url_for('students.student_profile', student_id=student.student_id) }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </section>
        </form>
        
        {% if not is_new %}
        <section class="tasks-preview">
            <div class="tasks-preview-header">
                <div class="tasks-preview-title"><img src="{{ url_for('static', filename='icons/icons8-–¥–æ–∫—É–º–µ–Ω—Ç-100.png') }}" alt="–î–ó" class="ui-icon ui-icon--sm"> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
                <div style="display:flex; gap:.6rem; flex-wrap: wrap; align-items:center;">
                    <a href="{{ url_for('assignments.assignment_create', source='lesson', lesson_id=lesson.lesson_id, assignment_type='homework') }}" class="neo-button accent" style="text-decoration:none;">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É
                    </a>
                    <a href="{{ url_for('lessons.lesson_homework_view', lesson_id=lesson.lesson_id) }}" class="neo-button outline">
                        –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí
                    </a>
                </div>
            </div>
            
            {% if homework_tasks %}
            <div>
                {% for hw_task in homework_tasks[:5] %}
                <div class="task-preview-card">
                    <div class="task-preview-header">
                        <div>
                            <span class="task-preview-number">–ó–∞–¥–∞–Ω–∏–µ {{ hw_task.task.task_number }}</span>
                            <span style="color: var(--text-muted); font-size: 0.9em; margin-left: 0.5em;">‚Ññ {{ hw_task.task.site_task_id }}</span>
                        </div>
                        <a href="{{ hw_task.task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.85em; padding: 0.4em 0.8em;">üîó –û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                    {% if hw_task.task.content_html %}
                    <div class="task-preview-content">
                        {{ hw_task.task.content_html|safe }}
                    </div>
                    {% endif %}
                    {% if hw_task.student_answer %}
                    <div class="task-preview-answer">
                        <strong>–û—Ç–≤–µ—Ç:</strong> {{ hw_task.student_answer }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if homework_tasks|length > 5 %}
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9em; margin-top: 1em;">
                    –ò –µ—â–µ {{ homework_tasks|length - 5 }} –∑–∞–¥–∞–Ω–∏–π...
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); text-align: center; padding: 2em;">–ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</p>
            {% endif %}
        </section>
        
        <section class="tasks-preview">
            <div class="tasks-preview-header">
                <div class="tasks-preview-title"><img src="{{ url_for('static', filename='icons/icons8-—à–∫–æ–ª–∞-100.png') }}" alt="–ö–ª–∞—Å—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞" class="ui-icon ui-icon--sm"> –ö–ª–∞—Å—Å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</div>
                <div style="display:flex; gap:.6rem; flex-wrap: wrap; align-items:center;">
                    <a href="{{ url_for('assignments.assignment_create', source='lesson', lesson_id=lesson.lesson_id, assignment_type='classwork') }}" class="neo-button accent" style="text-decoration:none;">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É
                    </a>
                    <a href="{{ url_for('lessons.lesson_classwork_view', lesson_id=lesson.lesson_id) }}" class="neo-button outline">
                        –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí
                    </a>
                </div>
            </div>
            
            {% if classwork_tasks %}
            <div>
                {% for cw_task in classwork_tasks[:5] %}
                <div class="task-preview-card">
                    <div class="task-preview-header">
                        <div>
                            <span class="task-preview-number">–ó–∞–¥–∞–Ω–∏–µ {{ cw_task.task.task_number }}</span>
                            <span style="color: var(--text-muted); font-size: 0.9em; margin-left: 0.5em;">‚Ññ {{ cw_task.task.site_task_id }}</span>
                        </div>
                        <a href="{{ cw_task.task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.85em; padding: 0.4em 0.8em;">üîó –û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                    {% if cw_task.task.content_html %}
                    <div class="task-preview-content">
                        {{ cw_task.task.content_html|safe }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if classwork_tasks|length > 5 %}
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9em; margin-top: 1em;">
                    –ò –µ—â–µ {{ classwork_tasks|length - 5 }} –∑–∞–¥–∞–Ω–∏–π...
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); text-align: center; padding: 2em;">–ù–µ—Ç –∫–ª–∞—Å—Å–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
            {% endif %}
        </section>
        {% endif %}
    </div>
    
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { // –ü—Ä—è—á–µ–º –±–ª–æ–∫ –î–ó –¥–ª—è –≤–≤–æ–¥–Ω–æ–≥–æ —É—Ä–æ–∫–∞
            const typeSelect = document.getElementById('lesson_type');
            // –ò—â–µ–º —Å–µ–∫—Ü–∏—é –î–ó –ø–æ data-section="homework" - —ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–∫—Ü–∏—è —Å –¥–æ–º–∞—à–Ω–∏–º –∑–∞–¥–∞–Ω–∏–µ–º
            const homeworkSection = document.querySelector('section[data-section="homework"]');
            const homeworkField = document.getElementById('homework');
            const homeworkStatusField = document.getElementById('homework_status');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è –î–ó –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            if (!typeSelect) return;
            if (!homeworkSection || !homeworkStatusField) {
                console.warn('–°–µ–∫—Ü–∏—è –î–ó –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–∫—Ä—ã—Ç–∏—è –î–ó –¥–ª—è –≤–≤–æ–¥–Ω–æ–≥–æ —É—Ä–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }

            let lastAssignedStatus = homeworkStatusField.value !== 'not_assigned'
                ? homeworkStatusField.value
                : 'assigned_not_done';

            function syncHomeworkVisibility() {
                const isIntroductory = typeSelect.value === 'introductory';
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Å–µ–∫—Ü–∏—é –î–ó, –Ω–µ —Ç—Ä–æ–≥–∞—è –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ü–∏–∏
                if (isIntroductory) {
                    homeworkSection.style.display = 'none';
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –î–ó –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–≤–æ–¥–Ω–æ–≥–æ —É—Ä–æ–∫–∞
                    if (homeworkField) homeworkField.value = '';
                    if (homeworkStatusField.value !== 'not_assigned') {
                        lastAssignedStatus = homeworkStatusField.value;
                    }
                    homeworkStatusField.value = 'not_assigned';
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –î–ó –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞ —É—Ä–æ–∫–∞
                    homeworkSection.style.display = '';
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –±—ã–ª 'not_assigned'
                    if (homeworkStatusField.value === 'not_assigned' && lastAssignedStatus !== 'not_assigned') {
                        homeworkStatusField.value = lastAssignedStatus;
                    }
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            syncHomeworkVisibility();
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —É—Ä–æ–∫–∞
            typeSelect.addEventListener('change', syncHomeworkVisibility);
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    trust: true
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
    <script>
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º flash-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'error' or category == 'danger' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.error('{{ message|e }}');
                            }
                        {% elif category == 'warning' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.warning('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.warning('{{ message|e }}');
                            }
                        {% elif category == 'info' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.info('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.info('{{ message|e }}');
                            }
                        {% else %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.success('{{ message|e }}');
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>
