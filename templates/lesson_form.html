<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} ¬∑ {{ student.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .form-hero {
            margin-bottom: 2rem;
        }
        
        .form-section {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--stroke-1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .form-grid-full {
            grid-column: 1 / -1;
        }
        
        .student-context {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .student-context h3 {
            color: var(--text-primary);
            margin: 0;
            font-weight: 700;
        }
        
        .tasks-preview {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .tasks-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .tasks-preview-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .task-preview-card {
            background: var(--surface-2);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .task-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .task-preview-number {
            font-weight: 700;
            color: var(--accent-1);
        }
        
        .task-preview-content {
            margin-top: 0.8em;
            padding: 0.8em;
            background: var(--surface-3);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .task-preview-answer {
            margin-top: 0.5em;
            padding: 0.5em;
            background: rgba(0, 254, 202, 0.12);
            border-left: 3px solid var(--success);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
        }
    </style>
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        üéß –£—Ä–æ–∫ –∏–¥–µ—Ç: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">—Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>–£—á–µ–Ω–∏–∫:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–¢–µ–º–∞:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–î–∞—Ç–∞:</strong> {{ active_lesson.lesson_date.strftime('%d.%m.%Y %H:%M') }}</p>
        <p style="margin: 0;"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ active_lesson.duration }} –º–∏–Ω—É—Ç</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </form>
            <a href="{{ url_for('student_profile', student_id=active_student.student_id) }}" class="neo-button ghost">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('lessonMenu');
            const badge = document.querySelector('.now-playing-pill');
            if (!menu || !badge) return;
            if (!menu.contains(event.target) && !badge.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
    {% endif %}

    <div class="app-shell">
        <header class="nav-primary">
            <div class="nav-brand">
                <div class="brand-mark">LOGO</div>
                <div class="brand-caption">–°–ª–æ—Ç –ø–æ–¥ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –∑–Ω–∞–∫</div>
            </div>
            <nav class="nav-links">
                <a href="{{ url_for('dashboard') }}" class="nav-link">üë• –£—á–µ–Ω–∏–∫–∏</a>
                <a href="{{ url_for('schedule') }}" class="nav-link">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
                <a href="{{ url_for('kege_generator') }}" class="nav-link">üíª –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
                <a href="{{ url_for('update_plans') }}" class="nav-link">üìã –ü–ª–∞–Ω—ã</a>
            </nav>
            <div class="nav-actions">
                <div class="brand-caption">icon slot</div>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <section class="glass-panel student-context">
            <h3>üë§ –£—á–µ–Ω–∏–∫: {{ student.name }}</h3>
            <a href="{{ url_for('student_profile', student_id=student.student_id) }}" class="neo-button ghost">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
        </section>

        <section class="glass-panel form-hero">
            <div>
                <p class="hero-eyebrow">—Ñ–æ—Ä–º–∞ —É—Ä–æ–∫–∞</p>
                <h1 class="hero-title">{{ title }}</h1>
            </div>
        </section>

        {% if form.errors %}
        <section class="glass-panel">
            <div class="alert alert-danger">
                <strong>–û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã:</strong>
                <ul style="margin: 0.5em 0 0 1.5em;">
                {% for field_name, error_list in form.errors.items() %}
                    {% for error in error_list %}
                    <li>{{ field_name }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                </ul>
            </div>
        </section>
        {% endif %}

        <form method="POST">
            {{ form.hidden_tag() }}
            
            <section class="form-section">
                <div class="form-section-title">üìÖ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="form-grid">
                    <div class="neo-field">
                        {{ form.lesson_type.label(class='neo-label') }}
                        {{ form.lesson_type(class='neo-select') }}
                        {% if form.lesson_type.errors %}
                            <div class="alert alert-danger" style="margin-top: 0.5em;">{{ form.lesson_type.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Ä–æ–∫–∞ (–æ–±—ã—á–Ω—ã–π, –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∏–ª–∏ –≤–≤–æ–¥–Ω—ã–π)</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.lesson_date.label(class='neo-label') }}
                        {{ form.lesson_date(class='neo-input') }}
                        {% if form.lesson_date.errors %}
                            <div class="alert alert-danger" style="margin-top: 0.5em;">{{ form.lesson_date.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É—Ä–æ–∫–∞</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.duration.label(class='neo-label') }}
                        {{ form.duration(class='neo-input', placeholder='60') }}
                        {% if form.duration.errors %}
                            <div class="alert alert-danger" style="margin-top: 0.5em;">{{ form.duration.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.status.label(class='neo-label') }}
                        {{ form.status(class='neo-select') }}
                        {% if form.status.errors %}
                            <div class="alert alert-danger" style="margin-top: 0.5em;">{{ form.status.errors[0] }}</div>
                        {% endif %}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —É—Ä–æ–∫–∞</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-section-title">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞</div>
                <div class="form-grid">
                    <div class="neo-field form-grid-full">
                        {{ form.topic.label(class='neo-label') }}
                        {{ form.topic(class='neo-input', placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–≥–æ—Ä–∏—Ç–º—ã, –∑–∞–¥–∞–Ω–∏—è 19-21') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–¢–µ–º–∞ –∏–ª–∏ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–∑—É—á–µ–Ω—ã</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.notes.label(class='neo-label') }}
                        {{ form.notes(class='neo-input', placeholder='–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —É—Ä–æ–∫–µ...', rows=4) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ó–∞–º–µ—Ç–∫–∏ –æ —Ö–æ–¥–µ —É—Ä–æ–∫–∞, —É—Å–ø–µ—Ö–∞—Ö, –ø—Ä–æ–±–ª–µ–º–∞—Ö</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-section-title">üìã –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
                <div class="form-grid">
                    <div class="neo-field form-grid-full">
                        {{ form.homework.label(class='neo-label') }}
                        {{ form.homework(class='neo-input', placeholder='–ß—Ç–æ –∑–∞–¥–∞–Ω–æ –Ω–∞ –¥–æ–º...', rows=4) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.homework_status.label(class='neo-label') }}
                        {{ form.homework_status(class='neo-select') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-actions" style="display: flex; gap: 1em; justify-content: flex-end; margin-top: 0;">
                    {{ form.submit(class='neo-button accent') }}
                    <a href="{{ url_for('student_profile', student_id=student.student_id) }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </section>
        </form>
        
        {% if not is_new %}
        <section class="tasks-preview">
            <div class="tasks-preview-header">
                <div class="tasks-preview-title">üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
                <a href="{{ url_for('lesson_homework_view', lesson_id=lesson.lesson_id) }}" class="neo-button outline">
                    –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí
                </a>
            </div>
            
            {% if homework_tasks %}
            <div>
                {% for hw_task in homework_tasks[:5] %}
                <div class="task-preview-card">
                    <div class="task-preview-header">
                        <div>
                            <span class="task-preview-number">–ó–∞–¥–∞–Ω–∏–µ {{ hw_task.task.task_number }}</span>
                            <span style="color: var(--text-muted); font-size: 0.9em; margin-left: 0.5em;">‚Ññ {{ hw_task.task.site_task_id }}</span>
                        </div>
                        <a href="{{ hw_task.task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.85em; padding: 0.4em 0.8em;">üîó –û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                    {% if hw_task.task.content_html %}
                    <div class="task-preview-content">
                        {{ hw_task.task.content_html|safe }}
                    </div>
                    {% endif %}
                    {% if hw_task.student_answer %}
                    <div class="task-preview-answer">
                        <strong>–û—Ç–≤–µ—Ç:</strong> {{ hw_task.student_answer }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if homework_tasks|length > 5 %}
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9em; margin-top: 1em;">
                    –ò –µ—â–µ {{ homework_tasks|length - 5 }} –∑–∞–¥–∞–Ω–∏–π...
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); text-align: center; padding: 2em;">–ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</p>
            {% endif %}
        </section>
        
        <section class="tasks-preview">
            <div class="tasks-preview-header">
                <div class="tasks-preview-title">üè´ –ö–ª–∞—Å—Å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</div>
                <a href="{{ url_for('lesson_classwork_view', lesson_id=lesson.lesson_id) }}" class="neo-button outline">
                    –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí
                </a>
            </div>
            
            {% if classwork_tasks %}
            <div>
                {% for cw_task in classwork_tasks[:5] %}
                <div class="task-preview-card">
                    <div class="task-preview-header">
                        <div>
                            <span class="task-preview-number">–ó–∞–¥–∞–Ω–∏–µ {{ cw_task.task.task_number }}</span>
                            <span style="color: var(--text-muted); font-size: 0.9em; margin-left: 0.5em;">‚Ññ {{ cw_task.task.site_task_id }}</span>
                        </div>
                        <a href="{{ cw_task.task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.85em; padding: 0.4em 0.8em;">üîó –û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                    {% if cw_task.task.content_html %}
                    <div class="task-preview-content">
                        {{ cw_task.task.content_html|safe }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if classwork_tasks|length > 5 %}
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9em; margin-top: 1em;">
                    –ò –µ—â–µ {{ classwork_tasks|length - 5 }} –∑–∞–¥–∞–Ω–∏–π...
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); text-align: center; padding: 2em;">–ù–µ—Ç –∫–ª–∞—Å—Å–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
            {% endif %}
        </section>
        {% endif %}
    </div>
    
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    trust: true
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
</body>
</html>
