<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è{% if task_type %}: –ó–∞–¥–∞–Ω–∏–µ {{ task_type }}{% endif %} ¬∑ –ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='katex/katex/katex.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    <script defer src="{{ url_for('static', filename='katex/katex/katex.min.js') }}"></script>
    <script defer src="{{ url_for('static', filename='katex/katex/contrib/auto-render.min.js') }}"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% include '_active_lesson_banner.html' %}
    
    <div class="app-shell">
        {% set active_page = active_page | default('generator') %}
        {% include '_primary_nav.html' %}

        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display:flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                <div>
                <p class="hero-eyebrow">–ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è</p>
                <h1 class="hero-title"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ü—Ä–∏–Ω—è—Ç–æ" class="ui-icon ui-icon--sm">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è{% if task_type %}: –ó–∞–¥–∞–Ω–∏–µ {{ task_type }}{% endif %}</h1>
                <p class="hero-subtitle">–í—Å–µ–≥–æ: {{ tasks|length }} —à—Ç.</p>
            </div>
                <div class="hero-actions" style="margin-top: 0;">
                    {% if current_user.is_authenticated and has_permission(current_user, 'assignment.create') %}
                    <a class="neo-button accent" style="text-decoration:none;" href="{{ url_for('assignments.assignment_create', source='accepted', assignment_type=assignment_type, task_type=task_type) }}">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É ({{ tasks|length }})
                    </a>
                    {% endif %}
                    <form method="POST" action="{{ clear_accepted_url | default(url_for('kege_generator.clear_accepted')) }}" style="display:inline-flex; gap:.5rem; align-items:center;" onsubmit="return confirmAcceptedClear();">
                        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                        {% if task_type %}<input type="hidden" name="task_type" value="{{ task_type }}">{% endif %}
                        <button type="submit" class="neo-button ghost" style="color: var(--danger);">
                            üßπ –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–Ω—è—Ç—ã–µ{% if task_type %} (—Ç–∏–ø {{ task_type }}){% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </section>

        {# Flash messages –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —á–µ—Ä–µ–∑ toast #}

        <section class="glass-panel filters-panel">
            <div class="neo-field">
                <label class="neo-label" for="task-type-filter">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–¥–∞–Ω–∏—è</label>
                <select id="task-type-filter" class="neo-select" onchange="filterByTaskType(this.value)">
                    <option value="">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è</option>
                    {% for i in range(1, 28) %}
                        <option value="{{ i }}" {% if task_type == i %}selected{% endif %}>–ó–∞–¥–∞–Ω–∏–µ {{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </section>

        {# –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —É–¥–∞–ª–µ–Ω–∞: –µ–¥–∏–Ω—ã–π –º–∞—Å—Ç–µ—Ä —Ç–µ–ø–µ—Ä—å –Ω–∞ /assignments/create #}

        {% if tasks %}
        <div>
            {% for task in tasks %}
            <section class="glass-panel task-card" data-task-id="{{ task.task_id }}" style="margin-bottom: 2rem;">
                <div class="task-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--stroke-1);">
                    <div>
                        <b style="color: var(--text-primary);">‚Ññ {{ task.site_task_id if task.site_task_id else task.task_id }}</b>
                        <span style="color: var(--text-muted); margin: 0 0.5em;">|</span>
                        <a href="{{ task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.9em; padding: 0.4em 0.8em;"><img src="{{ url_for('static', filename='icons/lupa.png') }}" alt="–ò—Å—Ç–æ—á–Ω–∏–∫" class="ui-icon ui-icon--sm">–ò—Å—Ç–æ—á–Ω–∏–∫</a>
                    </div>
                    <span class="neo-button accent" style="font-size: 0.85em; padding: 0.4em 0.8em; cursor: default;"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ü—Ä–∏–Ω—è—Ç–æ" class="ui-icon ui-icon--sm">–ü–†–ò–ù–Ø–¢–û</span>
                </div>
                
                <div class="task-content" style="line-height: 1.8; font-size: 1.05em; color: var(--text-primary); margin-bottom: 1.5rem;">
                    {{ task.content_html | safe }}
                </div>
                
                {% if task.attached_files %}
                <div class="attached-files" style="background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-weight: 600; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em;">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h4>
                    <ul class="file-list" style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        {% set files = task.attached_files | from_json %}
                        {% for file in files %}
                        <li>
                            <a href="{{ file.url }}" target="_blank" class="neo-button outline" style="font-size: 0.9rem; padding: 0.65rem 1.2rem; text-decoration: none;" download>
                                {{ file.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </section>
            {% endfor %}
        </div>
        {% else %}
        <section class="glass-panel">
            <div class="empty-state">
                <div class="empty-state-icon">‚úì</div>
                <h3 class="empty-state-title">–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–¥–∞–Ω–∏–π</h3>
                <p class="empty-state-description">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                <div class="empty-state-actions">
                    <a href="{{ back_url | default(url_for('kege_generator.kege_generator')) }}" class="neo-button accent"><img src="{{ url_for('static', filename='icons/generator_white-no-bg-preview (carve.photos).png') }}" alt="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä" class="ui-icon ui-icon--sm">–ù–∞–∑–∞–¥</a>
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    trust: true
                });
            }
        });
        
        function filterByTaskType(taskType) {
            if (taskType === '') {
                window.location.href = '{{ accepted_base_url | default(url_for('kege_generator.show_accepted', assignment_type=assignment_type)) }}';
            } else {
                window.location.href = '{{ accepted_base_url | default(url_for('kege_generator.show_accepted', assignment_type=assignment_type)) }}?task_type=' + taskType;
            }
        }

        function confirmAcceptedClear() {
            const total = {{ (tasks|length) if tasks is defined else 0 }};
            const typePart = {% if task_type %}'—Ç–∏–ø–∞ {{ task_type }}'{% else %}'–≤—Å–µ—Ö —Ç–∏–ø–æ–≤'{% endif %};
            return window.confirm('–û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è ' + typePart + '?\\n\\n–°–µ–π—á–∞—Å –≤ —Å–ø–∏—Å–∫–µ: ' + total + ' —à—Ç.\\n–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');
        }
    </script>
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
    <script>
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º flash-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'error' or category == 'danger' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.error('{{ message|e }}');
                            }
                        {% elif category == 'warning' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.warning('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.warning('{{ message|e }}');
                            }
                        {% elif category == 'info' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.info('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.info('{{ message|e }}');
                            }
                        {% else %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.success('{{ message|e }}');
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>

    {# –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –µ–¥–∏–Ω—ã–π –º–∞—Å—Ç–µ—Ä /assignments/create #}
</body>
</html>
