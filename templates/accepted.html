<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è{% if task_type %}: –ó–∞–¥–∞–Ω–∏–µ {{ task_type }}{% endif %} ¬∑ –ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='katex/katex/katex.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    <script defer src="{{ url_for('static', filename='katex/katex/katex.min.js') }}"></script>
    <script defer src="{{ url_for('static', filename='katex/katex/contrib/auto-render.min.js') }}"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% include '_active_lesson_banner.html' %}
    
    <div class="app-shell">
        {% set active_page = 'generator' %}
        {% include '_primary_nav.html' %}

        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display:flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                <div>
                <p class="hero-eyebrow">–ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è</p>
                <h1 class="hero-title"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ü—Ä–∏–Ω—è—Ç–æ" class="ui-icon ui-icon--sm">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è{% if task_type %}: –ó–∞–¥–∞–Ω–∏–µ {{ task_type }}{% endif %}</h1>
                <p class="hero-subtitle">–í—Å–µ–≥–æ: {{ tasks|length }} —à—Ç.</p>
            </div>
                <div class="hero-actions" style="margin-top: 0;">
                    {% if current_user.is_authenticated and has_permission(current_user, 'assignment.create') %}
                    <button type="button" class="neo-button accent" onclick="openCreateAssignmentFromAccepted()">
                        üìù –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É ({{ tasks|length }})
                    </button>
                    {% endif %}
                </div>
            </div>
        </section>

        {# Flash messages –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —á–µ—Ä–µ–∑ toast #}

        <section class="glass-panel filters-panel">
            <div class="neo-field">
                <label class="neo-label" for="task-type-filter">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–¥–∞–Ω–∏—è</label>
                <select id="task-type-filter" class="neo-select" onchange="filterByTaskType(this.value)">
                    <option value="">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è</option>
                    {% for i in range(1, 28) %}
                        <option value="{{ i }}" {% if task_type == i %}selected{% endif %}>–ó–∞–¥–∞–Ω–∏–µ {{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </section>

        {% if current_user.is_authenticated and has_permission(current_user, 'assignment.create') %}
        <!-- Modal: Create Assignment from accepted -->
        <div class="modal-overlay" id="createAssignmentModal" style="display:none; align-items:center; justify-content:center; padding: 2rem; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 1200; backdrop-filter: blur(4px);">
            <div class="glass-panel" style="width: 100%; max-width: 720px; border-radius: var(--radius-lg);">
                <div style="display:flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                    <div>
                        <p class="hero-eyebrow">—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</p>
                        <h2 style="margin: .25rem 0 0 0;">–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É –∏–∑ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–¥–∞–Ω–∏–π</h2>
                        <div style="color: var(--text-muted); margin-top: .5rem; line-height: 1.45;">
                            –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—á–µ–Ω–∏–∫–∞–º. –ó–∞–¥–∞–Ω–∏–π: <strong id="ca_task_count">{{ tasks|length }}</strong>.
                        </div>
                    </div>
                    <button type="button" class="neo-button ghost" onclick="closeCreateAssignmentModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
                </div>

                <form id="createAssignmentForm" style="margin-top: 1.25rem;">
                    <div class="neo-field">
                        <label class="neo-label" for="ca_title">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input id="ca_title" class="neo-input" name="title" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–ó ¬∑ –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è">
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .9rem; margin-top: .9rem;">
                        <div class="neo-field">
                            <label class="neo-label" for="ca_type">–¢–∏–ø</label>
                            <select id="ca_type" class="neo-select" name="type">
                                <option value="homework">–î–ó</option>
                                <option value="classwork">–ö–†</option>
                                <option value="exam">–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è</option>
                            </select>
                        </div>
                        <div class="neo-field">
                            <label class="neo-label" for="ca_deadline">–î–µ–¥–ª–∞–π–Ω *</label>
                            <input id="ca_deadline" class="neo-input" type="datetime-local" name="deadline" required>
                        </div>
                    </div>

                    <div class="neo-field" style="margin-top: .9rem;">
                        <label class="neo-label" for="ca_recipients">–ö–æ–º—É –Ω–∞–∑–Ω–∞—á–∏—Ç—å</label>
                        <select id="ca_recipients" class="neo-select" name="recipients" multiple size="8" style="min-height: 220px;">
                            {% for st in (recipient_options or []) %}
                                <option value="{{ st.student_id }}">{{ st.name }}{% if st.platform_id %} ¬∑ {{ st.platform_id }}{% endif %}</option>
                            {% endfor %}
                        </select>
                        <div style="display:flex; gap:.6rem; flex-wrap: wrap; margin-top: .6rem;">
                            <button type="button" class="neo-button ghost sm" onclick="selectAllRecipients(true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
                            <button type="button" class="neo-button ghost sm" onclick="selectAllRecipients(false)">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                        </div>
                        <div style="color: var(--text-muted); font-size: .9rem; margin-top: .4rem;">
                            –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî —É —Ç—å—é—Ç–æ—Ä–∞ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–∏–ª–∏—Å—å —É—á–µ–Ω–∏–∫–∏ (–ø–æ—á–∏–Ω–∏–ª –º–∞–ø–ø–∏–Ω–≥, –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è).
                        </div>
                    </div>

                    <div style="display:flex; gap:.75rem; justify-content:flex-end; flex-wrap: wrap; margin-top: 1.25rem;">
                        <button type="button" class="neo-button ghost" onclick="closeCreateAssignmentModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="neo-button accent" id="ca_submit_btn">–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                    </div>
                </form>
            </div>
        </div>

        <script type="application/json" id="accepted-task-ids-data">{{ tasks|map(attribute='task_id')|list|tojson }}</script>
        {% endif %}

        {% if tasks %}
        <div>
            {% for task in tasks %}
            <section class="glass-panel task-card" data-task-id="{{ task.task_id }}" style="margin-bottom: 2rem;">
                <div class="task-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--stroke-1);">
                    <div>
                        <b style="color: var(--text-primary);">‚Ññ {{ task.site_task_id if task.site_task_id else task.task_id }}</b>
                        <span style="color: var(--text-muted); margin: 0 0.5em;">|</span>
                        <a href="{{ task.source_url }}" target="_blank" class="neo-button ghost" style="font-size: 0.9em; padding: 0.4em 0.8em;"><img src="{{ url_for('static', filename='icons/lupa.png') }}" alt="–ò—Å—Ç–æ—á–Ω–∏–∫" class="ui-icon ui-icon--sm">–ò—Å—Ç–æ—á–Ω–∏–∫</a>
                    </div>
                    <span class="neo-button accent" style="font-size: 0.85em; padding: 0.4em 0.8em; cursor: default;"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ü—Ä–∏–Ω—è—Ç–æ" class="ui-icon ui-icon--sm">–ü–†–ò–ù–Ø–¢–û</span>
                </div>
                
                <div class="task-content" style="line-height: 1.8; font-size: 1.05em; color: var(--text-primary); margin-bottom: 1.5rem;">
                    {{ task.content_html | safe }}
                </div>
                
                {% if task.attached_files %}
                <div class="attached-files" style="background: var(--surface-2); border: 1px solid var(--stroke-1); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-weight: 600; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em;">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h4>
                    <ul class="file-list" style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        {% set files = task.attached_files | from_json %}
                        {% for file in files %}
                        <li>
                            <a href="{{ file.url }}" target="_blank" class="neo-button outline" style="font-size: 0.9rem; padding: 0.65rem 1.2rem; text-decoration: none;" download>
                                {{ file.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </section>
            {% endfor %}
        </div>
        {% else %}
        <section class="glass-panel">
            <div class="empty-state">
                <div class="empty-state-icon">‚úì</div>
                <h3 class="empty-state-title">–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–¥–∞–Ω–∏–π</h3>
                <p class="empty-state-description">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                <div class="empty-state-actions">
                    <a href="{{ url_for('kege_generator.kege_generator') }}" class="neo-button accent"><img src="{{ url_for('static', filename='icons/generator_white-no-bg-preview (carve.photos).png') }}" alt="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä" class="ui-icon ui-icon--sm">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É</a>
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    trust: true
                });
            }
        });
        
        function filterByTaskType(taskType) {
            if (taskType === '') {
                window.location.href = '{{ url_for('kege_generator.show_accepted', assignment_type=assignment_type) }}';
            } else {
                window.location.href = '{{ url_for('kege_generator.show_accepted', assignment_type=assignment_type) }}?task_type=' + taskType;
            }
        }
    </script>
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
    <script>
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º flash-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'error' or category == 'danger' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.error('{{ message|e }}');
                            }
                        {% elif category == 'warning' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.warning('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.warning('{{ message|e }}');
                            }
                        {% elif category == 'info' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.info('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.info('{{ message|e }}');
                            }
                        {% else %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.success('{{ message|e }}');
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>

    {% if current_user.is_authenticated and has_permission(current_user, 'assignment.create') %}
    <script>
        const ASSIGNMENTS_DISTRIBUTE_URL = "{{ url_for('assignments.distribute_assignment') }}";
        const ASSIGNMENTS_LIST_URL = "{{ url_for('assignments.assignments_list') }}";
        const ASSIGNMENT_VIEW_URL_TPL = "{{ url_for('assignments.assignment_view', assignment_id=0) }}";
        const CSRF_TOKEN = (document.querySelector('meta[name=\"csrf-token\"]') || {getAttribute: () => null}).getAttribute('content') || '';

        function getAcceptedTaskIds() {
            try {
                const el = document.getElementById('accepted-task-ids-data');
                if (!el) return [];
                const ids = JSON.parse(el.textContent || '[]');
                return Array.isArray(ids) ? ids.map(x => parseInt(x, 10)).filter(n => Number.isFinite(n)) : [];
            } catch (e) {
                return [];
            }
        }

        function openCreateAssignmentFromAccepted() {
            const ids = getAcceptedTaskIds();
            document.getElementById('ca_task_count').textContent = String(ids.length);

            const typeEl = document.getElementById('ca_type');
            const titleEl = document.getElementById('ca_title');
            const deadlineEl = document.getElementById('ca_deadline');
            const submitBtn = document.getElementById('ca_submit_btn');

            if (typeEl) typeEl.value = "{{ assignment_type or 'homework' }}";
            if (titleEl) {
                const prefix = ("{{ assignment_type or 'homework' }}" === 'classwork') ? '–ö–†' : (("{{ assignment_type or 'homework' }}" === 'exam') ? '–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è' : '–î–ó');
                titleEl.value = `${prefix} ¬∑ –ø—Ä–∏–Ω—è—Ç—ã–µ (${ids.length})`;
            }
            if (deadlineEl) {
                const d = new Date();
                d.setDate(d.getDate() + 1);
                d.setHours(23, 59, 0, 0);
                const pad = (n) => String(n).padStart(2, '0');
                deadlineEl.value = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }

            const modal = document.getElementById('createAssignmentModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeCreateAssignmentModal() {
            const modal = document.getElementById('createAssignmentModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function selectAllRecipients(flag) {
            const sel = document.getElementById('ca_recipients');
            if (!sel) return;
            Array.from(sel.options).forEach(o => { o.selected = !!flag; });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // /accepted?create=1 ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
            try {
                const params = new URLSearchParams(window.location.search || '');
                if (params.get('create') === '1') {
                    openCreateAssignmentFromAccepted();
                    params.delete('create');
                    const next = window.location.pathname + (params.toString() ? `?${params.toString()}` : '') + (window.location.hash || '');
                    window.history.replaceState({}, '', next);
                }
            } catch (e) {}

            const modal = document.getElementById('createAssignmentModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeCreateAssignmentModal();
                });
            }

            const form = document.getElementById('createAssignmentForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const ids = getAcceptedTaskIds();
                    const submitBtn = document.getElementById('ca_submit_btn');
                    if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '–°–æ–∑–¥–∞—ë–º...'; }

                    const title = (document.getElementById('ca_title')?.value || '').trim();
                    const type = (document.getElementById('ca_type')?.value || 'homework').trim();
                    const deadlineLocal = (document.getElementById('ca_deadline')?.value || '').trim();
                    const recipientsSel = document.getElementById('ca_recipients');
                    const recipientIds = recipientsSel ? Array.from(recipientsSel.selectedOptions).map(o => parseInt(o.value, 10)).filter(n => Number.isFinite(n)) : [];

                    if (!ids.length) {
                        if (window.toast) window.toast.error('–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                        return;
                    }
                    if (!title) {
                        if (window.toast) window.toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                        return;
                    }
                    if (!deadlineLocal) {
                        if (window.toast) window.toast.error('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–¥–ª–∞–π–Ω');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                        return;
                    }
                    const deadlineDate = new Date(deadlineLocal);
                    if (!Number.isFinite(deadlineDate.getTime())) {
                        if (window.toast) window.toast.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                        return;
                    }
                    if (!recipientIds.length) {
                        if (window.toast) window.toast.error('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                        return;
                    }

                    const payload = {
                        title,
                        type,
                        deadline: deadlineDate.toISOString(),
                        hard_deadline: false,
                        time_limit_minutes: null,
                        description: '',
                        tasks: ids.slice(0, 300).map((taskId, idx) => ({ task_id: taskId, max_score: 1, order: idx })),
                        recipientIds: recipientIds,
                    };

                    try {
                        const resp = await fetch(ASSIGNMENTS_DISTRIBUTE_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF_TOKEN || '',
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: JSON.stringify(payload),
                        });
                        const data = await resp.json().catch(() => ({}));
                        if (!resp.ok || data.success === false) {
                            const msg = data.error || `HTTP ${resp.status}`;
                            if (window.toast) window.toast.error(msg);
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                            return;
                        }
                        const assignmentId = data.assignment_id || data.assignmentId || data.id;
                        if (window.toast) window.toast.success('–†–∞–±–æ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
                        closeCreateAssignmentModal();
                        setTimeout(() => {
                            if (assignmentId) {
                                window.location.href = ASSIGNMENT_VIEW_URL_TPL.replace('/0', '/' + assignmentId);
                            } else {
                                window.location.href = ASSIGNMENTS_LIST_URL;
                            }
                        }, 350);
                    } catch (err) {
                        const msg = err?.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã';
                        if (window.toast) window.toast.error(msg);
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É'; }
                    }
                });
            }
        });
    </script>
    {% endif %}
</body>
</html>
