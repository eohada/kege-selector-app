<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Библиотека шаблонов · URep</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    {% include '_ux_enhancements.html' %}
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'templates' %}
        {% include '_primary_nav.html' %}
        {% set can_manage_templates = (current_user.is_authenticated and (current_user.is_admin() or current_user.is_creator() or has_permission(current_user, 'task.manage'))) %}
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <p class="hero-eyebrow">библиотека шаблонов</p>
                    <h1 class="hero-title"><img src="{{ url_for('static', filename='icons/SHABL.png') }}" alt="Шаблоны" class="ui-icon ui-icon--md">Шаблоны заданий</h1>
                    <p class="hero-subtitle">Готовые наборы заданий для быстрого формирования ДЗ, классных и проверочных работ</p>
                </div>
                {% if can_manage_templates %}
                <a href="{{ url_for('templates.template_new') }}" class="neo-button accent"><img src="{{ url_for('static', filename='icons/SULP.png') }}" alt="Создать" class="ui-icon ui-icon--sm">Создать шаблон</a>
                <a href="{{ url_for('templates.template_new', mode='manual') }}" class="neo-button outline" style="margin-left: 1rem;"><img src="{{ url_for('static', filename='icons/icons8-документ-100.png') }}" alt="Создать" class="ui-icon ui-icon--sm"> Создать вручную</a>
                {% endif %}
            </div>
        </section>

        <!-- Фильтры -->
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted);">Тип шаблона:</label>
                    <select id="typeFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">Все типы</option>
                        <option value="homework" {% if current_type == 'homework' %}selected{% endif %}>Домашние задания</option>
                        <option value="classwork" {% if current_type == 'classwork' %}selected{% endif %}>Классные работы</option>
                        <option value="exam" {% if current_type == 'exam' %}selected{% endif %}>Проверочные работы</option>
                        <option value="lesson" {% if current_type == 'lesson' %}selected{% endif %}>Уроки</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted);">Категория:</label>
                    <select id="categoryFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">Все категории</option>
                        <option value="ЕГЭ" {% if current_category == 'ЕГЭ' %}selected{% endif %}>ЕГЭ</option>
                        <option value="ОГЭ" {% if current_category == 'ОГЭ' %}selected{% endif %}>ОГЭ</option>
                        <option value="ЛЕВЕЛАП" {% if current_category == 'ЛЕВЕЛАП' %}selected{% endif %}>ЛЕВЕЛАП</option>
                        <option value="ПРОГРАММИРОВАНИЕ" {% if current_category == 'ПРОГРАММИРОВАНИЕ' %}selected{% endif %}>ПРОГРАММИРОВАНИЕ</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Разделы шаблонов -->
        {% for type_key, type_name, type_icon in [
            ('homework', 'Домашние задания', url_for('static', filename='icons/icons8-документ-100.png')),
            ('classwork', 'Классные работы', url_for('static', filename='icons/icons8-школа-100.png')),
            ('exam', 'Проверочные работы', url_for('static', filename='icons/icons8-bar-chart-100.png')),
            ('lesson', 'Уроки', url_for('static', filename='icons/SHABL.png'))
        ] %}
        {% set type_templates = templates_by_type.get(type_key, []) %}
        {% if not current_type or current_type == type_key %}
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div class="panel-head">
                <div>
                    <p class="eyebrow">
                        <img src="{{ type_icon }}" alt="{{ type_name }}" class="ui-icon ui-icon--sm">
                        {{ type_name }}
                    </p>
                    <h2>{{ type_templates|length }} шаблонов</h2>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: center;">
                    {% if can_manage_templates %}
                    <a href="{{ url_for('templates.template_new') }}?template_type={{ type_key }}{% if current_category %}&category={{ current_category }}{% endif %}"
                       class="neo-button outline"
                       style="padding: 0.55rem 0.8rem; min-width: 0; text-decoration: none;"
                       title="Создать шаблон в разделе «{{ type_name }}»"><img src="{{ url_for('static', filename='icons/SULP.png') }}" alt="Создать" class="ui-icon ui-icon--sm ui-icon--only"></a>
                    {% endif %}
                </div>
            </div>

            {% if type_templates %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                {% for template in type_templates %}
                <div class="template-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3>{{ template.name }}</h3>
                            {% if template.description %}
                            <p>{{ template.description[:100] }}{% if template.description|length > 100 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="template-badges">
                        {% if template.category %}
                        <span class="template-badge template-badge--category">{{ template.category }}</span>
                        {% endif %}
                        <span class="template-badge template-badge--count">{{ template.template_tasks|length }} заданий</span>
                    </div>

                    <div class="template-actions">
                        <a href="{{ url_for('templates.template_view', template_id=template.template_id) }}" class="neo-button ghost" style="text-decoration: none;"><img src="{{ url_for('static', filename='icons/icons8-спрятать-100.png') }}" alt="Просмотр" class="ui-icon ui-icon--sm">Просмотр</a>
                        {% if can_manage_templates %}
                        <a href="{{ url_for('templates.template_edit', template_id=template.template_id) }}" class="neo-button ghost" style="text-decoration: none;"><img src="{{ url_for('static', filename='icons/REDACT.png') }}" alt="Изменить" class="ui-icon ui-icon--sm">Изменить</a>
                        <button type="button" class="neo-button ghost danger" onclick="confirmDeleteTemplate({{ template.template_id }})" style="flex: 0 0 auto; padding: 0.9rem 0.8rem;"><img src="{{ url_for('static', filename='icons/MUSORN.png') }}" alt="Удалить" class="ui-icon ui-icon--sm ui-icon--only"></button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" style="padding: 3rem; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.4;"><img src="{{ url_for('static', filename='icons/icons8-пустая-папка-100.png') }}" alt="Пусто" style="width: 64px; height: 64px; object-fit: contain;"></div>
                <h3>Нет шаблонов</h3>
                <p style="color: var(--text-muted);">Создайте первый шаблон для этого типа</p>
            </div>
            {% endif %}
        </section>
        {% endif %}
        {% endfor %}
    </div>

    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='flash-to-toast.js') }}"></script>
    <script src="{{ url_for('static', filename='confirm-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script>
        function applyFilters() {
            const type = document.getElementById('typeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const params = new URLSearchParams();
            if (type) params.append('type', type);
            if (category) params.append('category', category);
            window.location.href = '{{ url_for('templates.templates_list') }}?' + params.toString();
        }

        function confirmDeleteTemplate(templateId) {
            showConfirmModal({
                title: 'Удалить шаблон?',
                message: 'Это действие нельзя отменить. Шаблон будет удален, но задания останутся в базе.',
                confirmText: 'Удалить',
                cancelText: 'Отмена',
                confirmClass: 'danger',
                onConfirm: async () => {
                    const loaderId = loading.show(document.body, 'Удаление шаблона...');
                    try {
                        const response = await fetch(`/templates/${templateId}/delete`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                            }
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('Ошибка удаления:', error);
                        loading.hide(loaderId);
                        toast.error('Ошибка при удалении шаблона');
                    }
                }
            });
        }
    </script>
</body>
</html>










