{% if current_user.is_creator() and user %}
                <div class="glass-panel" style="margin-bottom: 2rem; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.2rem;">Индивидуальные права доступа</h2>
                        <button type="button" class="neo-button ghost small" onclick="togglePermissions()">Показать/Скрыть</button>
                    </div>
                    
                    <div id="permissions-container" style="display: none;">
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Здесь можно переопределить права, назначенные ролью. Если галочка "Переопределить" не стоит, используется настройка роли.
                        </p>
                        
                        <div style="display: grid; gap: 2rem;">
                            {% for cat_key, cat_name in permission_categories.items() %}
                            <div class="permission-category">
                                <h3 style="margin-bottom: 0.5rem; color: var(--accent-primary); border-bottom: 1px solid var(--stroke-1); padding-bottom: 0.25rem; font-size: 1rem;">{{ cat_name }}</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.75rem;">
                                    {% for perm_key, perm_data in all_permissions.items() %}
                                        {% if perm_data.category == cat_key %}
                                            {% set is_overridden = user.custom_permissions and perm_key in user.custom_permissions %}
                                            {% set perm_value = user.custom_permissions[perm_key] if is_overridden else False %}
                                            
                                            <div class="permission-item" style="padding: 0.75rem; background: var(--surface-2); border-radius: var(--radius-sm); border: 1px solid var(--stroke-1);">
                                                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">{{ perm_data.name }}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">{{ perm_key }}</div>
                                                
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                                                        <input type="checkbox" name="perm_override_{{ perm_key }}" onchange="togglePermValue(this, '{{ perm_key }}')" {% if is_overridden %}checked{% endif %}>
                                                        <span>Переопределить</span>
                                                    </label>
                                                    
                                                    <label class="switch small" id="perm_switch_{{ perm_key }}" style="opacity: {% if is_overridden %}1{% else %}0.5{% endif %}; pointer-events: {% if is_overridden %}auto{% else %}none{% endif %};">
                                                        <input type="checkbox" name="perm_value_{{ perm_key }}" {% if perm_value %}checked{% endif %}>
                                                        <span class="slider round"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <script>
                    function togglePermissions() {
                        const container = document.getElementById('permissions-container');
                        container.style.display = container.style.display === 'none' ? 'block' : 'none';
                    }
                    
                    function togglePermValue(checkbox, key) {
                        const switchEl = document.getElementById('perm_switch_' + key);
                        if (checkbox.checked) {
                            switchEl.style.opacity = '1';
                            switchEl.style.pointerEvents = 'auto';
                        } else {
                            switchEl.style.opacity = '0.5';
                            switchEl.style.pointerEvents = 'none';
                        }
                    }
                </script>
                {% endif %}
