<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика - {{ student.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson and active_student %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        <img src="{{ url_for('static', filename='icons/icons8-наушники-100.png') }}" alt="Урок" class="ui-icon ui-icon--sm"> Урок идет: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">текущий урок</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>Ученик:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>Тема:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        <p style="margin: 0 0 0.4rem 0;"><strong>Дата:</strong> {{ active_lesson.lesson_date.strftime('%d.%m.%Y %H:%M') }}</p>
        <p style="margin: 0;"><strong>Длительность:</strong> {{ active_lesson.duration }} минут</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lessons.lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent"><img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Завершить" class="ui-icon ui-icon--sm">Завершить</button>
            </form>
            <a href="{{ url_for('students.student_profile', student_id=active_student.student_id) }}" class="neo-button ghost"><img src="{{ url_for('static', filename='icons/icons8-пользователь-100.png') }}" alt="Профиль" class="ui-icon ui-icon--sm">Профиль</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
    </script>
    {% endif %}
    
    <div class="app-shell">
        {% set active_page = 'dashboard' %}
        {% include '_primary_nav.html' %}
        
        <!-- Заголовок страницы -->
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('students.student_profile', student_id=student.student_id) }}" class="neo-button ghost" style="text-decoration: none;">
                    ← К профилю
                </a>
                <a href="{{ url_for('students.student_statistics', student_id=student.student_id) }}" class="neo-button ghost" style="text-decoration: none;">
                    Статистика по заданиям
                </a>
            </div>
            <p class="hero-eyebrow">расширенная аналитика</p>
            <h1 class="hero-title"><img src="{{ url_for('static', filename='icons/icons8-bar-chart-100.png') }}" alt="Аналитика" class="ui-icon ui-icon--md"> {{ student.name }}</h1>
            <p class="hero-subtitle">Детальный анализ успеваемости и навыков</p>
        </section>
        
        <!-- Метрики (карточки) -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="glass-panel">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">средний балл</p>
                        <h2 style="font-size: 2.5rem; margin: 0.5rem 0; color: var(--accent-1);">{{ metrics.current_gpa }}%</h2>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--stroke-1);">
                    <span style="color: var(--text-muted); font-size: 0.9em;">
                        {% if metrics.delta > 0 %}
                            <span style="color: #22c55e;">+{{ metrics.delta }}%</span> с прошлого месяца
                        {% elif metrics.delta < 0 %}
                            <span style="color: #ef4444;">{{ metrics.delta }}%</span> с прошлого месяца
                        {% else %}
                            Без изменений
                        {% endif %}
                    </span>
                </div>
            </div>
            
            <div class="glass-panel">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">сдано ДЗ</p>
                        <h2 style="font-size: 2.5rem; margin: 0.5rem 0; color: var(--accent-1);">{{ metrics.hw_submit_rate }}%</h2>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--stroke-1);">
                    <span style="color: var(--text-muted); font-size: 0.9em;">
                        Всего уроков: {{ metrics.total_lessons }}
                    </span>
                </div>
            </div>
            
            <div class="glass-panel">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">проведено</p>
                        <h2 style="font-size: 2.5rem; margin: 0.5rem 0; color: var(--accent-1);">{{ metrics.completed_lessons }}</h2>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--stroke-1);">
                    <span style="color: var(--text-muted); font-size: 0.9em;">
                        Завершенных уроков
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Графики -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <!-- График динамики GPA -->
            <section class="glass-panel">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">динамика успеваемости</p>
                        <h2>Изменение среднего балла</h2>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                    <canvas id="trendChart" style="max-height: 300px;"></canvas>
                </div>
            </section>
            
            <!-- График навыков (радар) -->
            <section class="glass-panel">
                <div class="panel-head">
                    <div>
                        <p class="eyebrow">карта навыков</p>
                        <h2>Уровень владения темами</h2>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                    <canvas id="skillsChart" style="max-height: 300px;"></canvas>
                </div>
            </section>
        </div>
        
        <!-- График посещаемости -->
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div class="panel-head">
                <div>
                    <p class="eyebrow">посещаемость</p>
                    <h2>Статусы уроков</h2>
                </div>
            </div>
            <div style="margin-top: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                <canvas id="attendanceChart" style="max-height: 300px;"></canvas>
            </div>
        </section>
        
        <!-- Проблемные зоны -->
        {% if problem_topics %}
        <section class="glass-panel" style="margin-bottom: 2rem;">
            <div class="panel-head">
                <div>
                    <p class="eyebrow">требует внимания</p>
                    <h2>Проблемные темы</h2>
                </div>
            </div>
            <div style="margin-top: 1.5rem;">
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Темы, по которым успеваемость ниже 60%:
                </p>
                <div style="display: grid; gap: 1rem;">
                    {% for topic in problem_topics %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1);">
                        <div>
                            <span style="font-weight: 500;">{{ topic.name }}</span>
                            <span style="color: var(--text-muted); margin-left: 1rem;">{{ topic.avg_score }}%</span>
                        </div>
                        <a href="{{ url_for('kege_generator.kege_generator') }}?student_id={{ student.student_id }}" class="neo-button accent" style="text-decoration: none;">
                            Создать отработку
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}
        
        {% if not charts.trend_dates or charts.trend_dates == '[]' %}
        <section class="glass-panel">
            <div style="text-align: center; padding: 3rem 2rem;">
                <h3 style="margin-bottom: 1rem;">Нет данных для аналитики</h3>
                <p style="color: var(--text-muted);">
                    Выполните задания и проведите автопроверку, чтобы увидеть аналитику.
                </p>
            </div>
        </section>
        {% endif %}
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- График Динамики GPA ---
            const ctxTrend = document.getElementById('trendChart');
            if (ctxTrend) {
                const trendChart = new Chart(ctxTrend.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: {{ charts.trend_dates | safe }},
                        datasets: [{
                            label: 'Успеваемость (%)',
                            data: {{ charts.trend_scores | safe }},
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // --- График Навыков (Radar) ---
            const ctxSkills = document.getElementById('skillsChart');
            if (ctxSkills && {{ charts.skill_labels | safe }}.length > 0) {
                const skillsChart = new Chart(ctxSkills.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: {{ charts.skill_labels | safe }},
                        datasets: [{
                            label: 'Уровень владения (%)',
                            data: {{ charts.skill_values | safe }},
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }
            
            // --- График Посещаемости (Pie) ---
            const ctxAttendance = document.getElementById('attendanceChart');
            if (ctxAttendance && {{ charts.attendance_labels | safe }}.length > 0) {
                const attendanceChart = new Chart(ctxAttendance.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: {{ charts.attendance_labels | safe }},
                        datasets: [{
                            data: {{ charts.attendance_values | safe }},
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(234, 179, 8, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(147, 51, 234, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(168, 85, 247, 0.8)'
                            ],
                            borderColor: [
                                'rgb(34, 197, 94)',
                                'rgb(234, 179, 8)',
                                'rgb(239, 68, 68)',
                                'rgb(147, 51, 234)',
                                'rgb(59, 130, 246)',
                                'rgb(168, 85, 247)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right'
                            }
                        }
                    }
                });
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
</body>
</html>
