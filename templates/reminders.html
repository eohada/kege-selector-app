<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Напоминания · URep</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .reminders-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .reminder-card {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.25s ease;
            position: relative;
        }
        
        .reminder-card:hover {
            border-color: rgba(0, 255, 213, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 213, 0.1);
        }
        
        .reminder-card.completed {
            opacity: 0.6;
        }
        
        .reminder-card.completed .reminder-title {
            text-decoration: line-through;
        }
        
        .reminder-card.overdue {
            border-left: 3px solid var(--danger);
        }
        
        .reminder-card.overdue .reminder-time {
            color: var(--danger);
            font-weight: 600;
        }
        
        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .reminder-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
        }
        
        .reminder-time {
            font-size: 0.9rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .reminder-time.past {
            color: var(--danger);
        }
        
        .reminder-time.upcoming {
            color: var(--accent-1);
        }
        
        .reminder-time.no-time {
            color: var(--text-muted);
            font-style: italic;
        }
        
        .reminder-message {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .reminder-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .reminder-actions .neo-button {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .filter-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-toggle .neo-button {
            font-size: 0.9rem;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .modal {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .status-badge.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'reminders' %}
        {% include '_primary_nav.html' %}
        
        <main class="app-content">
            <div class="reminders-container">
                <section class="dashboard-hero" style="margin-bottom: 2rem;">
                    <div class="hero-pane" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>Напоминания</h1>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">Легкие заметки с указанием времени</p>
                        </div>
                        <button class="neo-button accent" onclick="openCreateModal()">
                            <img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Создать" class="ui-icon ui-icon--sm"> Создать
                        </button>
                    </div>
                </section>
                
                <div class="filter-toggle">
                    <a href="{{ url_for('reminders.reminders_list', show_completed='false') }}" 
                       class="neo-button {% if not show_completed %}accent{% else %}ghost{% endif %}">
                        Активные
                    </a>
                    <a href="{{ url_for('reminders.reminders_list', show_completed='true') }}" 
                       class="neo-button {% if show_completed %}accent{% else %}ghost{% endif %}">
                        Все
                    </a>
                </div>
                
                {% if reminders_data %}
                <section>
                    {% for item in reminders_data %}
                    {% set reminder = item.reminder %}
                    <div class="reminder-card {% if reminder.is_completed %}completed{% endif %} {% if reminder.is_overdue() %}overdue{% endif %}">
                        <div class="reminder-header">
                            <div class="reminder-title">
                                {{ reminder.title }}
                                {% if reminder.reminder_time %}
                                <span class="status-badge time-badge" title="С временем напоминания">
                                    <img src="{{ url_for('static', filename='icons/VREMYA.png') }}" alt="Время" class="ui-icon ui-icon--sm" style="width: 14px; height: 14px; margin-right: 0.25rem;">С временем
                                </span>
                                {% else %}
                                <span class="status-badge no-time-badge" title="Без времени напоминания">
                                    <img src="{{ url_for('static', filename='icons/icons8-лампочка-96.png') }}" alt="Без времени" class="ui-icon ui-icon--sm" style="width: 14px; height: 14px; margin-right: 0.25rem;">Без времени
                                </span>
                                {% endif %}
                                {% if reminder.is_overdue() and not reminder.is_completed %}
                                <span class="status-badge overdue">Просрочено</span>
                                {% endif %}
                            </div>
                            <div class="reminder-time {% if reminder.reminder_time %}{% if reminder.reminder_time < now and not reminder.is_completed %}past{% elif reminder.reminder_time > now %}upcoming{% endif %}{% else %}no-time{% endif %}" 
                                 {% if item.time_iso %}data-time-iso="{{ item.time_iso }}"{% endif %}>
                                {% if reminder.reminder_time %}
                                    <span class="time-display">{{ reminder.reminder_time.strftime('%d.%m.%Y %H:%M') }}</span>
                                {% else %}
                                    Без времени
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if reminder.message %}
                        <div class="reminder-message">{{ reminder.message }}</div>
                        {% endif %}
                        
                        <div class="reminder-actions">
                            <button type="button" class="neo-button ghost" onclick="openEditModal({{ reminder.reminder_id }}, '{{ reminder.title|e }}', '{{ reminder.message|e if reminder.message else '' }}', {% if item.time_iso %}'{{ item.time_iso }}'{% else %}null{% endif %})">
                                <img src="{{ url_for('static', filename='icons/REDACT.png') }}" alt="Редактировать" class="ui-icon ui-icon--sm"> Редактировать
                            </button>
                            
                            <form method="POST" action="{{ url_for('reminders.reminder_toggle', reminder_id=reminder.reminder_id) }}" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="neo-button {% if reminder.is_completed %}ghost{% else %}outline{% endif %}">
                                    <img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Выполнено" class="ui-icon ui-icon--sm">
                                    {% if reminder.is_completed %}Отметить активным{% else %}Выполнено{% endif %}
                                </button>
                            </form>
                            
                            <form method="POST" action="{{ url_for('reminders.reminder_delete', reminder_id=reminder.reminder_id) }}" 
                                  class="confirm-delete-form" 
                                  style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="neo-button danger">
                                    <img src="{{ url_for('static', filename='icons/MUSORN.png') }}" alt="Удалить" class="ui-icon ui-icon--sm"> Удалить
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </section>
                {% else %}
                <section class="glass-panel">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <img src="{{ url_for('static', filename='icons/VREMYA.png') }}" alt="Нет напоминаний" style="width: 64px; height: 64px; opacity: 0.5;">
                        </div>
                        <h3>Нет напоминаний</h3>
                        <p>Создайте первое напоминание</p>
                    </div>
                </section>
                {% endif %}
            </div>
        </main>
    </div>
    
    <!-- Modal для создания напоминания -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Создать напоминание</h2>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form id="createReminderForm" onsubmit="submitReminder(event)">
                <input type="hidden" id="create_reminder_id" name="reminder_id" value="">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="neo-field">
                        <label class="neo-label" for="modal_title">Заголовок *</label>
                        <input type="text" 
                               id="modal_title" 
                               name="title" 
                               class="neo-input" 
                               placeholder="Что нужно напомнить?"
                               required>
                    </div>
                    
                    <div class="neo-field">
                        <label class="neo-label" for="modal_message">Сообщение (необязательно)</label>
                        <textarea id="modal_message" 
                                  name="message" 
                                  class="neo-textarea" 
                                  placeholder="Дополнительные детали..."
                                  rows="3"></textarea>
                    </div>
                    
                    <div class="neo-field">
                        <label class="neo-label" for="modal_reminder_time">
                            Время напоминания
                            <small style="display: block; color: var(--text-muted); font-weight: normal; margin-top: 0.25rem;">
                                Оставьте пустым для напоминания без времени
                            </small>
                        </label>
                        <input type="datetime-local" 
                               id="modal_reminder_time" 
                               name="reminder_time" 
                               class="neo-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-button ghost" onclick="closeCreateModal()">Отмена</button>
                    <button type="submit" class="neo-button accent" id="submitReminderBtn">
                        <img src="{{ url_for('static', filename='icons/icons8-галочка-100.png') }}" alt="Создать" class="ui-icon ui-icon--sm"> <span id="submitReminderText">Создать</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {# toast.js уже подключается через _ux_enhancements.html #}
    <script src="{{ url_for('static', filename='flash-to-toast.js') }}"></script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
    <script>
        function parseIsoToDate(value) {
            if (!value) return null;
            try {
                const d = new Date(value);
                if (!Number.isFinite(d.getTime())) {
                    // Фоллбек для "YYYY-MM-DD HH:MM(:SS)" -> ISO
                    let v = String(value).trim();
                    if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(v)) {
                        v = v.replace(' ', 'T');
                    }
                    // Если timezone отсутствует, считаем, что это уже локальное время
                    const d2 = new Date(v);
                    if (!Number.isFinite(d2.getTime())) return null;
                    return d2;
                }
                return d;
            } catch (e) {
                return null;
            }
        }

        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.getElementById('createModal').querySelector('.modal-title').textContent = 'Создать напоминание';
            document.getElementById('create_reminder_id').value = '';
            const submitText = document.getElementById('submitReminderText');
            if (submitText) submitText.textContent = 'Создать';
            document.getElementById('createReminderForm').reset();
            document.body.style.overflow = 'hidden';
        }
        
        function openEditModal(reminderId, title, message, timeIso) {
            document.getElementById('createModal').classList.add('active');
            document.getElementById('createModal').querySelector('.modal-title').textContent = 'Редактировать напоминание';
            document.getElementById('create_reminder_id').value = reminderId;
            const submitText = document.getElementById('submitReminderText');
            if (submitText) submitText.textContent = 'Сохранить';
            document.getElementById('modal_title').value = title;
            document.getElementById('modal_message').value = message || '';
            
            // Устанавливаем время в datetime-local input
            const timeInput = document.getElementById('modal_reminder_time');
            if (timeIso && timeIso !== 'null') {
                // Конвертируем ISO строку с timezone в формат для datetime-local
                const date = parseIsoToDate(timeIso);
                if (!date) {
                    timeInput.value = '';
                } else {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                timeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
            } else {
                timeInput.value = '';
            }
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('createReminderForm').reset();
            document.getElementById('create_reminder_id').value = '';
        }
        
        document.getElementById('createModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateModal();
            }
        });
        
        function submitReminder(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const reminderId = formData.get('reminder_id');
            const title = formData.get('title').trim();
            const message = formData.get('message').trim();
            const reminderTime = formData.get('reminder_time');
            
            if (!title) {
                if (typeof toast !== 'undefined' && toast) {
                    toast.error('Заголовок обязателен');
                }
                return;
            }
            
            const data = {
                title: title,
                message: message || null,
                reminder_time: reminderTime || null,
                timezone_offset: new Date().getTimezoneOffset() * -1
            };
            
            const csrfToken = formData.get('csrf_token');
            const url = reminderId ? 
                '{{ url_for("reminders.reminder_update", reminder_id=0) }}'.replace('/0/', '/' + reminderId + '/') :
                '{{ url_for("reminders.reminder_create") }}';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    if (typeof toast !== 'undefined' && toast) {
                        toast.success(reminderId ? 'Напоминание обновлено' : 'Напоминание создано');
                    }
                    closeCreateModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    if (typeof toast !== 'undefined' && toast) {
                        toast.error(result.error || (reminderId ? 'Ошибка при обновлении напоминания' : 'Ошибка при создании напоминания'));
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof toast !== 'undefined' && toast) {
                    toast.error(reminderId ? 'Ошибка при обновлении напоминания' : 'Ошибка при создании напоминания');
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // UX: /reminders?create=1 — открыть модалку "Создать" (и убрать параметр из URL)
            try {
                const params = new URLSearchParams(window.location.search || '');
                if (params.get('create') === '1') {
                    openCreateModal();
                    params.delete('create');
                    const next =
                        window.location.pathname +
                        (params.toString() ? `?${params.toString()}` : '') +
                        (window.location.hash || '');
                    window.history.replaceState({}, '', next);
                }
            } catch (e) {
                // no-op
            }

            // Конвертируем время напоминаний в локальное время устройства
            const timeDisplays = document.querySelectorAll('.reminder-time[data-time-iso]');
            timeDisplays.forEach(element => {
                const timeIso = element.getAttribute('data-time-iso');
                if (timeIso) {
                    try {
                        // Парсим ISO строку с timezone (например: 2025-12-22T15:00:00+03:00)
                        const date = parseIsoToDate(timeIso);
                        if (!date) return;
                        
                        const timeDisplay = element.querySelector('.time-display');
                        if (timeDisplay) {
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            timeDisplay.textContent = `${day}.${month}.${year} ${hours}:${minutes}`;
                        }
                    } catch (e) {
                        console.error('Error converting time:', e);
                    }
                }
            });
            
            // Обработка toggle через AJAX
            const toggleForms = document.querySelectorAll('form[action*="/toggle"]');
            toggleForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    const csrfToken = formData.get('csrf_token');
                    
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success('Статус обновлен');
                            }
                            setTimeout(() => {
                                window.location.reload();
                            }, 300);
                        } else {
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error(result.error || 'Ошибка при обновлении статуса');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (typeof toast !== 'undefined' && toast) {
                            toast.error('Ошибка при обновлении статуса');
                        }
                    });
                });
            });
            
            const confirmDeleteForms = document.querySelectorAll('.confirm-delete-form');
            confirmDeleteForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (!confirm('Удалить это напоминание?')) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
</body>
</html>
