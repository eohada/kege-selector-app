<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка · Журнал</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% include '_ux_enhancements.html' %}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .queue-hero {
            background: linear-gradient(135deg, rgba(0, 255, 213, 0.06), rgba(31, 123, 255, 0.06));
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .queue-title {
            font-size: 2.15rem;
            font-weight: 900;
            margin: 0.4rem 0 0 0;
        }
        .queue-sub {
            color: var(--text-muted);
            margin-top: 0.65rem;
            line-height: 1.45;
        }
        .filters {
            display: grid;
            grid-template-columns: 1.1fr 1fr 1fr 1.4fr auto;
            gap: 0.75rem;
            align-items: end;
            margin-top: 1.1rem;
        }
        @media (max-width: 980px) {
            .filters { grid-template-columns: 1fr; }
        }
        .filter-label {
            color: var(--text-muted);
            font-weight: 800;
            font-size: 0.9rem;
            margin-bottom: 0.35rem;
            display: block;
        }
        .card {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }
        .lesson-head {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .lesson-title {
            font-size: 1.2rem;
            font-weight: 900;
            margin: 0;
        }
        .lesson-meta {
            color: var(--text-muted);
            margin-top: 0.4rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            font-size: 0.92rem;
        }
        .tasks-grid {
            margin-top: 0.9rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.65rem;
        }
        .task-chip {
            border: 1px solid var(--stroke-1);
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 0.75rem 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s, background 0.2s, border-color 0.2s;
        }
        .task-chip:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,0.04);
            border-color: rgba(0,255,213,0.35);
        }
        .task-left { min-width: 0; }
        .task-name {
            font-weight: 900;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .task-sub {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        .right-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'review_queue' %}
        {% include '_primary_nav.html' %}

        <main style="margin-top: 1.25rem;">
            <section class="queue-hero">
                <div class="hero-eyebrow">Домашка/проверка</div>
                <h1 class="queue-title">Журнал проверок</h1>
                <div class="queue-sub">Единая очередь «что проверить» по классной комнате и работам. Фильтруй и переходи в нужную проверку.</div>

                <form method="GET" class="filters">
                    <div>
                        <label class="filter-label" for="status">Статус</label>
                        <select class="neo-select" id="status" name="status">
                            <option value="submitted" {% if status == 'submitted' %}selected{% endif %}>Сдано ({{ (status_counts.submitted if status_counts else 0) }})</option>
                            <option value="returned" {% if status == 'returned' %}selected{% endif %}>На доработку ({{ (status_counts.returned if status_counts else 0) }})</option>
                            <option value="graded" {% if status == 'graded' %}selected{% endif %}>Проверено ({{ (status_counts.graded if status_counts else 0) }})</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Черновики ({{ (status_counts.pending if status_counts else 0) }})</option>
                        </select>
                    </div>

                    <div>
                        <label class="filter-label" for="source">Источник</label>
                        <select class="neo-select" id="source" name="source">
                            <option value="all" {% if source == 'all' %}selected{% endif %}>Все</option>
                            <option value="lessons" {% if source == 'lessons' %}selected{% endif %}>Классная комната</option>
                            <option value="assignments" {% if source == 'assignments' %}selected{% endif %}>Работы</option>
                        </select>
                    </div>

                    <div>
                        <label class="filter-label" for="assignment_type">Тип</label>
                        <select class="neo-select" id="assignment_type" name="assignment_type">
                            <option value="" {% if not assignment_type %}selected{% endif %}>Все</option>
                            <option value="homework" {% if assignment_type == 'homework' %}selected{% endif %}>ДЗ</option>
                            <option value="classwork" {% if assignment_type == 'classwork' %}selected{% endif %}>КР</option>
                            <option value="exam" {% if assignment_type == 'exam' %}selected{% endif %}>Проверочная</option>
                        </select>
                    </div>

                    <div>
                        <label class="filter-label" for="student">Ученик</label>
                        <input class="neo-input" id="student" name="student" value="{{ student_query }}" placeholder="Поиск по имени…">
                    </div>

                    <div style="display:flex; gap: 0.6rem; flex-wrap: wrap; justify-content: flex-end;">
                        <button type="submit" class="neo-button accent">
                            <i class="fas fa-filter ui-icon ui-icon--sm"></i> Применить
                        </button>
                        <a href="{{ url_for('lessons.review_queue') }}" class="neo-button outline">
                            <i class="fas fa-rotate-left ui-icon ui-icon--sm"></i> Сброс
                        </a>
                    </div>
                </form>
            </section>

            {% if (source != 'assignments') and lesson_cards and lesson_cards|length > 0 %}
                {% set tz_name = (current_user.profile.timezone if current_user.profile and current_user.profile.timezone else 'Europe/Moscow') %}
                <div style="display:flex; flex-direction: column; gap: 0.9rem;">
                    {% for item in lesson_cards %}
                        {% set lesson = item.lesson %}
                        {% set student = item.student %}
                        {% set tasks = item.tasks %}
                        {% set lesson_local = (lesson.lesson_date|to_tz(tz_name)) %}
                        <section class="card">
                            <div class="lesson-head">
                                <div style="min-width: 0;">
                                    <h2 class="lesson-title">{{ lesson.topic or 'Урок' }}</h2>
                                    <div class="lesson-meta">
                                        <span><i class="fas fa-user-graduate"></i> <strong>{{ student.name if student else '—' }}</strong></span>
                                        <span><i class="far fa-calendar"></i> {{ lesson_local.strftime('%d.%m.%Y %H:%M') if lesson_local else '—' }}</span>
                                        <span class="status-badge status-info" style="opacity: 0.95;">{{ tasks|length }} задач</span>
                                    </div>
                                </div>
                                <div class="right-actions">
                                    <a class="neo-button outline" href="{{ url_for('lessons.lesson_homework_view', lesson_id=lesson.lesson_id) }}">
                                        <i class="fas fa-door-open ui-icon ui-icon--sm"></i> Открыть урок
                                    </a>
                                    {% if status == 'submitted' %}
                                    <details style="position: relative;">
                                        <summary class="neo-button ghost" style="list-style:none; cursor:pointer;">Ещё</summary>
                                        <div style="position:absolute; right:0; top:calc(100% + 8px); z-index: 20; min-width: 220px; padding: .6rem; border-radius: var(--radius-lg); border: 1px solid var(--stroke-1); background: var(--surface-1); box-shadow: var(--shadow-soft); display:grid; gap:.5rem;">
                                            <form method="POST" action="{{ url_for('lessons.review_bulk_update_lesson', lesson_id=lesson.lesson_id) }}">
                                                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="mark_graded">
                                                <input type="hidden" name="status" value="{{ status }}">
                                                <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
                                                <input type="hidden" name="student" value="{{ student_query }}">
                                                <button type="submit" class="neo-button accent sm" style="width:100%;">
                                                    <i class="fas fa-check ui-icon ui-icon--sm"></i> Всё проверено
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('lessons.review_bulk_update_lesson', lesson_id=lesson.lesson_id) }}">
                                                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="mark_returned">
                                                <input type="hidden" name="status" value="{{ status }}">
                                                <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
                                                <input type="hidden" name="student" value="{{ student_query }}">
                                                <button type="submit" class="neo-button outline sm" style="width:100%;">
                                                    <i class="fas fa-rotate-left ui-icon ui-icon--sm"></i> На доработку
                                                </button>
                                            </form>
                                        </div>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="tasks-grid">
                                {% for lt in tasks %}
                                    {% set tnum = lt.task.task_number if lt.task and lt.task.task_number else None %}
                                    {% set label = ('№' ~ tnum) if tnum else ('ID ' ~ lt.lesson_task_id) %}
                                    <a class="task-chip" href="{{ url_for('lessons.lesson_homework_view', lesson_id=lesson.lesson_id) }}#task-{{ lt.lesson_task_id }}">
                                        <div class="task-left">
                                            <div class="task-name">{{ label }}</div>
                                            <div class="task-sub">
                                                {% if lt.assignment_type == 'classwork' %}КР{% elif lt.assignment_type == 'exam' %}Проверочная{% else %}ДЗ{% endif %}
                                                ·
                                                {% if lt.student_submission %}есть ответ{% else %}без ответа{% endif %}
                                            </div>
                                        </div>
                                        <span class="status-badge status-info" style="opacity: 0.9;">
                                            {% if (lt.status or '').lower() == 'submitted' %}Сдано
                                            {% elif (lt.status or '').lower() == 'graded' %}Проверено
                                            {% elif (lt.status or '').lower() == 'returned' %}На доработку
                                            {% elif (lt.status or '').lower() == 'pending' %}Черновик
                                            {% else %}{{ lt.status }}{% endif %}
                                        </span>
                                    </a>
                                {% endfor %}
                            </div>
                        </section>
                    {% endfor %}
                </div>
            {% elif (source != 'assignments') %}
                <div class="glass-panel" style="padding: 2rem; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.75rem;">✅</div>
                    <div style="font-size: 1.25rem; font-weight: 900;">Очередь пуста</div>
                    <div style="color: var(--text-muted); margin-top: 0.5rem;">По текущим фильтрам нет задач.</div>
                </div>
            {% endif %}

            {% if (source != 'lessons') and assignment_cards and assignment_cards|length > 0 %}
                <div style="display:flex; flex-direction: column; gap: 0.9rem; margin-top: 1rem;">
                    {% for item in assignment_cards %}
                        {% set a = item.assignment %}
                        {% set subs = item.submissions %}
                        <section class="card">
                            <div class="lesson-head">
                                <div style="min-width: 0;">
                                    <h2 class="lesson-title">{{ a.title }}</h2>
                                    <div class="lesson-meta">
                                        <span class="status-badge status-info" style="opacity: 0.95;">
                                            {% if a.assignment_type == 'classwork' %}КР{% elif a.assignment_type == 'exam' %}Проверочная{% else %}ДЗ{% endif %}
                                        </span>
                                        <span><i class="far fa-calendar"></i> дедлайн: {{ a.deadline.strftime('%d.%m.%Y %H:%M') if a.deadline else '—' }}</span>
                                        <span class="status-badge status-info" style="opacity: 0.95;">{{ subs|length }} сдач</span>
                                    </div>
                                </div>
                                <div class="right-actions">
                                    <a class="neo-button outline" href="{{ url_for('assignments.assignment_view', assignment_id=a.assignment_id) }}">
                                        <i class="fas fa-folder-open ui-icon ui-icon--sm"></i> Открыть работу
                                    </a>
                                    {% if status == 'submitted' %}
                                    <details style="position: relative;">
                                        <summary class="neo-button ghost" style="list-style:none; cursor:pointer;">Ещё</summary>
                                        <div style="position:absolute; right:0; top:calc(100% + 8px); z-index: 20; min-width: 240px; padding: .6rem; border-radius: var(--radius-lg); border: 1px solid var(--stroke-1); background: var(--surface-1); box-shadow: var(--shadow-soft); display:grid; gap:.5rem;">
                                            <form method="POST" action="{{ url_for('assignments.assignment_review_bulk_update', assignment_id=a.assignment_id) }}">
                                                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="mark_graded">
                                                <input type="hidden" name="status" value="{{ status }}">
                                                <input type="hidden" name="source" value="{{ source }}">
                                                <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
                                                <input type="hidden" name="student" value="{{ student_query }}">
                                                <button type="submit" class="neo-button accent sm" style="width:100%;" onclick="return confirm('Отметить как «Проверено» ВСЕ сданные работы, где уже есть итоговые баллы?')">
                                                    <i class="fas fa-check ui-icon ui-icon--sm"></i> Проверено всем
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('assignments.assignment_review_bulk_update', assignment_id=a.assignment_id) }}">
                                                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="mark_returned">
                                                <input type="hidden" name="status" value="{{ status }}">
                                                <input type="hidden" name="source" value="{{ source }}">
                                                <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
                                                <input type="hidden" name="student" value="{{ student_query }}">
                                                <button type="submit" class="neo-button outline sm" style="width:100%;" onclick="return confirm('Вернуть на доработку ВСЕ сданные работы по этой задаче?')">
                                                    <i class="fas fa-rotate-left ui-icon ui-icon--sm"></i> Вернуть всем
                                                </button>
                                            </form>
                                        </div>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="tasks-grid">
                                {% for s in subs %}
                                    <div class="task-chip" style="cursor: default;">
                                        <a href="{{ url_for('assignments.submission_grade_view', submission_id=s.submission_id) }}" style="display:flex; justify-content: space-between; align-items: center; gap: .75rem; text-decoration:none; color:inherit; flex: 1; min-width: 0;">
                                            <div class="task-left">
                                                <div class="task-name">{{ s.student.name if s.student else ('Student #' ~ s.student_id) }}</div>
                                                <div class="task-sub">
                                                    {% if s.submitted_at %}сдано: {{ s.submitted_at.strftime('%d.%m.%Y %H:%M') }}{% elif s.assigned_at %}назначено: {{ s.assigned_at.strftime('%d.%m.%Y %H:%M') }}{% else %}—{% endif %}
                                                </div>
                                            </div>
                                            <span class="status-badge status-info" style="opacity: 0.9; white-space: nowrap;">
                                                {% if (s.status or '').upper() in ['SUBMITTED', 'LATE'] %}Сдано
                                                {% elif (s.status or '').upper() == 'GRADED' %}Проверено
                                                {% elif (s.status or '').upper() == 'RETURNED' %}На доработку
                                                {% elif (s.status or '').upper() in ['ASSIGNED', 'IN_PROGRESS'] %}Черновик
                                                {% else %}{{ s.status }}{% endif %}
                                            </span>
                                        </a>

                                        {% if (s.status or '').upper() in ['SUBMITTED', 'LATE'] %}
                                        <form method="POST" action="{{ url_for('assignments.submission_quick_return', submission_id=s.submission_id) }}" style="display:inline; flex: 0 0 auto;">
                                            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                            <input type="hidden" name="status" value="{{ status }}">
                                            <input type="hidden" name="source" value="{{ source }}">
                                            <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
                                            <input type="hidden" name="student" value="{{ student_query }}">
                                            <button type="submit" class="neo-button outline sm" onclick="return confirm('Вернуть на доработку эту сдачу?')">
                                                ↩ вернуть
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </section>
                    {% endfor %}
                </div>
            {% elif (source != 'lessons') %}
                <div class="glass-panel" style="padding: 2rem; text-align: center; margin-top: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.75rem;">✅</div>
                    <div style="font-size: 1.25rem; font-weight: 900;">Очередь пуста</div>
                    <div style="color: var(--text-muted); margin-top: 0.5rem;">По текущим фильтрам нет работ.</div>
                </div>
            {% endif %}
        </main>
    </div>
</body>
</html>

