<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ assignment.title }} - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞–±–æ—Ç—ã</title>
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    <style>
        .page-hero {
            background: radial-gradient(900px 420px at 14% 10%, rgba(0, 255, 213, 0.10), transparent 60%),
                        radial-gradient(900px 420px at 85% 20%, rgba(31, 123, 255, 0.10), transparent 55%);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .hero-top {
            display:flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .hero-title {
            font-size: 2.05rem;
            font-weight: 900;
            margin: 0.35rem 0 0 0;
            letter-spacing: -0.01em;
            line-height: 1.15;
        }
        .hero-meta {
            margin-top: 0.8rem;
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            padding: 0.25rem 0.55rem;
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            font-weight: 900;
            font-size: 0.82rem;
            color: var(--text-primary);
        }
        .pill--danger { border-color: rgba(255, 77, 107, 0.55); background: rgba(255, 77, 107, 0.10); }
        .pill--success { border-color: rgba(45, 212, 191, 0.55); background: rgba(45, 212, 191, 0.10); }
        .pill--warning { border-color: rgba(255, 179, 71, 0.55); background: rgba(255, 179, 71, 0.10); }
        .pill--accent { border-color: rgba(0, 255, 213, 0.55); background: rgba(0, 255, 213, 0.10); }
        .meta-strong { color: var(--text-primary); font-weight: 900; }

        .kpi-grid {
            margin-top: 1.1rem;
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 0.75rem;
        }
        @media (max-width: 980px) {
            .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .kpi {
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            border-radius: var(--radius-lg);
            padding: 0.9rem 1rem;
        }
        .kpi-label { color: var(--text-muted); font-weight: 800; font-size: 0.9rem; }
        .kpi-value { margin-top: 0.35rem; font-size: 1.35rem; font-weight: 900; }

        .layout {
            display: grid;
            grid-template-columns: 1.05fr 0.95fr;
            gap: 1rem;
            align-items: start;
        }
        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
        }

        .card {
            border: 1px solid var(--stroke-1);
            background: var(--surface-1);
            border-radius: var(--radius-lg);
            padding: 1rem;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 900;
            margin: 0;
        }
        .card-sub {
            color: var(--text-muted);
            margin-top: 0.4rem;
            line-height: 1.5;
        }

        .filters {
            margin-top: 0.9rem;
            display: grid;
            grid-template-columns: 1fr 1.1fr auto;
            gap: 0.75rem;
            align-items: end;
        }
        @media (max-width: 980px) {
            .filters { grid-template-columns: 1fr; }
        }
        .filter-label { color: var(--text-muted); font-weight: 800; font-size: 0.9rem; margin-bottom: 0.35rem; display:block; }

        .submissions {
            margin-top: 0.9rem;
            display: grid;
            gap: 0.75rem;
        }
        .sub-card {
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            border-radius: var(--radius-lg);
            padding: 0.9rem 1rem;
        }
        .sub-head {
            display:flex;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .sub-name { font-weight: 900; }
        .sub-meta { margin-top: 0.35rem; color: var(--text-muted); font-size: 0.92rem; display:flex; gap: .65rem; flex-wrap: wrap; align-items: center; }
        .status-badge { border-radius: 999px; padding: 0.25rem 0.55rem; font-weight: 900; font-size: 0.82rem; border: 1px solid var(--stroke-1); background: rgba(255,255,255,0.02); }
        .status-assigned { border-color: rgba(255,255,255,0.18); }
        .status-in_progress { border-color: rgba(31,123,255,0.45); background: rgba(31,123,255,0.12); }
        .status-submitted { border-color: rgba(0,255,213,0.55); background: rgba(0,255,213,0.10); }
        .status-late { border-color: rgba(255,179,71,0.55); background: rgba(255,179,71,0.10); }
        .status-graded { border-color: rgba(45,212,191,0.55); background: rgba(45,212,191,0.10); }
        .status-returned { border-color: rgba(255,179,71,0.55); background: rgba(255,179,71,0.10); }

        .task-list { margin-top: 0.9rem; display: grid; gap: 0.75rem; }
        .task {
            border: 1px solid var(--stroke-1);
            background: rgba(255,255,255,0.02);
            border-radius: var(--radius-lg);
            padding: 0.9rem 1rem;
        }
        .task-head { display:flex; justify-content: space-between; gap: 0.75rem; flex-wrap: wrap; align-items: flex-start; }
        .task-title { font-weight: 900; color: var(--text-primary); }
        .task-sub { color: var(--text-muted); font-size: 0.92rem; margin-top: 0.3rem; }
        .task-body { margin-top: 0.75rem; line-height: 1.8; }
        details.task-details > summary {
            list-style: none;
            cursor: pointer;
            display:flex;
            justify-content: space-between;
            align-items: center;
            gap: .6rem;
        }
        details.task-details > summary::-webkit-details-marker { display:none; }
        .summary-hint { color: var(--text-muted); font-weight: 800; }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'assignments' %}
        {% include '_primary_nav.html' %}

        <main style="margin-top: 1.25rem;">
            <section class="page-hero">
                <div class="hero-top">
                    <div style="min-width: 0;">
                        <a href="{{ url_for('assignments.assignments_list') }}" class="neo-button outline" style="text-decoration:none;">
                            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                        </a>
                        <h1 class="hero-title">{{ assignment.title }}</h1>
                        <div class="hero-meta">
                            <span class="pill">–¢–∏–ø: <span class="meta-strong">
                                {% if assignment.assignment_type == 'homework' %}–î–ó
                                {% elif assignment.assignment_type == 'classwork' %}–ö–†
                                {% elif assignment.assignment_type == 'exam' %}–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è
                                {% elif assignment.assignment_type == 'test' %}–¢–µ—Å—Ç
                                {% else %}{{ assignment.assignment_type }}{% endif %}
                            </span></span>
                            <span class="pill">üìÖ –î–µ–¥–ª–∞–π–Ω: <span class="meta-strong">{{ assignment.deadline.strftime('%d.%m.%Y %H:%M') }}</span></span>
                            <span class="pill">üß© –ó–∞–¥–∞—á: <span class="meta-strong">{{ assignment.tasks|length }}</span></span>
                            <span class="pill">üë• –£—á–µ–Ω–∏–∫–æ–≤: <span class="meta-strong">{{ counts.total if counts is defined else (submissions|length) }}</span></span>
                        </div>
                    </div>

                    <div style="display:flex; gap:.6rem; flex-wrap: wrap; align-items:center; justify-content:flex-end;">
                        {% if can_manage %}
                        <button type="button" class="neo-button outline" onclick="duplicateAssignment({{ assignment.assignment_id }})">
                            <i class="fas fa-clone ui-icon ui-icon--sm"></i> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        {% if assignment.is_active %}
                        <button type="button" class="neo-button ghost" onclick="archiveAssignment({{ assignment.assignment_id }})" style="color: var(--danger);">
                            <i class="fas fa-archive ui-icon ui-icon--sm"></i> –í –∞—Ä—Ö–∏–≤
                        </button>
                        {% endif %}
                        {% endif %}
                        <a href="{{ url_for('lessons.review_queue', source='assignments', status='submitted') }}" class="neo-button ghost" style="text-decoration:none;">
                            ‚úÖ –û—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </a>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi">
                        <div class="kpi-label">–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
                        <div class="kpi-value">{{ (counts.needs_grading if counts is defined else 0) }}</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">–°–¥–∞–Ω–æ</div>
                        <div class="kpi-value">{{ (counts.submitted if counts is defined else 0) }}</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ</div>
                        <div class="kpi-value">{{ (counts.returned if counts is defined else 0) }}</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                        <div class="kpi-value">{{ (counts.in_progress if counts is defined else 0) }}</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</div>
                        <div class="kpi-value">{{ (counts.assigned if counts is defined else 0) }}</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                        <div class="kpi-value">{{ (counts.graded if counts is defined else 0) }}</div>
                    </div>
                </div>
            </section>

            <div class="layout">
                <section class="card">
                    <h2 class="card-title">–°–¥–∞—á–∏</h2>
                    <div class="card-sub">–§–∏–ª—å—Ç—Ä—É–π –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–¥–∞—á–∏.</div>

                    <form method="GET" class="filters">
                        <div>
                            <label class="filter-label" for="status">–°—Ç–∞—Ç—É—Å</label>
                            <select class="neo-select" id="status" name="status">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ</option>
                                <option value="needs_grading" {% if status_filter == 'needs_grading' %}selected{% endif %}>–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</option>
                                <option value="returned" {% if status_filter == 'returned' %}selected{% endif %}>–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>–ù–µ —Å–¥–∞–Ω–æ</option>
                                <option value="graded" {% if status_filter == 'graded' %}selected{% endif %}>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</option>
                            </select>
                        </div>
                        <div>
                            <label class="filter-label" for="student">–£—á–µ–Ω–∏–∫</label>
                            <input class="neo-input" id="student" name="student" value="{{ student_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏‚Ä¶">
                        </div>
                        <div style="display:flex; gap:.6rem; justify-content:flex-end; flex-wrap:wrap;">
                            <button type="submit" class="neo-button accent">
                                <i class="fas fa-filter ui-icon ui-icon--sm"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                            <a href="{{ url_for('assignments.assignment_view', assignment_id=assignment.assignment_id) }}" class="neo-button outline" style="text-decoration:none;">
                                <i class="fas fa-rotate-left ui-icon ui-icon--sm"></i> –°–±—Ä–æ—Å
                            </a>
                        </div>
                    </form>

                    {% if can_manage and status_filter in ['all', 'needs_grading'] and (counts.needs_grading if counts is defined else 0) > 0 %}
                    <div style="margin-top: 0.9rem; display:flex; gap:.6rem; flex-wrap:wrap; align-items:center;">
                        <form method="POST" action="{{ url_for('assignments.assignment_review_bulk_update', assignment_id=assignment.assignment_id) }}">
                            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                            <input type="hidden" name="action" value="mark_returned">
                            <input type="hidden" name="status" value="submitted">
                            <input type="hidden" name="source" value="assignments">
                            <input type="hidden" name="assignment_type" value="{{ assignment.assignment_type }}">
                            <input type="hidden" name="student" value="">
                            <button type="submit" class="neo-button ghost" style="color: var(--warning);">
                                <i class="fas fa-undo ui-icon ui-icon--sm"></i> –í–µ—Ä–Ω—É—Ç—å –≤—Å–µ —Å–¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
                            </button>
                        </form>
                        <div style="color: var(--text-muted); font-size: 0.92rem; line-height: 1.45;">
                            –ú–∞—Å—Å–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Å–¥–∞—á–∞–º —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–°–¥–∞–Ω–æ¬ª.
                        </div>
                    </div>
                    {% endif %}

                    <div class="submissions">
                        {% if submissions and submissions|length > 0 %}
                            {% for submission in submissions %}
                            {% set st = (submission.status or '')|lower %}
                            <div class="sub-card">
                                <div class="sub-head">
                                    <div style="min-width: 0;">
                                        <div class="sub-name">{{ submission.student.name if submission.student else '‚Äî' }}</div>
                                        <div class="sub-meta">
                                            <span class="status-badge status-{{ st }}">
                                                {% if submission.status == 'ASSIGNED' %}–ù–∞–∑–Ω–∞—á–µ–Ω–æ
                                                {% elif submission.status == 'IN_PROGRESS' %}–í –ø—Ä–æ—Ü–µ—Å—Å–µ
                                                {% elif submission.status == 'SUBMITTED' %}–°–¥–∞–Ω–æ
                                                {% elif submission.status == 'LATE' %}–°–¥–∞–Ω–æ (–ø–æ–∑–¥–Ω–æ)
                                                {% elif submission.status == 'GRADED' %}–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
                                                {% elif submission.status == 'RETURNED' %}–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
                                                {% else %}{{ submission.status }}{% endif %}
                                            </span>
                                            {% if submission.submitted_at %}
                                            <span>üïí {{ submission.submitted_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:flex-end;">
                                        <a href="{{ url_for('assignments.submission_grade_view', submission_id=submission.submission_id) }}" class="neo-button outline sm" style="text-decoration:none;">
                                            –û—Ç–∫—Ä—ã—Ç—å
                                        </a>
                                        {% if submission.status in ['SUBMITTED', 'LATE'] %}
                                        <a href="{{ url_for('assignments.submission_grade_view', submission_id=submission.submission_id) }}" class="neo-button accent sm" style="text-decoration:none;">
                                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if submission.status == 'GRADED' and submission.total_score is not none and submission.max_score is not none %}
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--stroke-1); display:flex; justify-content: space-between; gap: .75rem; flex-wrap: wrap; align-items:center;">
                                    <div style="color: var(--text-muted);">
                                        –ò—Ç–æ–≥:
                                        <span class="meta-strong">{{ submission.total_score }}/{{ submission.max_score }}</span>
                                    </div>
                                    <span class="pill pill--success">
                                        {{ "%.1f"|format(submission.percentage) }}%
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="margin-top: 0.9rem; color: var(--text-muted);">
                                –ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º —Å–¥–∞—á –Ω–µ—Ç.
                            </div>
                        {% endif %}
                    </div>
                </section>

                <section class="card">
                    <h2 class="card-title">–ó–∞–¥–∞—á–∏</h2>
                    <div class="card-sub">–°–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç—ã. –î–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã —Ä–∞–∑–≤–µ—Ä–Ω–∏ –Ω—É–∂–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ.</div>

                    <div class="task-list">
                        {% for task in assignment.tasks|sort(attribute='order_index') %}
                        <div class="task">
                            <details class="task-details">
                                <summary>
                                    <div style="min-width: 0;">
                                        <div class="task-title">–ó–∞–¥–∞–Ω–∏–µ ‚Ññ{{ task.task.task_number }}</div>
                                        <div class="task-sub">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: <span class="meta-strong">{{ task.max_score }}</span></div>
                                    </div>
                                    <div style="display:flex; gap:.4rem; flex-wrap: wrap; align-items:center; justify-content:flex-end;">
                                        {% if task.requires_manual_grading %}
                                        <span class="pill pill--warning">–†—É—á–Ω–∞—è</span>
                                        {% else %}
                                        <span class="pill pill--success">–ê–≤—Ç–æ</span>
                                        {% endif %}
                                        <span class="summary-hint">–û—Ç–∫—Ä—ã—Ç—å</span>
                                    </div>
                                </summary>
                                <div class="task-body">
                                    {{ task.task.content_html|safe }}
                                </div>
                            </details>
                        </div>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        (function () {
            'use strict';

            const CSRF_TOKEN = (document.querySelector('meta[name="csrf-token"]') || { getAttribute: () => null }).getAttribute('content') || '';

            function toastAny(type, msg) {
                try {
                    const t = (window.toast || (typeof toast !== 'undefined' ? toast : null));
                    if (!t) return;
                    if (type === 'success') t.success(msg);
                    else if (type === 'warning') t.warning(msg);
                    else if (type === 'info') t.info(msg);
                    else t.error(msg);
                } catch (e) {}
            }

            async function postJson(url, payload) {
                const headers = { 'Content-Type': 'application/json' };
                if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

                const res = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: payload ? JSON.stringify(payload) : JSON.stringify({}),
                    credentials: 'same-origin',
                });

                let data = null;
                try { data = await res.json(); } catch (e) { data = null; }
                return { ok: res.ok, status: res.status, data };
            }

            window.archiveAssignment = async function (assignmentId) {
                try {
                    if (!assignmentId) return;
                    const confirmed = window.confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É? –û–Ω–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–Ω–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–µ).');
                    if (!confirmed) return;

                    const url = '/assignments/' + encodeURIComponent(String(assignmentId)) + '/archive';
                    const { ok, data } = await postJson(url, {});
                    if (!ok || !data || !data.success) {
                        toastAny('error', (data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å.');
                        return;
                    }
                    toastAny('success', '–†–∞–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤.');
                    window.location.href = '/assignments?status=archived&archived=1';
                } catch (e) {
                    toastAny('error', '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.');
                }
            };

            window.duplicateAssignment = async function (assignmentId) {
                try {
                    if (!assignmentId) return;
                    const confirmed = window.confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —Ä–∞–±–æ—Ç—ã –∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ–º –∂–µ —É—á–µ–Ω–∏–∫–∞–º (–¥–µ–¥–ª–∞–π–Ω +7 –¥–Ω–µ–π)?');
                    if (!confirmed) return;

                    const url = '/assignments/' + encodeURIComponent(String(assignmentId)) + '/duplicate';
                    const { ok, data } = await postJson(url, {});
                    if (!ok || !data || !data.success) {
                        toastAny('error', (data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é.');
                        return;
                    }
                    const newId = data.assignment_id;
                    toastAny('success', '–ö–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶');
                    if (newId) {
                        window.location.href = '/assignments/' + encodeURIComponent(String(newId));
                    } else {
                        window.location.reload();
                    }
                } catch (e) {
                    toastAny('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–ø–∏–∏.');
                }
            };
        })();
    </script>
</body>
</html>
