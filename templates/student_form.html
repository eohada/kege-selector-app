<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} ¬∑ –ß—ë—Ä–Ω—ã–π –Ω–µ–æ–Ω</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
    {% include '_ux_enhancements.html' %}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .form-hero {
            margin-bottom: 2rem;
        }
        
        .form-section {
            background: var(--surface-1);
            border: 1px solid var(--stroke-1);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--stroke-1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        .form-grid.form-grid-compact {
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
        
        .form-grid .neo-field {
            display: flex;
            flex-direction: column;
        }
        
        .form-grid.form-grid-compact .neo-label {
            min-height: 2.8em;
            display: flex;
            align-items: flex-start;
        }
        
        .form-grid-full {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body class="{% if active_lesson %}lesson-active{% endif %}">
    {% if active_lesson %}
    <div class="now-playing-pill" onclick="toggleLessonMenu()">
        <img src="{{ url_for('static', filename='icons/icons8-–Ω–∞—É—à–Ω–∏–∫–∏-100.png') }}" alt="–£—Ä–æ–∫" class="ui-icon ui-icon--sm"> –£—Ä–æ–∫ –∏–¥–µ—Ç: {{ active_student.name }}
    </div>
    <div class="now-playing-panel" id="lessonMenu">
        <div class="hero-eyebrow">—Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫</div>
        <p style="margin: 0 0 0.4rem 0;"><strong>–£—á–µ–Ω–∏–∫:</strong> {{ active_student.name }}</p>
        {% if active_lesson.topic %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–¢–µ–º–∞:</strong> {{ active_lesson.topic }}</p>
        {% endif %}
        <p style="margin: 0 0 0.4rem 0;"><strong>–î–∞—Ç–∞:</strong> {{ active_lesson.lesson_date.strftime('%d.%m.%Y %H:%M') }}</p>
        <p style="margin: 0;"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ active_lesson.duration }} –º–∏–Ω—É—Ç</p>
        <div class="hero-actions" style="margin-top: 1rem;">
            <form method="POST" action="{{ url_for('lessons.lesson_complete', lesson_id=active_lesson.lesson_id) }}">
                <button type="submit" class="neo-button accent"><img src="{{ url_for('static', filename='icons/icons8-–≥–∞–ª–æ—á–∫–∞-100.png') }}" alt="–ó–∞–≤–µ—Ä—à–∏—Ç—å" class="ui-icon ui-icon--sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </form>
            <a href="{{ url_for('students.student_profile', student_id=active_student.student_id) }}" class="neo-button ghost"><img src="{{ url_for('static', filename='icons/icons8-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-100.png') }}" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="ui-icon ui-icon--sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
    <script>
        function toggleLessonMenu() {
            const menu = document.getElementById('lessonMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('lessonMenu');
            const badge = document.querySelector('.now-playing-pill');
            if (!menu || !badge) return;
            if (!menu.contains(event.target) && !badge.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
    {% endif %}

    <div class="app-shell">
        {% set active_page = 'dashboard' %}
        {% include '_primary_nav.html' %}

        {# Flash messages –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —á–µ—Ä–µ–∑ toast #}

        <section class="glass-panel form-hero">
            <div>
                <p class="hero-eyebrow">—Ñ–æ—Ä–º–∞ —É—á–µ–Ω–∏–∫–∞</p>
                <h1 class="hero-title">{{ title }}</h1>
            </div>
        </section>

        <form method="POST" data-validate>
            {{ form.hidden_tag() }}
            
            <section class="form-section">
                <div class="form-section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="form-grid">
                    <div class="neo-field">
                        {{ form.name.label(class='neo-label') }}
                        {{ form.name(class='neo-input', placeholder='–ü–µ—Ç—è', required=True, minlength=2, **{'data-tooltip': '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)'}) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ü–æ–ª–Ω–æ–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.platform_id.label(class='neo-label') }}
                        {{ form.platform_id(class='neo-input', placeholder='–ú–æ—Ä–∫–æ–≤–Ω–∞—è —á–∞–π–∫–∞ 53...') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.category.label(class='neo-label') }}
                        {{ form.category(class='neo-select') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—á–µ–Ω–∏–∫–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</small>
                    </div>
                    <div class="neo-field"> <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞ -->
                        {{ form.school_class.label(class='neo-label') }} {# –ü–æ–¥–ø–∏—Å—å —Å–µ–ª–µ–∫—Ç–∞ –∫–ª–∞—Å—Å–∞ #}
                        {{ form.school_class(class='neo-select') }} {# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –∫–ª–∞—Å—Å–∞–º–∏ #}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–£–∫–∞–∂–∏ —Ç–µ–∫—É—â–∏–π —à–∫–æ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å (1-11)</small> <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é -->
                    </div>
                </div>
            </section>
            
            <section class="form-section"> <!-- –ë–ª–æ–∫ —Å —Ü–µ–ª—è–º–∏ –∏ —Å—Ä–æ–∫–∞–º–∏ -->
                <div class="form-section-title"><img src="{{ url_for('static', filename='icons/icons8-–º–∏—à–µ–Ω—å-100.png') }}" alt="–¶–µ–ª–∏" class="ui-icon ui-icon--sm"> –¶–µ–ª–∏ –∏ —Å—Ä–æ–∫–∏</div>
                <div class="form-grid"> <!-- –°–µ—Ç–∫–∞ –¥–ª—è –ø–æ–ª–µ–π –±–ª–æ–∫–∞ -->
                    <div class="neo-field category-field" data-field="numeric-goal"> <!-- –ü–æ–ª–µ —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        <label class="neo-label" for="{{ form.target_score.id }}" id="targetScoreLabel">–¶–µ–ª–µ–≤–æ–π –±–∞–ª–ª (0-100)</label> <!-- –ü–æ–¥–ø–∏—Å—å –¥–ª—è —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        {{ form.target_score(class='neo-input', placeholder='85', type='number', min=0, max=100, **{'data-tooltip': '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –±–∞–ª–ª –æ—Ç 0 –¥–æ 100'}) }} <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        <small id="targetScoreHint" style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–¶–µ–ª–µ–≤–æ–π –±–∞–ª–ª –ï–ì–≠ (0-100)</small> <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏ -->
                    </div>
                    
                    <div class="neo-field category-field" data-field="text-goal"> <!-- –ü–æ–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        {{ form.goal_text.label(class='neo-label') }} <!-- –ü–æ–¥–ø–∏—Å—å —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        {{ form.goal_text(class='neo-input', placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —Ö–∞–∫–∞—Ç–æ–Ω—É –∏–ª–∏ –≤—ã–π—Ç–∏ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å', rows=3) }} <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ü–µ–ª–∏ -->
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–û–ø–∏—à–∏ —Ü–µ–ª—å —Å–ª–æ–≤–∞–º–∏ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –õ–ï–í–ï–õ–ê–ü –∏ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</small> <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ü–µ–ª–∏ -->
                    </div>
                    
                    <div class="neo-field category-field" data-field="deadline"> <!-- –ü–æ–ª–µ —Å—Ä–æ–∫–æ–≤ -->
                        {{ form.deadline.label(class='neo-label') }} <!-- –ü–æ–¥–ø–∏—Å—å –¥–ª—è —Å—Ä–æ–∫–∞ -->
                        {{ form.deadline(class='neo-input', placeholder='–ò—é–Ω—å 2025') }} <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ä–æ–∫–∞ -->
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ö –∫–∞–∫–æ–º—É —Å—Ä–æ–∫—É –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏</small> <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Å—Ä–æ–∫–∞ -->
                    </div>
                    
                    <div class="neo-field category-field" data-field="programming-language"> <!-- –ü–æ–ª–µ —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        {{ form.programming_language.label(class='neo-label') }} <!-- –ü–æ–¥–ø–∏—Å—å –¥–ª—è —è–∑—ã–∫–∞ -->
                        {{ form.programming_language(class='neo-input', placeholder='Python, C++, JavaScript...') }} <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–£–∫–∞–∂–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —è–∑—ã–∫ –¥–ª—è –∑–∞–Ω—è—Ç–∏–π</small> <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —è–∑—ã–∫–∞ -->
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-section-title"><img src="{{ url_for('static', filename='icons/icons8-bar-chart-100.png') }}" alt="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" class="ui-icon ui-icon--sm"> –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∞</div>
                <div class="form-grid form-grid-compact">
                    <div class="neo-field">
                        {{ form.diagnostic_level.label(class='neo-label') }}
                        {{ form.diagnostic_level(class='neo-input', placeholder='60-70 –±–∞–ª–ª–æ–≤') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</small>
                    </div>
                    
                    <div class="neo-field">
                        {{ form.overall_rating.label(class='neo-label') }}
                        {{ form.overall_rating(class='neo-input', placeholder='7/10' or '–•–æ—Ä–æ—à–æ') }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—á–µ–Ω–∏–∫–∞ (—Ü–∏—Ñ—Ä–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç)</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.preferences.label(class='neo-label') }}
                        {{ form.preferences(class='neo-input', placeholder='–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ç–µ–æ—Ä–∏—é —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –ª—é–±–∏—Ç –ø—Ä–∞–∫—Ç–∏–∫—É...', rows=3) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ö–∞–∫ —É—á–µ–Ω–∏–∫ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.strengths.label(class='neo-label') }}
                        {{ form.strengths(class='neo-input', placeholder='–û—Ç–ª–∏—á–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–∞—Ö...', rows=3) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ù–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —É—á–µ–Ω–∏–∫–∞</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.weaknesses.label(class='neo-label') }}
                        {{ form.weaknesses(class='neo-input', placeholder='–ü—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∏–∫–æ–π, –Ω—É–∂–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞...', rows=3) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ù–∞–∏–±–æ–ª–µ–µ —Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —É—á–µ–Ω–∏–∫–∞</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-section-title"><img src="{{ url_for('static', filename='icons/icons8-–¥–æ–∫—É–º–µ–Ω—Ç-100.png') }}" alt="–û–ø–∏—Å–∞–Ω–∏–µ" class="ui-icon ui-icon--sm"> –û–ø–∏—Å–∞–Ω–∏–µ</div>
                <div class="form-grid">
                    <div class="neo-field form-grid-full">
                        {{ form.description.label(class='neo-label') }}
                        {{ form.description(class='neo-input', placeholder='–ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á–µ–Ω–∏–∫, —Ö–æ—Ä–æ—à–æ —É—Å–≤–∞–∏–≤–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª...', rows=4) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞</small>
                    </div>
                    
                    <div class="neo-field form-grid-full">
                        {{ form.notes.label(class='neo-label') }}
                        {{ form.notes(class='neo-input', placeholder='–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏...', rows=5) }}
                        <small style="display: block; color: var(--text-muted); font-size: 0.85em; margin-top: 0.3em;">–õ—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</small>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="form-actions" style="display: flex; gap: 1em; justify-content: flex-end; margin-top: 0;">
                    {{ form.submit(class='neo-button accent') }}
                    <a href="{{ url_for('main.dashboard') }}" class="neo-button ghost">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </section>
        </form>
    </div>
    
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
    <script src="{{ url_for('static', filename='csrf-helper.js') }}"></script>
    <script src="{{ url_for('static', filename='ajax-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <script src="{{ url_for('static', filename='audit-tracker.js') }}"></script>
    <script>
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º flash-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'error' or category == 'danger' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.error('{{ message|e }}');
                            }
                        {% elif category == 'warning' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.warning('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.warning('{{ message|e }}');
                            }
                        {% elif category == 'info' %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.info('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.info('{{ message|e }}');
                            }
                        {% else %}
                            if (typeof toast !== 'undefined' && toast) {
                                toast.success('{{ message|e }}');
                            } else if (window.toast) {
                                window.toast.success('{{ message|e }}');
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ AJAX –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ toast
            // –í—ã–±–∏—Ä–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ (–Ω–µ —Ñ–æ—Ä–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞)
            const studentForm = document.querySelector('section.form-hero') ? 
                document.querySelector('section.form-hero').nextElementSibling?.querySelector('form[method="POST"]') : 
                document.querySelector('form[method="POST"]:not([action*="lesson_complete"])');
            
            if (studentForm) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–æ—Ä–º–∞ —É—á–µ–Ω–∏–∫–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ name)
                const nameField = studentForm.querySelector('input[name="name"]');
                if (nameField && !studentForm.dataset.ajaxHandled) {
                    studentForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(studentForm);
                        const submitButton = studentForm.querySelector('button[type="submit"], input[type="submit"]');
                        const originalText = submitButton ? (submitButton.textContent || submitButton.value) : '';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        let loaderId = null;
                        if (typeof loading !== 'undefined' && loading) {
                            loaderId = loading.show(studentForm, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
                        } else if (submitButton) {
                            submitButton.disabled = true;
                            if (submitButton.tagName === 'BUTTON') {
                                submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                            }
                        }
                        
                        try {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            {% if student and student.student_id %}
                            const isEdit = true;
                            const studentId = {{ student.student_id }};
                            const apiUrl = '{{ url_for("api.api_student_update", student_id=student.student_id) }}';
                            {% else %}
                            const isEdit = false;
                            const apiUrl = '{{ url_for("api.api_student_create") }}';
                            {% endif %}
                            
                            // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
                            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                                            studentForm.querySelector('input[name="csrf_token"]')?.value;
                            
                            const headers = {
                                'X-Requested-With': 'XMLHttpRequest'
                            };
                            
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ AJAX API
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                body: formData,
                                headers: headers
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(errorText || `HTTP error! status: ${response.status}`);
                            }
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —Å—Ä–∞–∑—É
                                if (typeof toast !== 'undefined' && toast) {
                                    toast.success(result.message || (isEdit ? '–î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : '–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!'));
                                }
                                
                                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ dashboard —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                                setTimeout(() => {
                                    {% if student and student.student_id %}
                                    window.location.href = '{{ url_for("students.student_profile", student_id=student.student_id) }}';
                                    {% else %}
                                    window.location.href = '{{ url_for("main.dashboard") }}';
                                    {% endif %}
                                }, 500);
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                                if (typeof toast !== 'undefined' && toast) {
                                    toast.error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                                }
                                
                                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                                if (loaderId && typeof loading !== 'undefined' && loading) {
                                    loading.hide(loaderId);
                                } else if (submitButton) {
                                    submitButton.disabled = false;
                                    if (submitButton.tagName === 'BUTTON') {
                                        submitButton.textContent = originalText;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:', error);
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                            if (typeof toast !== 'undefined' && toast) {
                                toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                            }
                            
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                            if (loaderId && typeof loading !== 'undefined' && loading) {
                                loading.hide(loaderId);
                            } else if (submitButton) {
                                submitButton.disabled = false;
                                if (submitButton.tagName === 'BUTTON') {
                                    submitButton.textContent = originalText;
                                }
                            }
                        }
                    });
                }
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
            const categorySelect = document.querySelector('select[name="category"]'); // –ò—â–µ–º —Å–µ–ª–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const targetInput = document.getElementById('target_score'); // –ë–µ—Ä—ë–º –ø–æ–ª–µ —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏
            const targetLabel = document.getElementById('targetScoreLabel'); // –ë–µ—Ä—ë–º –ø–æ–¥–ø–∏—Å—å —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏
            const targetHint = document.getElementById('targetScoreHint'); // –ë–µ—Ä—ë–º –ø–æ–¥—Å–∫–∞–∑–∫—É —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏
            const fieldMap = { // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è —Å –∫–ª—é—á–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                numericGoal: document.querySelector('[data-field="numeric-goal"]'), // –°–µ–∫—Ü–∏—è —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏
                textGoal: document.querySelector('[data-field="text-goal"]'), // –°–µ–∫—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ü–µ–ª–∏
                deadline: document.querySelector('[data-field="deadline"]'), // –°–µ–∫—Ü–∏—è —Å—Ä–æ–∫–æ–≤
                programmingLanguage: document.querySelector('[data-field="programming-language"]') // –°–µ–∫—Ü–∏—è —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
            };

            const config = { // –û–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                '–ï–ì–≠': { show: ['numericGoal', 'deadline'], label: '–¶–µ–ª–µ–≤–æ–π –±–∞–ª–ª (0-100)', hint: '–¶–µ–ª–µ–≤–æ–π –±–∞–ª–ª –ï–ì–≠ (0-100)', min: 0, max: 100 }, // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ï–ì–≠
                '–û–ì–≠': { show: ['numericGoal', 'deadline'], label: '–¶–µ–ª–µ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (1-5)', hint: '–¶–µ–ª—å –ø–æ –ø—è—Ç–∏–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ', min: 1, max: 5 }, // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –û–ì–≠
                '–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï': { show: ['textGoal', 'programmingLanguage'], label: null }, // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
                '–õ–ï–í–ï–õ–ê–ü': { show: ['textGoal', 'deadline'], label: null } // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –õ–ï–í–ï–õ–ê–ü
            };

            function applyCategory(categoryValue) { // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                const normalized = (categoryValue || '–ï–ì–≠').toUpperCase(); // –ü—Ä–∏–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                const selectedConfig = config[normalized] || config['–ï–ì–≠']; // –ë–µ—Ä—ë–º –∫–æ–Ω—Ñ–∏–≥ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç –ï–ì–≠

                Object.keys(fieldMap).forEach((key) => { // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–µ–∫—Ü–∏—è–º
                    if (selectedConfig.show.includes(key)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–∫—Ü–∏—é
                        fieldMap[key].style.display = ''; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
                    } else {
                        fieldMap[key].style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
                    }
                });

                if (selectedConfig.label && targetLabel && targetInput) { // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∏ –≥—Ä–∞–Ω–∏—Ü—ã —á–∏—Å–ª–æ–≤–æ–π —Ü–µ–ª–∏
                    targetLabel.textContent = selectedConfig.label; // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏
                    targetHint.textContent = selectedConfig.hint; // –ú–µ–Ω—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                    targetInput.min = selectedConfig.min; // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω
                    targetInput.max = selectedConfig.max; // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å
                }
            }

            applyCategory(categorySelect.value); // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            categorySelect.addEventListener('change', (event) => applyCategory(event.target.value)); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        });
    </script>
</body>
</html>
