# Деплой Telegram-бота на Railway

## Вариант 1: Отдельный сервис в том же проекте (рекомендуется)

### Шаг 1: Создание нового сервиса в Railway

1. Откройте ваш проект в Railway Dashboard
2. Нажмите **"+ New"** → **"Empty Service"** (или **"GitHub Repo"** если хотите подключить репозиторий)
3. Назовите сервис: `telegram-bot` или `task-tracker-bot`

### Шаг 2: Настройка источника кода

Если создали Empty Service:
1. Перейдите в **Settings** → **Source**
2. Нажмите **"Connect GitHub Repo"**
3. Выберите ваш репозиторий `kege-selector-app`
4. Railway автоматически начнет деплой

### Шаг 3: Настройка переменных окружения

В **Settings** → **Variables** добавьте все необходимые переменные:

```bash
# Обязательные переменные
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
TELEGRAM_ADMIN_ID=ваш_telegram_id
TELEGRAM_GROUP_ID=id_группы_тестировщиков

# Опциональные переменные
TELEGRAM_TOPIC_ID=id_топика  # Если нужно отправлять ответы в конкретный топик
REPORTS_DB_PATH=data/reports.db  # Путь к базе данных (по умолчанию data/reports.db)
TELEGRAM_BOT_LOG_LEVEL=INFO  # Уровень логирования (INFO, DEBUG)
```

### Шаг 4: Настройка команды запуска

В **Settings** → **Deploy** установите:

**Start Command:**
```
python telegram_bot/run_bot.py
```

Railway автоматически подхватит команду из `telegram_bot/railway.json`, если файл находится в корне проекта. Если создаете отдельный сервис, установите команду вручную в Settings → Deploy.

### Шаг 5: Проверка деплоя

1. Railway автоматически начнет деплой после добавления переменных
2. Проверьте логи в Railway Dashboard → ваш сервис → **Deployments** → последний деплой
3. В логах должно появиться: `Бот запущен и готов к работе`

## Вариант 2: Использование Procfile (если бот в том же сервисе)

Если вы хотите запустить и веб-приложение, и бота в одном сервисе:

1. Обновите `Procfile` в корне проекта:
```
web: gunicorn wsgi:app --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120
bot: python -m telegram_bot.bot
```

2. В Railway создайте два процесса:
   - Основной процесс (web) будет использовать порт $PORT
   - Бот будет работать как отдельный процесс

**⚠️ ВАЖНО:** Railway по умолчанию запускает только процесс `web` из Procfile. Для запуска бота нужно:
- Либо создать отдельный сервис (рекомендуется)
- Либо использовать Railway Workers (платная функция)

## Рекомендуемый подход: Отдельный сервис

**Преимущества:**
- ✅ Независимое масштабирование
- ✅ Отдельные логи
- ✅ Легче управлять перезапусками
- ✅ Не влияет на веб-приложение

## Проверка работы бота

После деплоя:

1. Проверьте логи в Railway Dashboard
2. Отправьте `/start` боту в личке - должен ответить
3. Отправьте тестовое сообщение с тегом `#BUG` в группу
4. Проверьте, что репорт пришел в личку

## Мониторинг

Railway автоматически:
- Перезапускает бота при сбоях
- Показывает логи в реальном времени
- Отправляет уведомления при ошибках

## Обновление бота

При каждом push в репозиторий Railway автоматически:
1. Пересоберет образ
2. Перезапустит бота с новым кодом
3. Сохранит все переменные окружения

## Устранение проблем

### Бот не запускается

1. Проверьте логи в Railway Dashboard
2. Убедитесь, что все переменные окружения установлены
3. Проверьте, что `TELEGRAM_BOT_TOKEN` правильный

### Бот не получает сообщения

1. Проверьте, что `TELEGRAM_GROUP_ID` установлен правильно
2. Убедитесь, что бот добавлен в группу
3. Проверьте, что группа не использует топики (или отключите их)

### Ошибки базы данных

1. Убедитесь, что директория `data/` доступна для записи
2. Проверьте права доступа к файлу базы данных
3. В Railway файлы сохраняются в ephemeral storage (могут удаляться при перезапуске)

**Решение для постоянного хранения:**

#### Вариант 1: Railway Volume (рекомендуется)

1. В Railway Dashboard → ваш сервис → **"+ New"** → **"Volume"**
2. Назовите volume: `bot-data`
3. Mount path: `/app/data`
4. Railway автоматически создаст директорию и сохранит данные

#### Вариант 2: Использовать PostgreSQL

Можно адаптировать код для использования PostgreSQL вместо SQLite, но для бота SQLite с Volume вполне достаточно.

## Использование PostgreSQL для репортов (опционально)

Если хотите использовать PostgreSQL вместо SQLite:

1. Создайте PostgreSQL в Railway
2. Обновите `REPORTS_DB_PATH` на URL PostgreSQL
3. Обновите код в `telegram_bot/models.py` для поддержки PostgreSQL

Но для простоты SQLite тоже работает, просто нужно использовать Volume для постоянного хранения.