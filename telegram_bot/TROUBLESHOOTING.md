# Устранение проблем с ботом на Railway

## Проблема: Бот не запускается / не отвечает

### Симптомы:
- В логах Railway видны только логи веб-приложения (gunicorn)
- Нет логов от бота (например, "Бот запущен и готов к работе")
- Бот не отвечает на команды

### Решение:

#### 1. Проверьте, что создан ОТДЕЛЬНЫЙ сервис для бота

**❌ НЕПРАВИЛЬНО:** Добавлять команду запуска бота в существующий веб-сервис

**✅ ПРАВИЛЬНО:** Создать новый отдельный сервис специально для бота

**Как проверить:**
1. Railway Dashboard → ваш проект
2. Должно быть ДВА сервиса:
   - Один для веб-приложения (например, `web` или `kege-selector-app`)
   - Один для бота (например, `telegram-bot`)

**Если сервиса для бота нет:**
1. Нажмите **"+ New"** → **"Empty Service"**
2. Назовите: `telegram-bot`
3. Подключите репозиторий (Settings → Source → Connect GitHub Repo)
4. Установите переменные окружения (см. QUICK_RAILWAY_DEPLOY.md)
5. Установите Start Command: `python telegram_bot/run_bot.py`

#### 2. Проверьте команду запуска

В Settings → Deploy → Start Command должно быть:

```
python telegram_bot/run_bot.py
```

**НЕ используйте:**
- `python -m telegram_bot.bot` (может не работать из-за структуры модуля)
- `gunicorn wsgi:app` (это для веб-приложения)

#### 3. Проверьте переменные окружения

В Settings → Variables должны быть установлены:

```
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
TELEGRAM_ADMIN_ID=ваш_telegram_id
TELEGRAM_GROUP_ID=id_группы
```

**Как проверить:**
1. Railway Dashboard → ваш сервис бота → Settings → Variables
2. Убедитесь, что все переменные установлены
3. Проверьте, что значения правильные (без лишних пробелов, кавычек)

#### 4. Проверьте логи

1. Railway Dashboard → ваш сервис бота → Deployments → последний деплой → Logs
2. Ищите ошибки:
   - `TELEGRAM_BOT_TOKEN не установлен` → установите переменную
   - `ModuleNotFoundError` → проверьте структуру проекта
   - Другие ошибки → читайте дальше

#### 5. Проверьте структуру проекта

Убедитесь, что в репозитории есть:
```
telegram_bot/
  ├── __init__.py
  ├── bot.py
  ├── models.py
  └── run_bot.py
```

## Проблема: Бот запускается, но не получает сообщения

### Решение:

1. **Проверьте, что бот добавлен в группу:**
   - Откройте группу в Telegram
   - Убедитесь, что бот есть в списке участников
   - Проверьте, что у бота есть права на чтение сообщений

2. **Проверьте TELEGRAM_GROUP_ID:**
   - Используйте команду `/getid` в группе (если бот отвечает)
   - Или используйте бота @userinfobot для получения ID группы
   - Убедитесь, что ID правильный (отрицательное число для групп)

3. **Проверьте топики:**
   - Если группа использует топики, бот может не получать сообщения
   - См. `TOPICS_PROBLEM.md` для решения

4. **Проверьте логи:**
   - В логах должны появляться сообщения типа `[DEBUG] ВСЕ сообщения: ...`
   - Если их нет, бот не получает обновления от Telegram

## Проблема: Ошибки базы данных

### Симптомы:
- `sqlite3.OperationalError: unable to open database file`
- `Permission denied`

### Решение:

1. **Используйте Railway Volume для постоянного хранения:**
   - Railway Dashboard → ваш сервис бота → **"+ New"** → **"Volume"**
   - Название: `bot-data`
   - Mount path: `/app/data`
   - Это создаст постоянную директорию для базы данных

2. **Или измените путь к базе данных:**
   - Установите переменную окружения `REPORTS_DB_PATH=/tmp/reports.db`
   - Но данные будут теряться при перезапуске (используйте Volume!)

## Проблема: Бот падает при запуске

### Проверьте логи на ошибки:

1. **Ошибка импорта:**
   ```
   ModuleNotFoundError: No module named 'telegram'
   ```
   → Проверьте `requirements.txt`, должно быть `python-telegram-bot>=22.5`

2. **Ошибка токена:**
   ```
   ValueError: TELEGRAM_BOT_TOKEN не установлен
   ```
   → Установите переменную окружения `TELEGRAM_BOT_TOKEN`

3. **Ошибка версии Python:**
   - Railway использует Python из `nixpacks.toml` или определяет автоматически
   - Убедитесь, что версия Python >= 3.11

## Как проверить, что бот работает

1. **Проверьте логи:**
   - Должна быть строка: `Бот запущен и готов к работе`
   - Должна быть информация о боте: `Бот: @your_bot_username (ID: ...)`

2. **Отправьте команду `/start` боту в личке:**
   - Бот должен ответить приветственным сообщением

3. **Отправьте тестовое сообщение с тегом в группу:**
   - Например: `#BUG тест`
   - Репорт должен прийти в личку

## Полезные команды для диагностики

### В Railway Dashboard:
- **Logs** → смотреть логи в реальном времени
- **Metrics** → смотреть использование ресурсов
- **Settings → Deploy** → проверить команду запуска
- **Settings → Variables** → проверить переменные окружения

### Через Railway CLI:
```bash
# Посмотреть логи
railway logs

# Посмотреть переменные окружения
railway variables

# Открыть shell в сервисе
railway shell
```

## Если ничего не помогает

1. **Пересоздайте сервис:**
   - Удалите старый сервис бота
   - Создайте новый по инструкции из QUICK_RAILWAY_DEPLOY.md

2. **Проверьте локально:**
   - Запустите бота локально: `python telegram_bot/run_bot.py`
   - Если работает локально, но не на Railway → проблема в конфигурации Railway

3. **Проверьте документацию Railway:**
   - https://docs.railway.app/
   - Особенно раздел про Workers и Background Jobs