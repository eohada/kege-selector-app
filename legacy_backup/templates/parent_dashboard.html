<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ —Ä–æ–¥–∏—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast.css') }}">
    {% include '_ux_enhancements.html' %}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <style>
        .child-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .child-selector-btn {
            padding: 0.75rem 1.5rem;
            background: var(--surface-2);
            border: 1px solid var(--stroke-1);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-base);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .child-selector-btn:hover {
            background: var(--surface-3);
            border-color: var(--accent-1);
        }
        
        .child-selector-btn.active {
            background: var(--accent-1);
            border-color: var(--accent-1);
            color: white;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            padding: 1.5rem;
            background: var(--surface-2);
            border-radius: 8px;
            border: 1px solid var(--stroke-1);
        }
        
        .metric-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .metric-delta {
            font-size: 0.85em;
            color: var(--text-muted);
        }
        
        .ai-summary {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
            border-radius: 8px;
            color: white;
            margin-bottom: 2rem;
        }
        
        .ai-summary h3 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
        }
        
        .ai-summary p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .lessons-list {
            display: grid;
            gap: 1rem;
        }
        
        .lesson-item {
            padding: 1rem;
            background: var(--surface-2);
            border-radius: 8px;
            border: 1px solid var(--stroke-1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .lesson-date {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .lesson-status {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .lesson-status.completed {
            background: #22c55e;
            color: white;
        }
        
        .lesson-status.planned {
            background: #3b82f6;
            color: white;
        }
        
        .lesson-status.cancelled {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        {% set active_page = 'parent_dashboard' %}
        {% include '_primary_nav.html' %}
        
        <main class="main-content">
            <div class="content-container">
                <section class="glass-panel" style="margin-bottom: 2rem;">
                    <div class="panel-head">
                        <div>
                            <p class="eyebrow">–¥–∞—à–±–æ—Ä–¥ —Ä–æ–¥–∏—Ç–µ–ª—è</p>
                            <h1>–ú–æ–∏ –¥–µ—Ç–∏</h1>
                        </div>
                    </div>
                    
                    {% if children %}
                    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –¥–µ—Ç–µ–π -->
                    <div class="child-selector">
                        {% for child in children %}
                        <a href="{{ url_for('parents.parent_dashboard', student_id=child.user_id) }}" 
                           class="child-selector-btn {% if child.is_selected %}active{% endif %}">
                            {{ child.student_name }}
                        </a>
                        {% endfor %}
                    </div>
                    
                    {% if selected_child %}
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–µ–±–µ–Ω–∫–µ -->
                    <div style="margin-top: 2rem;">
                        <h2 style="margin-bottom: 1rem;">{{ selected_child.name }}</h2>
                        
                        <!-- –ë–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ -->
                        {% if financial_data.can_topup %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">—Ñ–∏–Ω–∞–Ω—Å—ã</p>
                                    <h2>–ë–∞–ª–∞–Ω—Å —É—Ä–æ–∫–æ–≤</h2>
                                </div>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">–û—Å—Ç–∞—Ç–æ–∫ —É—Ä–æ–∫–æ–≤</div>
                                    <div class="metric-value">{{ financial_data.lessons_remaining }}</div>
                                    <div class="metric-delta">–û–ø–ª–∞—á–µ–Ω–æ: {{ financial_data.total_paid }}</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button class="neo-button accent">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                            </div>
                        </section>
                        {% endif %}
                        
                        <!-- –ë–ª–æ–∫ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ (AI Summary) -->
                        {% if child_stats and child_stats.ai_summary %}
                        <section class="ai-summary" style="margin-bottom: 2rem;">
                            <h3>üìä –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                            <p>
                                –ó–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é <strong>{{ selected_child_name }}</strong> —Ä–µ—à–∏–ª(–∞) 
                                <strong>{{ child_stats.ai_summary.tasks_solved_week }}</strong> –∑–∞–¥–∞—á.
                            </p>
                            {% if child_stats.ai_summary.problem_topic %}
                            <p>
                                –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Ç–µ–º–∞: <strong>{{ child_stats.ai_summary.problem_topic }}</strong>
                            </p>
                            {% endif %}
                            {% if child_stats.ai_summary.gpa_forecast %}
                            <p>
                                –ü—Ä–æ–≥–Ω–æ–∑ –±–∞–ª–ª–∞ –ï–ì–≠: <strong>{{ child_stats.ai_summary.gpa_forecast }}</strong>
                            </p>
                            {% endif %}
                        </section>
                        {% endif %}
                        
                        <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
                        {% if child_stats and child_stats.metrics %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
                                    <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                                </div>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (–î–ó)</div>
                                    <div class="metric-value">{{ child_stats.metrics.hw_gpa|round(1) if child_stats.metrics.hw_gpa else 'N/A' }}</div>
                                    <div class="metric-delta">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (–≠–∫–∑–∞–º–µ–Ω—ã)</div>
                                    <div class="metric-value">{{ child_stats.metrics.exam_gpa|round(1) if child_stats.metrics.exam_gpa else 'N/A' }}</div>
                                    <div class="metric-delta">–≠–∫–∑–∞–º–µ–Ω—ã</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤</div>
                                    <div class="metric-value">{{ child_stats.metrics.completed_lessons }}</div>
                                    <div class="metric-delta">–∏–∑ {{ child_stats.metrics.total_lessons }}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                                    <div class="metric-value">{{ child_stats.metrics.missed_lessons }}</div>
                                </div>
                            </div>
                        </section>
                        {% endif %}
                        
                        <!-- –ó–∞–¥–∞–Ω–∏—è (Assignments) -->
                        {% if pending_assignments or recent_submissions %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">–æ–±—É—á–µ–Ω–∏–µ</p>
                                    <h2>–ó–∞–¥–∞–Ω–∏—è</h2>
                                </div>
                            </div>
                            
                            <div style="display: grid; gap: 2rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                                <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è -->
                                <div>
                                    <h3 style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">–ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å</h3>
                                    {% if pending_assignments %}
                                        <div class="lessons-list">
                                            {% for sub in pending_assignments %}
                                            <div class="lesson-item" style="align-items: flex-start;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 500; color: var(--text-primary);">
                                                        {{ sub.assignment.title }}
                                                    </div>
                                                    {% if sub.assignment.deadline %}
                                                    <div style="font-size: 0.85em; margin-top: 0.25rem; {% if sub.assignment.deadline < moscow_now() %}color: var(--danger);{% else %}color: var(--text-muted);{% endif %}">
                                                        –î–µ–¥–ª–∞–π–Ω: {{ sub.assignment.deadline.strftime('%d.%m %H:%M') }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="lesson-status" style="background: var(--surface-3); color: var(--text-muted);">
                                                    {{ sub.status }}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p style="color: var(--text-muted); font-size: 0.9em; font-style: italic;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                                    {% endif %}
                                </div>
                                
                                <!-- –ù–µ–¥–∞–≤–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                                <div>
                                    <h3 style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">–ù–µ–¥–∞–≤–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                                    {% if recent_submissions %}
                                        <div class="lessons-list">
                                            {% for sub in recent_submissions %}
                                            <div class="lesson-item">
                                                <div>
                                                    <div style="font-weight: 500; color: var(--text-primary);">
                                                        {{ sub.assignment.title }}
                                                    </div>
                                                    <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 0.25rem;">
                                                        –°–¥–∞–Ω–æ: {{ sub.submitted_at.strftime('%d.%m') if sub.submitted_at else '-' }}
                                                    </div>
                                                </div>
                                                {% if sub.status == 'GRADED' %}
                                                    <div class="lesson-status completed">
                                                        {{ sub.percentage|round|int }}%
                                                    </div>
                                                {% else %}
                                                    <div class="lesson-status planned">
                                                        –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p style="color: var(--text-muted); font-size: 0.9em; font-style: italic;">–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
                                    {% endif %}
                                </div>
                            </div>
                        </section>
                        {% endif %}
                        
                        <!-- –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —É—Ä–æ–∫–∏ -->
                        {% if upcoming_lessons %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</p>
                                    <h2>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —É—Ä–æ–∫–∏</h2>
                                </div>
                            </div>
                            <div class="lessons-list">
                                {% for lesson in upcoming_lessons %}
                                <div class="lesson-item">
                                    <div>
                                        <div class="lesson-date">
                                            {{ lesson.lesson_date.strftime('%d.%m.%Y %H:%M') if lesson.lesson_date else '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' }}
                                        </div>
                                        {% if lesson.topic %}
                                        <div style="font-size: 0.9em; color: var(--text-muted); margin-top: 0.25rem;">
                                            {{ lesson.topic }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="lesson-status planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</div>
                                </div>
                                {% endfor %}
                            </div>
                        </section>
                        {% endif %}
                        
                        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —É—Ä–æ–∫–∏ -->
                        {% if recent_lessons %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">–∏—Å—Ç–æ—Ä–∏—è</p>
                                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —É—Ä–æ–∫–∏</h2>
                                </div>
                            </div>
                            <div class="lessons-list">
                                {% for lesson in recent_lessons %}
                                <div class="lesson-item">
                                    <div>
                                        <div class="lesson-date">
                                            {{ lesson.lesson_date.strftime('%d.%m.%Y %H:%M') if lesson.lesson_date else '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' }}
                                        </div>
                                        {% if lesson.topic %}
                                        <div style="font-size: 0.9em; color: var(--text-muted); margin-top: 0.25rem;">
                                            {{ lesson.topic }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="lesson-status {% if lesson.status == 'completed' %}completed{% elif lesson.status == 'cancelled' %}cancelled{% else %}planned{% endif %}">
                                        {% if lesson.status == 'completed' %}
                                            –ü—Ä–æ–≤–µ–¥–µ–Ω
                                        {% elif lesson.status == 'cancelled' %}
                                            –û—Ç–º–µ–Ω–µ–Ω
                                        {% else %}
                                            {{ lesson.status }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </section>
                        {% endif %}
                        
                        <!-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ–º—ã -->
                        {% if child_stats and child_stats.problem_topics %}
                        <section class="glass-panel" style="margin-bottom: 2rem;">
                            <div class="panel-head">
                                <div>
                                    <p class="eyebrow">—Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</p>
                                    <h2>–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ–º—ã</h2>
                                </div>
                            </div>
                            <div style="margin-top: 1.5rem;">
                                <div style="display: grid; gap: 1rem;">
                                    {% for topic in child_stats.problem_topics %}
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--surface-2); border-radius: 8px; border: 1px solid var(--stroke-1);">
                                        <div>
                                            <span style="font-weight: 500;">{{ topic.name }}</span>
                                            <span style="color: var(--text-muted); margin-left: 1rem;">{{ topic.avg_score }}%</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </section>
                        {% endif %}
                    </div>
                    {% else %}
                    <p style="color: var(--text-muted); text-align: center; padding: 2rem;">
                        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
                    </p>
                    {% endif %}
                    
                    {% else %}
                    <div style="text-align: center; padding: 3rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–µ—Ç–µ–π
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.9em;">
                            –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞
                        </p>
                    </div>
                    {% endif %}
                </section>
            </div>
        </main>
    </div>
    
    <script src="{{ url_for('static', filename='toast.js') }}"></script>
</body>
</html>
