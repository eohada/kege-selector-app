# Решение проблем с Railway окружениями (Production vs Sandbox)

## Проблема
В production все работает корректно, а в sandbox с тем же кодом функционал работает плохо или не работает вовсе.

## Систематическая диагностика

### Шаг 1: Используйте диагностический endpoint

1. Откройте в браузере:
   - **Production**: `https://your-production-app.railway.app/admin/diagnostics`
   - **Sandbox**: `https://your-sandbox-app.railway.app/admin/diagnostics`

2. Сравните данные между окружениями

3. Обратите внимание на:
   - Количество данных в БД (может быть пустая БД в sandbox)
   - Статус подключения к БД
   - Наличие всех таблиц
   - Переменные окружения

### Шаг 2: Проверьте логи Railway

В Railway интерфейсе:
1. Откройте сервис
2. Перейдите на вкладку "Deployments"
3. Выберите последний деплой
4. Просмотрите логи запуска

**Что искать в логах:**
- `Environment: production` или `Environment: sandbox`
- `Database connection: OK` или `Database connection: FAILED`
- Ошибки подключения к БД
- Предупреждения о переменных окружения

### Шаг 3: Проверьте переменные окружения

В Railway:
1. Откройте проект
2. Переключитесь между окружениями (production/sandbox)
3. Для каждого окружения:
   - Settings → Variables
   - Проверьте наличие всех переменных

**Критичные переменные:**
- `ENVIRONMENT` - должно быть `production` или `sandbox`
- `DATABASE_URL` - должен быть установлен автоматически Railway
- `SECRET_KEY` - должен быть уникальным для каждого окружения
- `DATABASE_EXTERNAL_URL` или `POSTGRES_URL` - опционально, для внешних подключений

### Шаг 4: Проверьте базы данных

**Проблема #1: Пустая база данных в sandbox**

Если в sandbox БД пустая или не инициализирована:

1. Проверьте количество данных:
   ```sql
   SELECT COUNT(*) FROM "Students";
   SELECT COUNT(*) FROM "Lessons";
   SELECT COUNT(*) FROM "Users";
   ```

2. Если БД пустая, синхронизируйте данные:
   - Используйте скрипт `scripts/sync_to_sandbox.py`
   - Или вручную скопируйте данные из production

**Проблема #2: Отсутствующие таблицы**

Если таблицы не созданы:

1. Проверьте логи при запуске - должны быть сообщения о создании таблиц
2. Если таблиц нет, выполните миграцию:
   ```python
   from app import create_app
   app = create_app()
   with app.app_context():
       db.create_all()
   ```

**Проблема #3: Проблемы с подключением**

Если подключение к БД не работает:

1. Проверьте `DATABASE_URL` в переменных окружения
2. Убедитесь, что PostgreSQL сервис запущен
3. Проверьте, что используется правильный URL (внутренний или внешний)

### Шаг 5: Типичные различия между окружениями

#### 1. Разные базы данных
- **Production**: БД с реальными данными
- **Sandbox**: Может быть пустая БД или с тестовыми данными

**Решение**: Синхронизируйте данные через скрипт или вручную

#### 2. Разные SECRET_KEY
- Каждое окружение должно иметь свой уникальный `SECRET_KEY`
- Если ключи одинаковые, могут быть проблемы с сессиями

**Решение**: Убедитесь, что в каждом окружении свой `SECRET_KEY`

#### 3. Разные версии зависимостей
- Хотя код одинаковый, версии пакетов могут отличаться

**Решение**: Проверьте `requirements.txt` и убедитесь, что версии зафиксированы

#### 4. Разные ресурсы Railway
- Sandbox может иметь меньше ресурсов (CPU, RAM)

**Решение**: Проверьте настройки ресурсов в Railway

#### 5. Проблемы с таймаутами
- Sandbox может быть медленнее из-за меньших ресурсов

**Решение**: Увеличьте таймауты в `Procfile`:
```
web: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120
```

### Шаг 6: Проверка функциональности

После проверки конфигурации, проверьте конкретные функции:

1. **Авторизация**
   - Войдите в систему в обоих окружениях
   - Проверьте, что сессии работают

2. **Работа с данными**
   - Создайте тестового ученика
   - Создайте тестовый урок
   - Проверьте, что данные сохраняются

3. **API endpoints**
   - Проверьте работу API через диагностический endpoint
   - Проверьте логи на наличие ошибок

### Шаг 7: Сравнение логов

Сравните логи запуска в обоих окружениях:

**Production должен показывать:**
```
Environment: production
Database connection: OK
Using DATABASE_URL (internal Railway connection)
✓ Database connection: OK
```

**Sandbox должен показывать:**
```
Environment: sandbox
Database connection: OK
Using DATABASE_URL (internal Railway connection)
✓ Database connection: OK
```

Если в sandbox есть ошибки подключения - это основная проблема.

## Быстрая проверка

Выполните эти команды в Railway CLI для каждого окружения:

```bash
# Проверка переменных окружения
railway variables

# Проверка подключения к БД
railway run python -c "from app import create_app; app = create_app(); print('OK')"

# Проверка данных в БД
railway run python -c "from app import create_app; from app.models import Student, Lesson; app = create_app(); app.app_context().push(); print(f'Students: {Student.query.count()}, Lessons: {Lesson.query.count()}')"
```

## Частые проблемы и решения

### Проблема: "Функционал не работает"
**Причина**: Пустая БД в sandbox
**Решение**: Синхронизируйте данные из production

### Проблема: "Ошибки подключения к БД"
**Причина**: Неправильный DATABASE_URL или БД не запущена
**Решение**: Проверьте переменные окружения и статус PostgreSQL сервиса

### Проблема: "Сессии не работают"
**Причина**: Одинаковый SECRET_KEY в обоих окружениях
**Решение**: Установите разные SECRET_KEY для каждого окружения

### Проблема: "Медленная работа"
**Причина**: Меньше ресурсов в sandbox
**Решение**: Увеличьте ресурсы или оптимизируйте запросы

## Контрольный список

- [ ] Диагностический endpoint открывается в обоих окружениях
- [ ] DATABASE_URL установлен в обоих окружениях
- [ ] SECRET_KEY установлен и уникален для каждого окружения
- [ ] ENVIRONMENT установлен правильно (production/sandbox)
- [ ] Подключение к БД работает в обоих окружениях
- [ ] Таблицы созданы в обеих БД
- [ ] Данные синхронизированы (если нужно)
- [ ] Логи не показывают критичных ошибок
- [ ] Функционал работает в production
- [ ] Функционал работает в sandbox

## Получение помощи

Если проблема не решена:

1. Соберите диагностическую информацию:
   - Скриншоты диагностического endpoint из обоих окружений
   - Логи запуска из обоих окружений
   - Список переменных окружения

2. Проверьте:
   - Версии зависимостей
   - Настройки ресурсов Railway
   - Статус сервисов в Railway

3. Создайте issue с собранной информацией

