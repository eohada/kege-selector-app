# Подробный гайд по работе с удаленной админкой

## Содержание

1. [Введение](#введение)
2. [Доступ к админке](#доступ-к-админке)
3. [Настройка окружений](#настройка-окружений)
4. [Дашборд](#дашборд)
5. [Управление пользователями](#управление-пользователями)
6. [Управление правами доступа](#управление-правами-доступа)
7. [Просмотр логов аудита](#просмотр-логов-аудита)
8. [Управление режимом обслуживания](#управление-режимом-обслуживания)
9. [Управление тестерами](#управление-тестерами)
10. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

---

## Введение

Удаленная админка (Remote Admin) — это централизованная панель управления для контроля всех окружений платформы (production, sandbox, admin) из одного места. Она позволяет:

- Управлять пользователями во всех окружениях
- Настраивать права доступа (RBAC)
- Просматривать логи аудита
- Управлять режимом технического обслуживания
- Управлять тестерами
- Мониторить статус окружений

**Важно:** Доступ к удаленной админке имеют только пользователи с ролью `creator`.

---

## Доступ к админке

### URL админки

Админка доступна по адресу: `https://kege-selector-app-admin.up.railway.app/`

При открытии этого URL вы автоматически попадаете на страницу входа в админку.

### Требования для доступа

1. **Роль пользователя:** Только `creator`
2. **Учетные данные:** Логин и пароль пользователя с ролью `creator`
3. **Настроенные переменные окружения:** Для подключения к другим окружениям

### Первый вход

1. Откройте URL админки
2. Введите логин и пароль пользователя с ролью `creator`
3. После успешного входа вы попадете на дашборд админки

**Примечание:** Если у вас нет пользователя с ролью `creator`, его нужно создать через скрипт:

```bash
railway run --service admin python scripts/reset_admin_user.py <username> <password> creator
```

---

## Настройка окружений

### Что такое окружения

Окружения — это отдельные инстансы платформы:
- **Production** — основное рабочее окружение
- **Sandbox** — тестовое окружение
- **Admin** — окружение самой админки

### Настройка переменных окружения

Для подключения к окружениям нужно настроить переменные окружения в Railway для сервиса `admin`:

#### Для Production:

```
PRODUCTION_URL=https://ваш-production.up.railway.app
PRODUCTION_ADMIN_TOKEN=<токен-безопасности>
```

#### Для Sandbox:

```
SANDBOX_URL=https://ваш-sandbox.up.railway.app
SANDBOX_ADMIN_TOKEN=<токен-безопасности>
```

#### Для Admin (опционально):

```
ADMIN_URL=https://kege-selector-app-admin.up.railway.app
ADMIN_ADMIN_TOKEN=<токен-безопасности>
```

### Генерация токенов безопасности

Токены безопасности должны быть одинаковыми на всех сервисах (production, sandbox, admin) и в админке. Это позволяет админке делать запросы к API других окружений.

**Рекомендация:** Используйте длинные случайные строки (минимум 32 символа).

### Проверка настройки окружений

1. Откройте дашборд админки
2. На главной странице отображаются карточки всех настроенных окружений
3. Статус окружения:
   - **Доступно** (зеленый) — окружение настроено и доступно
   - **Недоступно** (красный) — окружение не настроено или недоступно

### Выбор окружения

1. На дашборде нажмите на карточку нужного окружения
2. Окружение будет выбрано для работы
3. Все последующие операции будут выполняться в выбранном окружении

**Примечание:** Выбранное окружение сохраняется в сессии и используется до следующего переключения.

---

## Дашборд

### Главная страница

Дашборд — это главная страница админки, которая открывается после входа.

### Элементы дашборда

1. **Карточки окружений**
   - Отображают все настроенные окружения
   - Показывают статус доступности
   - Позволяют выбрать окружение для работы

2. **Статистика окружений**
   - Количество пользователей
   - Количество активных пользователей
   - Статус базы данных
   - Время последнего обновления

3. **Навигация**
   - Боковое меню со всеми разделами админки
   - Верхняя панель с логотипом и кнопкой выхода

### Обновление статуса

Статус окружений обновляется автоматически при загрузке страницы. Для ручного обновления перезагрузите страницу.

---

## Управление пользователями

### Просмотр списка пользователей

1. В боковом меню выберите **"Пользователи"**
2. Откроется страница со списком всех пользователей выбранного окружения

### Информация о пользователях

Для каждого пользователя отображается:
- **Имя пользователя** (username)
- **Роль** (creator, admin, tutor, student, parent, tester, chief_tester, designer)
- **Email**
- **Статус** (активен/неактивен)
- **Дата создания**
- **Последний вход**

### Создание нового пользователя

**Шаги:**

1. На странице списка пользователей нажмите **"+ Создать пользователя"**
2. Заполните форму:
   - **Логин** (обязательно) — уникальное имя пользователя
   - **Email** (опционально)
   - **Пароль** (обязательно) — минимум 8 символов
   - **Роль** (обязательно) — выберите из списка
   - **Активен** — включите, чтобы пользователь мог войти
3. Нажмите **"Создать"**

**Результат:**
- Пользователь создан
- Автоматически создан профиль пользователя
- Пользователь может войти в систему (если активен)

### Редактирование пользователя

**Шаги:**

1. В списке пользователей нажмите на кнопку **"Редактировать"** рядом с нужным пользователем
2. Измените нужные поля:
   - Логин
   - Email
   - Роль
   - Статус активности
3. Нажмите **"Сохранить"**

**Ограничения:**
- Нельзя изменить роль пользователя `creator`
- Нельзя деактивировать пользователя `creator`

### Удаление пользователя

**Шаги:**

1. В списке пользователей нажмите на кнопку **"Удалить"** рядом с нужным пользователем
2. Подтвердите удаление

**Важно:**
- Удаление пользователя необратимо
- Вместе с пользователем удаляются:
  - Профиль пользователя
  - Все логи аудита, связанные с пользователем
- Нельзя удалить пользователя с ролью `creator`

**Результат:**
- Пользователь удален из системы
- Все связанные данные удалены
- Действие зафиксировано в логах аудита

### Фильтрация пользователей

На странице списка пользователей можно фильтровать по:
- **Роли** — выберите роль из списка
- **Статусу** — активные/неактивные

---

## Управление правами доступа

### Что такое RBAC

RBAC (Role-Based Access Control) — система управления правами доступа на основе ролей. Каждая роль имеет набор прав (permissions), которые определяют, что может делать пользователь с этой ролью.

### Просмотр прав доступа

1. В боковом меню выберите **"Права доступа"**
2. Откроется страница управления правами

### Структура страницы прав

- **Список ролей** — все роли в системе
- **Категории прав** — права сгруппированы по категориям:
  - Управление пользователями
  - Управление контентом
  - Системные настройки
  - Финансы и статистика
  - Инструменты
  - Дизайн и ассеты

### Настройка прав для роли

**Шаги:**

1. Выберите роль из списка
2. Для каждого права:
   - Включите чекбокс, чтобы дать право
   - Выключите чекбокс, чтобы отозвать право
3. Нажмите **"Сохранить изменения"**

**Результат:**
- Права для роли обновлены
- Изменения применяются ко всем пользователям с этой ролью
- Действие зафиксировано в логах аудита

### Права по умолчанию

При первом открытии страницы прав система автоматически инициализирует права по умолчанию для всех ролей:

- **creator** — все права
- **admin** — все права
- **chief_tester** — управление тестерами, заданиями, просмотр пользователей
- **designer** — управление графикой
- **tutor** — создание/редактирование уроков, управление заданиями, проверка работ
- **student** — просмотр работ
- **parent** — просмотр работ
- **tester** — нет прав по умолчанию

### Категории прав

#### Управление пользователями
- `user.view_list` — Просмотр списка пользователей
- `user.create` — Создание пользователей
- `user.edit` — Редактирование пользователей
- `user.delete` — Удаление пользователей
- `user.manage_roles` — Изменение ролей

#### Управление контентом
- `lesson.create` — Создание уроков
- `lesson.edit` — Редактирование уроков
- `lesson.delete` — Удаление уроков
- `task.manage` — Управление банком заданий
- `assignment.create` — Создание и распределение работ
- `assignment.grade` — Проверка работ
- `assignment.view` — Просмотр работ

#### Системные настройки
- `system.logs` — Просмотр логов
- `system.settings` — Настройки системы

#### Финансы и статистика
- `finance.view_stats` — Просмотр общей статистики

#### Инструменты
- `tools.testers` — Управление тестировщиками
- `tools.schedule` — Управление расписанием

#### Дизайн и ассеты
- `assets.manage` — Управление графикой и иконками

---

## Просмотр логов аудита

### Что такое логи аудита

Логи аудита — это записи всех действий пользователей в системе. Они помогают отслеживать:
- Кто и когда выполнил действие
- Какое действие было выполнено
- Результат действия (успех/ошибка)
- Дополнительные метаданные

### Просмотр логов

1. В боковом меню выберите **"Логи аудита"**
2. Откроется страница со списком всех логов выбранного окружения

### Информация в логах

Для каждой записи отображается:
- **Время** — когда было выполнено действие
- **Пользователь** — кто выполнил действие
- **Действие** — тип действия (login, create_user, delete_user, и т.д.)
- **Сущность** — тип объекта (User, Lesson, Student, и т.д.)
- **ID сущности** — идентификатор объекта
- **Статус** — успех (success) или ошибка (error)
- **Метаданные** — дополнительная информация в формате JSON

### Фильтрация логов

На странице логов можно фильтровать по:
- **Пользователю** — выберите пользователя из списка
- **Действию** — выберите тип действия из списка
- **Дате** — выберите диапазон дат

### Типы действий

Основные типы действий, которые логируются:
- `login` — вход в систему
- `logout` — выход из системы
- `create_user` — создание пользователя
- `update_user` — обновление пользователя
- `delete_user` — удаление пользователя
- `update_permissions` — изменение прав доступа
- `toggle_maintenance` — включение/выключение режима обслуживания
- И другие действия в системе

### Экспорт логов

В будущем планируется добавить возможность экспорта логов в CSV или JSON формате.

---

## Управление режимом обслуживания

### Что такое режим обслуживания

Режим обслуживания позволяет временно ограничить доступ к системе для проведения технических работ, обновлений или других операций.

### Включение режима обслуживания

**Шаги:**

1. В боковом меню выберите **"Технические работы"**
2. Включите переключатель **"Режим обслуживания"**
3. Введите сообщение для пользователей (опционально)
4. Нажмите **"Сохранить"**

**Результат:**
- Режим обслуживания включен
- Все пользователи (кроме creator) видят сообщение об обслуживании
- Доступ к системе ограничен

### Выключение режима обслуживания

**Шаги:**

1. Откройте страницу **"Технические работы"**
2. Выключите переключатель **"Режим обслуживания"**
3. Нажмите **"Сохранить"**

**Результат:**
- Режим обслуживания выключен
- Доступ к системе восстановлен для всех пользователей

### Сообщение для пользователей

При включении режима обслуживания можно указать сообщение, которое увидят пользователи. Это может быть:
- Причина технических работ
- Ожидаемое время завершения
- Контактная информация

**Пример сообщения:**
```
Проводятся технические работы. Система будет недоступна до 15:00.
```

### Важные замечания

- Режим обслуживания не влияет на доступ creator к админке
- Режим обслуживания применяется только к выбранному окружению
- Для каждого окружения режим обслуживания настраивается отдельно

---

## Управление тестерами

### Что такое тестеры

Тестеры — это специальные сущности в системе, которые используются для тестирования функциональности. Они не являются пользователями, но могут быть связаны с пользователями.

### Просмотр списка тестеров

1. В боковом меню выберите **"Тестера"**
2. Откроется страница со списком всех тестеров выбранного окружения

**Примечание:** Управление тестерами доступно только в окружениях, где есть модель `Tester` в базе данных.

### Создание тестера

**Шаги:**

1. На странице списка тестеров заполните форму:
   - **Имя** (обязательно)
   - **Активен** — включите, чтобы тестер был активен
2. Нажмите **"Создать"**

**Результат:**
- Тестер создан
- Отображается в списке тестеров

### Переключение активности тестера

**Шаги:**

1. В списке тестеров найдите нужного тестера
2. Нажмите кнопку переключения активности

**Результат:**
- Статус активности тестера изменен
- Изменение зафиксировано в логах аудита

### Удаление тестера

**Шаги:**

1. В списке тестеров нажмите кнопку **"Удалить"** рядом с нужным тестером
2. Подтвердите удаление

**Важно:**
- Удаление тестера необратимо
- Действие зафиксировано в логах аудита

---

## Статистика и мониторинг

### Статистика окружений

На дашборде отображается статистика для каждого окружения:
- Количество пользователей
- Количество активных пользователей
- Статус базы данных
- Время последнего обновления

### Мониторинг доступности

Админка автоматически проверяет доступность окружений:
- **Доступно** — окружение отвечает на запросы
- **Недоступно** — окружение не отвечает или не настроено

### Обновление статистики

Статистика обновляется автоматически при загрузке дашборда. Для ручного обновления перезагрузите страницу.

---

## Часто задаваемые вопросы

### Как создать пользователя creator?

Используйте скрипт:

```bash
railway run --service admin python scripts/reset_admin_user.py <username> <password> creator
```

### Почему окружение показывает статус "Недоступно"?

Возможные причины:
1. Переменные окружения не настроены
2. Неверный URL окружения
3. Неверный токен безопасности
4. Окружение действительно недоступно

**Решение:** Проверьте переменные окружения в Railway и убедитесь, что окружение работает.

### Как изменить токен безопасности?

1. Сгенерируйте новый токен (длинная случайная строка)
2. Обновите переменную окружения `*_ADMIN_TOKEN` во всех сервисах (production, sandbox, admin)
3. Обновите переменную окружения в сервисе `admin`
4. Перезапустите все сервисы

### Можно ли работать с несколькими окружениями одновременно?

Нет, в один момент времени можно работать только с одним окружением. Выбранное окружение сохраняется в сессии и используется для всех операций до следующего переключения.

### Что делать, если забыл пароль creator?

Используйте скрипт для сброса пароля:

```bash
railway run --service admin python scripts/reset_admin_user.py <username> <new_password> creator
```

### Как инициализировать права доступа?

Права доступа инициализируются автоматически при первом открытии страницы "Права доступа". Если права не инициализировались, можно запустить скрипт:

```bash
railway run --service <environment> python scripts/init_role_permissions.py
```

### Можно ли удалить пользователя creator?

Нет, пользователя с ролью `creator` нельзя удалить через интерфейс админки. Это сделано для безопасности системы.

### Как работает режим обслуживания?

Режим обслуживания блокирует доступ к системе для всех пользователей, кроме `creator`. При включении режима пользователи видят сообщение об обслуживании и не могут войти в систему.

### Где хранятся логи аудита?

Логи аудита хранятся в базе данных каждого окружения в таблице `AuditLog`. Они не синхронизируются между окружениями.

### Можно ли экспортировать логи аудита?

В текущей версии экспорт логов не реализован. Эта функция планируется в будущих обновлениях.

---

## Безопасность

### Рекомендации по безопасности

1. **Токены безопасности:**
   - Используйте длинные случайные строки (минимум 32 символа)
   - Храните токены в переменных окружения, а не в коде
   - Регулярно обновляйте токены

2. **Доступ к админке:**
   - Только пользователи с ролью `creator` имеют доступ
   - Используйте надежные пароли
   - Регулярно проверяйте логи аудита на подозрительную активность

3. **Переменные окружения:**
   - Не коммитьте переменные окружения в Git
   - Используйте разные токены для разных окружений
   - Ограничьте доступ к переменным окружения в Railway

4. **Логи аудита:**
   - Регулярно проверяйте логи на подозрительную активность
   - Храните логи в течение разумного периода времени
   - Удаляйте старые логи для освобождения места

---

## Поддержка

Если у вас возникли проблемы или вопросы:

1. Проверьте логи в Railway для сервиса `admin`
2. Проверьте переменные окружения
3. Убедитесь, что все окружения доступны
4. Проверьте логи аудита на наличие ошибок

---

## Заключение

Удаленная админка предоставляет мощные инструменты для управления всеми окружениями платформы из одного места. Используйте этот гайд как справочник при работе с админкой.

**Важно:** Все действия в админке логируются. Будьте осторожны при выполнении операций, особенно при удалении пользователей или изменении прав доступа.
