# Предрелизный тест платформы (без тренажёра)

Дата: 2026‑01‑22  
Область: **вся платформа**, кроме раздела **«Тренажёр»** и URL `/trainer` (не открываем, не проверяем).

## 1) Цель и критерии готовности

### Цель
Проверить, что платформа готова к запуску: **логин, роли/права, ученики, уроки, расписание, задания/сдачи, проверка, уведомления, админ‑функции и экспорты** работают без критических сбоев.

### Критерии готовности к релизу
- **P0 (блокер)**: нет падений 500/traceback на основных сценариях; нет обхода прав (доступ к чужим данным).
- **P1 (высокий)**: основные сценарии обучения и проверки работают от начала до конца (см. разделы 4–8).
- **P2 (средний)**: косметика/тексты/мелкие UX‑шероховатости допускаются, если есть обходной путь и нет риска потери данных.

### Как фиксировать дефекты
Для каждого дефекта прикладывать:
- URL страницы
- роль/логин
- шаги воспроизведения (1–5)
- ожидаемое vs фактическое
- скрин/видео
- если есть доступ: фрагмент логов по времени

Шаблон:

```text
ID:
Severity: P0/P1/P2
Role:
URL:
Steps:
Expected:
Actual:
Attachments:
```

---

## 2) Входные точки и навигация (точно по проекту)

### Публичные страницы (без логина)
- `GET /health` — JSON “Application is running”.
- `GET /landing` — лендинг.
- `GET /index` и `GET /home` — главная страница (редиректит в `/dashboard` если вы уже авторизованы).

### Аутентификация
- `GET/POST /login` — форма входа.
- `GET/POST /logout` — выход.

### Главные страницы после входа
- `GET /dashboard` — главная (не для student/parent).
- `GET /student/dashboard` — дашборд ученика (для роли student).
- `GET /parent/dashboard` — дашборд родителя (для роли parent).

### Основные разделы меню (верхняя навигация)
См. `templates/_primary_nav.html`:
- **Ученики**: `/dashboard`
- **Расписание**: `/schedule`
- **Учёба → Работы**: `/assignments`
- **Учёба → Проверка**: `/reviews/queue`
- **Учёба → Напоминания**: `/reminders`
- **Инструменты → Генератор**: `/kege-generator` (путь формируется `url_for('kege_generator.kege_generator')`)
- **Инструменты → Группы**: `/groups`
- **Инструменты → Приглашения**: `/onboarding/invites` (см. `app/onboarding/routes.py`)
- **Инструменты → Рубрики**: `/rubrics`
- **Инструменты → Библиотека**: `/library/materials`
- **Инструменты → Тарифы/подписки**: `/billing/plans` (только при праве `billing.manage`)

---

## 3) Подготовка данных (делает админ/создатель ДО старта тестеров)

### 3.1 Обязательные аккаунты
Нужно 4 учётки (логин/пароль вы выдаёте тестерам заранее):
- **Admin или Creator** (для админ‑панели и служебных функций)
- **Tutor** (преподаватель)
- **Student** (ученик)
- **Parent** (родитель)

### 3.2 Связи доступа (чтобы не было “пустых экранов”)
В системе доступ к ученикам для tutor/parent строится через **Enrollment** и **FamilyTie**:
- Tutor должен видеть хотя бы одного ученика (через Enrollment).
- Parent должен видеть хотя бы одного ребёнка (через FamilyTie).

Это настраивается в **Админ‑панели → Пользователи**:
- `GET /admin/users`
  - там есть действия по связям (FamilyTie/Enrollment).

### 3.3 Минимальный набор сущностей в БД
Подготовить минимум:
- 1 ученик (Student) с заполненным `email` (важно для связки User↔Student)
- 3 урока для этого ученика:
  - один **planned** в будущем
  - один **completed** в прошлом
  - (опционально) один **in_progress** для проверки “идёт урок”

Уроки можно создать:
- из профиля ученика: `GET /student/<student_id>` → кнопка **«Новый урок»**
- из расписания: `GET /schedule` → клик по сетке (если у роли есть права создания)

---

## 4) Smoke‑тест (обязательный, ~10 минут)

Отмечайте чекбоксы ✅/❌.

### 4.1 Health + публичные страницы
- [ ] `GET /health` возвращает JSON с `status=OK`
- [ ] `GET /landing` открывается без логина
- [ ] `GET /index` открывается без логина

### 4.2 Логин/логаут
Для каждого аккаунта (Admin/Creator, Tutor, Student, Parent):
- [ ] `GET /login` открывается
- [ ] логин успешен → редирект:
  - student → профиль ученика (`/student/<id>`) или `/dashboard` если профиль не найден
  - parent → `/parent/dashboard`
  - tutor/admin → `/dashboard`
- [ ] `GET /logout` разлогинивает и переводит на `/login`
- [ ] попытка открыть `/dashboard` после logout приводит на `/login`

---

## 5) Права и видимость (RBAC / data-scope) — критично

### 5.1 Student
Под student:
- [ ] меню показывает **Мой профиль** (если `current_student` определён) и **Статистика**
- [ ] нельзя видеть `/dashboard` как страницу учителя (должен быть редирект на student‑страницы)
- [ ] нельзя создавать ученика (`/student/new`) — должно быть 403/редирект
- [ ] нельзя редактировать ученика и уроки (в профиле ученика кнопок **«Новый урок» / «Ред.»** нет)

### 5.2 Parent
Под parent:
- [ ] `GET /parent/dashboard` открывается
- [ ] видны дети, выбор ребёнка работает (переключение по `?student_id=...`)
- [ ] parent не видит учительский `/dashboard`
- [ ] parent не видит кнопки редактирования/создания уроков

### 5.3 Tutor
Под tutor:
- [ ] `GET /dashboard` открывается, видны ученики в зоне доступа
- [ ] `GET /students` открывается (список активных/архивных)
- [ ] `GET /schedule` открывается
- [ ] tutor не видит чужих учеников/уроков (проверить через прямой URL чужого `student_id`)

### 5.4 Admin/Creator
Под admin/creator:
- [ ] доступ к `/admin` (админ панель)
- [ ] доступ к `/admin/users` (пользователи)
- [ ] доступ к `/billing/plans` и `/billing/subscriptions` (если роль имеет `billing.manage`)

---

## 6) Ученики (Student) и профиль ученика

### 6.1 Dashboard учителя (`/dashboard`)
Под tutor:
- [ ] работает поиск учеников (поле **«Поиск»**, кнопка **«Найти»**)
- [ ] фильтр категории работает (селект **«Категория»**)
- [ ] кнопка **«Добавить»** ведёт на `/student/new`
- [ ] вкладки **Активные/Архив** переключаются (параметр `show_archive=true|false`)

### 6.2 Создание ученика (`/student/new`)
Под tutor/admin:
- [ ] форма создаёт ученика
- [ ] после сохранения редирект на `/dashboard`
- [ ] в карточке ученика на dashboard отображаются: имя, ID (если есть), категория/класс (если заполнено)

### 6.3 Профиль ученика (`/student/<student_id>`)
Под tutor:
- [ ] открывается профиль ученика
- [ ] видны кнопки: **Новый урок**, **Ред.**, **Статистика**, **Диагностика**, **Журнал**, **Траектория**, **Курсы**
- [ ] блок “Лента занятий” показывает уроки
- [ ] фильтр ленты (селект) переключает “Все/Предстоящие/Прошедшие”

### 6.4 Архивирование ученика
Под tutor/admin:
- [ ] в профиле/списке учеников есть действие “архив/восстановить” (если доступно в UI)
- [ ] после архива ученик пропадает из “Активные” и появляется в “Архив”

---

## 7) Уроки и «классная комната»

### 7.1 Создание урока (из профиля ученика)
Под tutor:
- открыть `/student/<student_id>` → **Новый урок**
- создать урок с:
  - статус `planned`
  - тип `regular`
  - дата/время в будущем
- [ ] после сохранения урок появляется в профиле ученика в “Лента занятий”

### 7.2 Запуск урока и “зелёная панель”
Под tutor:
- на профиле ученика запустить урок:
  - либо кнопкой “Начать урок” (если есть на карточке урока),
  - либо POST‑роутом `/lesson/<lesson_id>/start` из UI
- [ ] появляется “плашка” сверху (now‑playing) и открывается панель текущего урока
- [ ] кнопка **«Завершить»** завершает урок (`POST /lesson/<lesson_id>/complete`)

### 7.3 Редактирование темы/времени урока преподавателем (критично)
Под tutor:
- открыть урок через “Войти в класс” или прямой URL:
  - `GET /lesson/<lesson_id>/homework-tasks`
- [ ] на странице урока есть кнопка **Edit Lesson** (в шапке страницы `lesson_homework.html`)
- нажать → `GET /lesson/<lesson_id>/edit`
- изменить:
  - тему (topic)
  - дату/время (lesson_date)
- сохранить
- [ ] после обновления страницы изменения сохраняются

Дополнительно (быстрое редактирование в расписании):
- `GET /schedule` → клик по уроку → инспектор → изменить `topic`, `duration`, `lesson_date`, `lesson_time` → сохранить
- [ ] изменения сохраняются и урок “переезжает” в новый слот

### 7.4 Классная комната: ДЗ/КР/Проверочная
Под tutor:
- открыть один урок:
  - ДЗ: `GET /lesson/<lesson_id>/homework-tasks`
  - КР: `GET /lesson/<lesson_id>/classwork-tasks`
  - Проверочная: `GET /lesson/<lesson_id>/exam-tasks`
- [ ] вкладки/переключение работают, данные не теряются при переходах

### 7.5 Экспорт Markdown по типам (критично)
Под tutor:
- на странице урока внизу есть блок действий с экспортом (см. `lesson_homework.html`)
- [ ] **Экспорт ДЗ**: `GET /lesson/<lesson_id>/homework-export-md` открывается (в новой вкладке)
- [ ] **Экспорт КР**: `GET /lesson/<lesson_id>/classwork-export-md` открывается
- [ ] **Экспорт Проверочной**: `GET /lesson/<lesson_id>/exam-export-md` открывается

Под student/parent:
- [ ] кнопок экспорта **нет**
- [ ] прямое открытие export‑URL даёт 403/редирект (не выдаёт файл)

### 7.6 Сообщения по уроку (чат lesson ↔ user)
Под student и tutor:
- открыть `GET /lesson/<lesson_id>/messages`
- отправить сообщение (форма `POST /lesson/<lesson_id>/messages/send`)
- [ ] сообщение появляется в ленте, после обновления страницы сохраняется

### 7.7 Материалы урока (защищённая отдача)
Под tutor:
- в уроке загрузить материал: `POST /lesson/<lesson_id>/upload` (через UI загрузки)
- [ ] материал появляется в уроке
- [ ] файл скачивается по защищённому URL:
  - `/files/lessons/<lesson_id>/<stored_name>`

Проверка доступа:
- под student/parent, который имеет доступ к ученику: файл скачивается
- под чужим student: 403/редирект

---

## 8) Расписание

### 8.1 Просмотр (`/schedule`)
Под tutor:
- `GET /schedule` открывается
- [ ] переключатель режима: **Неделя / Список** работает (`view=week|agenda`)
- [ ] переключатель таймзоны: **МСК / Томск** меняет отображение времени
- [ ] фильтры: статус/категория/ученик работают

### 8.2 Создание урока из расписания
Под tutor (с правом создания):
- клик по сетке → форма создания урока
- создать урок → [ ] появляется новый блок на сетке без перезагрузки (AJAX) или после F5

### 8.3 Перетаскивание/перенос
Под tutor:
- перетащить урок на другое время/день
- [ ] урок сохраняет новое время (после F5 остаётся)

### 8.4 Проверка конфликтов пересечений (критично)
Под tutor:
- попытаться перенести/создать урок в слот, где уже есть урок у этого ученика
- [ ] получаем понятную ошибку (409) и урок не “ломается”
- аналогично для пересечения у преподавателя (если у него есть 2 ученика)

### 8.5 Экспорт `.ics`
Под tutor/student/parent (у кого есть `schedule.view`):
- в расписании открыть меню **Действия** → кнопка **Экспорт .ics**
- [ ] скачивается файл `schedule.ics`, в календаре времена соответствуют выбранной таймзоне

### 8.6 Приватная ссылка `.ics` из профиля пользователя
Под tutor/student/parent:
- открыть `GET /user/profile`
- раскрыть **Синхронизация календаря**
- нажать **Обновить ссылку** (вызывает `POST /schedule/ics-token/regenerate`)
- [ ] в поле появляется URL вида `/schedule/ics/<token>?timezone=...`
- открыть этот URL в новой вкладке:
  - [ ] возвращает `.ics` без требования логина

---

## 9) Работы (новая система Assignments/Submissions)

### 9.1 Учитель: список работ (`/assignments`)
Под tutor:
- `GET /assignments` открывается
- [ ] кнопка **Создать новую работу** ведёт в генератор (`/kege-generator`)
- [ ] карточки работ кликабельны и ведут на `/assignments/<assignment_id>`

### 9.2 Учитель: просмотр работы (`/assignments/<id>`)
Под tutor:
- открыть конкретную работу
- [ ] видны задания и список сдач учеников

### 9.3 Ученик: “Мои работы” (`/submissions`)
Под student:
- `GET /submissions` открывается
- [ ] видны карточки назначенных работ и статусы:
  - ASSIGNED / IN_PROGRESS / SUBMITTED / GRADED / RETURNED
- [ ] кнопка на карточке корректна: “Начать/Продолжить/Просмотр”

### 9.4 Ученик: выполнение работы (`/submissions/<id>`)
Под student:
- открыть сдачу
- нажать “Начать” (вызывает `POST /submissions/<id>/start`) → статус становится IN_PROGRESS
- внести ответы → проверить автосохранение (`PUT /submissions/<id>/autosave`) через UI (достаточно убедиться, что после F5 ответы на месте)
- нажать “Сдать” (вызывает `POST /submissions/<id>/submit`)
- [ ] статус становится SUBMITTED или GRADED (если всё авто‑проверяемо)

### 9.5 Учитель: проверка сдачи (`/submissions/<id>/grade`)
Под tutor:
- открыть сдачу в статусе SUBMITTED
- выставить баллы и общий комментарий
- выбрать статус:
  - **GRADED** (проверено) или
  - **RETURNED** (на доработку)
- сохранить
- [ ] у ученика на `/submissions/<id>` отображается новый статус и комментарии

### 9.6 Комментарии к сдаче (чат по работе)
Под student и tutor:
- на странице сдачи добавить комментарий (API `POST /submissions/<id>/comments`)
- [ ] комментарий появляется и виден второй стороне

---

## 10) Единый журнал проверок (`/reviews/queue`)

Под tutor (право `assignment.grade`):
- открыть `GET /reviews/queue`
- [ ] фильтры работают:
  - status: `submitted|returned|graded|pending`
  - source: `all|lessons|assignments`
  - assignment_type: `homework|classwork|exam`
  - student (поиск по имени)
- [ ] в списке есть карточки:
  - по LessonTask (классная комната)
  - по Submission (новая система)

Проверить быстрые действия:
- “быстро вернуть на доработку” для Submission (`POST /submissions/<id>/quick-return`)
- массовые действия по сдачам Assignment (`POST /assignments/<id>/reviews/bulk`)

---

## 11) Траектория, диагностика, статистика, журнал (Student‑страницы)

Открывать из профиля ученика (`/student/<id>`):

### 11.1 Траектория
- `GET /student/<id>/plan`
- Под tutor:
  - [ ] создание пункта траектории
  - [ ] редактирование пункта
  - [ ] удаление пункта
- Под student/parent:
  - [ ] просмотр доступен (если выдано право `plan.view`)
  - [ ] редактирование недоступно

### 11.2 Диагностика
- `GET /student/<id>/diagnostics`
- Под tutor:
  - [ ] “Сохранить контрольную точку” (`POST /student/<id>/diagnostics/checkpoints/create`)
- Под student/parent:
  - [ ] просмотр, без кнопки сохранения

### 11.3 Журнал оценок
- `GET /student/<id>/gradebook`
- Под tutor:
  - [ ] создать запись (`POST /student/<id>/gradebook/create`)
  - [ ] обновить запись (`POST /student/<id>/gradebook/<entry_id>/update`)
  - [ ] удалить запись (`POST /student/<id>/gradebook/<entry_id>/delete`)
- Экспорты:
  - [ ] CSV: `GET /student/<id>/gradebook.csv` скачивается
  - [ ] PDF: `GET /student/<id>/gradebook.pdf` скачивается (или отдаёт printable HTML fallback)

---

## 12) Группы (`/groups`)

Под tutor/admin (с правами `groups.view`, `groups.manage`):
- [ ] `GET /groups` показывает список групп
- [ ] создать группу: `GET/POST /groups/new`
- [ ] открыть группу: `GET /groups/<id>`
- [ ] добавить ученика в группу: `POST /groups/<id>/members/add`
- [ ] удалить ученика из группы: `POST /groups/<id>/members/<member_id>/remove`
- Экспорты:
  - [ ] CSV: `GET /groups/<id>/export.csv`
  - [ ] PDF: `GET /groups/<id>/export.pdf` (или printable HTML fallback)

---

## 13) Курсы (`/student/<id>/courses`, `/courses/<id>`)

Под tutor:
- открыть список курсов ученика: `GET /student/<id>/courses`
- создать курс: `GET/POST /student/<id>/courses/new`
- открыть курс: `GET /courses/<course_id>`
- создать модуль: `GET/POST /courses/<course_id>/modules/new`
- привязать урок к модулю: `POST /courses/<course_id>/assign-lesson`
- [ ] урок отображается внутри нужного модуля курса

Под student:
- [ ] просмотр курсов доступен
- [ ] создание/редактирование курса запрещено (должно показать flash “Ученик не может …”)

---

## 14) Библиотека материалов и шаблоны комнаты (`/library/*`)

Под tutor (нужен доступ `lesson.edit`):

### 14.1 Материалы
- `GET /library/materials` открывается
- загрузить материал: `POST /library/materials/upload`
- [ ] материал появляется в списке
- [ ] скачивание через защищённый URL: `/files/library/<asset_id>`
- удалить материал: `POST /library/materials/<asset_id>/delete`

### 14.2 Шаблоны комнаты урока
- `GET /library/lesson-templates`
- создать шаблон из урока: `POST /library/lesson-templates/from-lesson`
- применить шаблон к уроку: `POST /library/lesson-templates/<template_id>/apply`
- [ ] в уроке обновляется контент/материалы согласно шаблону

---

## 15) Рубрики (критерии) (`/rubrics`)

Под tutor (право `rubrics.manage`):
- `GET /rubrics` открывается
- [ ] создать рубрику: `GET/POST /rubrics/new`
- [ ] редактировать: `GET/POST /rubrics/<id>/edit`
- [ ] удалить: `POST /rubrics/<id>/delete`

Проверка интеграции в проверку работ:
- открыть `/submissions/<id>/grade` и убедиться, что можно выбрать рубрику (список `rubric_templates`) и сохранить.

---

## 16) Уведомления (`/notifications`)

Под любой роли:
- `GET /notifications` открывается
- [ ] “непрочитанные” отображаются по умолчанию
- [ ] отметить одно прочитанным: `POST /notifications/<id>/read`
- [ ] отметить все прочитанными: `POST /notifications/read-all`
- [ ] `GET /notifications/unread-count` возвращает корректное число

---

## 17) Напоминания (`/reminders`)

Под любой роли:
- `GET /reminders` открывается
- создать напоминание: `POST /reminders/create` (через UI)
- [ ] переключить выполнено: `POST /reminders/<id>/toggle`
- [ ] изменить: `POST /reminders/<id>/update`
- [ ] удалить: `POST /reminders/<id>/delete`

Регрессия времени:
- создать напоминание с временем “сегодня + 5 минут”
- [ ] не падает с ошибками timezone/naive/aware

---

## 18) Админ‑панель (основной деплой, не remote-admin)

Под admin/creator:

### 18.1 Админ панель
- `GET /admin` открывается (`templates/admin_panel.html`)
- [ ] работает переход **Пользователи** → `/admin/users`
- [ ] **Аудит** → `/admin-audit`
- [ ] **Темы** → `/admin/topics`
- [ ] (creator) **Права доступа** → `/admin/permissions`

### 18.2 Пользователи и связи
- `GET /admin/users` открывается
- [ ] создание пользователя: `GET/POST /admin/users/new`
- [ ] редактирование: `GET/POST /admin/users/<id>/edit`
- [ ] проверка графа связей: `GET /admin/users/graph-data` (не 500)
- [ ] добавить/удалить Enrollment и FamilyTie через UI (роуты `/admin/api/enrollments*`, `/admin/api/family-ties*`)

### 18.3 Тарифы и подписки (если включены в релиз)
- `GET /billing/plans`:
  - [ ] создание тарифа (есть галочки “Доступ: уроки / тренажёр”)
  - [ ] редактирование тарифа
- `GET /billing/subscriptions`:
  - [ ] назначить подписку пользователю (assign)
  - [ ] отменить подписку

Проверка ограничения доступа по подписке (уроки):
- назначить пользователю тариф с `allow_lessons = false`
- под этим пользователем:
  - [ ] попытка открыть `/schedule`, `/student/<id>`, `/lesson/...` редиректит на `/dashboard`

---

## 19) Что НЕ тестируем в этом прогоне
- `/trainer` и всё, что связано с AI‑тренажёром и LLM.
- Streamlit‑сервис тренажёра.

