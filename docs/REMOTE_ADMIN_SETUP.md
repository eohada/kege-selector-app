# Настройка удаленной админки

## Архитектура

Удаленная админка - это отдельное приложение, которое управляет другими окружениями (production, sandbox, admin) через API.

**Как это работает:**
1. Удаленная админка развернута в отдельном окружении Railway (например, "admin")
2. Она подключается к другим окружениям через HTTP API
3. Каждое окружение должно иметь внутренние API endpoints (`/internal/remote-admin/*`)
4. Аутентификация происходит через токены в заголовках

## Шаги настройки

### 1. Настройка нового окружения "admin" в Railway

В новом окружении "admin" установите следующие переменные окружения:

```bash
# URL и токен для подключения к production
PRODUCTION_URL=https://your-production-app.up.railway.app
PRODUCTION_ADMIN_TOKEN=<сгенерируйте_случайный_токен>

# URL и токен для подключения к sandbox
SANDBOX_URL=https://your-sandbox-app.up.railway.app
SANDBOX_ADMIN_TOKEN=<сгенерируйте_случайный_токен>

# URL и токен для самого окружения admin (если нужно)
ADMIN_URL=https://your-admin-app.up.railway.app
ADMIN_ADMIN_TOKEN=<сгенерируйте_случайный_токен>
```

**Как сгенерировать токен:**
```bash
# В Linux/Mac
openssl rand -hex 32

# Или используйте любой генератор случайных строк (минимум 32 символа)
```

### 2. Настройка production окружения

В production окружении добавьте:

```bash
PRODUCTION_ADMIN_TOKEN=<тот_же_токен_что_в_ADMIN_URL>
```

Этот токен должен совпадать с `PRODUCTION_ADMIN_TOKEN` в окружении admin.

### 3. Настройка sandbox окружения

В sandbox окружении добавьте:

```bash
SANDBOX_ADMIN_TOKEN=<тот_же_токен_что_в_SANDBOX_URL>
```

Этот токен должен совпадать с `SANDBOX_ADMIN_TOKEN` в окружении admin.

### 4. Проверка работы

1. Откройте удаленную админку: `https://your-admin-app.up.railway.app/remote-admin`
2. Войдите как создатель (creator)
3. Выберите окружение (production или sandbox)
4. Проверьте, что статус окружения показывает "Доступно"
5. Попробуйте открыть список пользователей

## Структура переменных окружения

### В окружении "admin":
```
PRODUCTION_URL=https://production.up.railway.app
PRODUCTION_ADMIN_TOKEN=abc123...
SANDBOX_URL=https://sandbox.up.railway.app
SANDBOX_ADMIN_TOKEN=def456...
ADMIN_URL=https://admin.up.railway.app
ADMIN_ADMIN_TOKEN=ghi789...
```

### В окружении "production":
```
PRODUCTION_ADMIN_TOKEN=abc123...  # Тот же токен!
```

### В окружении "sandbox":
```
SANDBOX_ADMIN_TOKEN=def456...  # Тот же токен!
```

## Добавление произвольных окружений

Если нужно добавить еще одно окружение (например, staging):

1. В окружении "admin" добавьте:
```bash
ENV_STAGING_URL=https://staging.up.railway.app
ENV_STAGING_TOKEN=xyz789...
```

2. В окружении "staging" добавьте:
```bash
STAGING_ADMIN_TOKEN=xyz789...  # Тот же токен!
```

Окружение автоматически появится в списке доступных.

## Безопасность

⚠️ **Важно:**
- Токены должны быть длинными случайными строками (минимум 32 символа)
- Не храните токены в коде или публичных репозиториях
- Используйте разные токены для каждого окружения
- Регулярно обновляйте токены

## Устранение проблем

### Окружение показывает "Не настроено"
- Проверьте, что переменные `*_URL` и `*_ADMIN_TOKEN` установлены
- Убедитесь, что URL правильный и доступен

### Окружение показывает "Недоступно"
- Проверьте, что внутренние API endpoints работают: `https://your-app.up.railway.app/internal/remote-admin/status`
- Проверьте токен - он должен совпадать в обоих окружениях
- Проверьте логи приложения на наличие ошибок

### Ошибка 401 Unauthorized
- Токены не совпадают между окружениями
- Проверьте, что токен правильно передается в заголовке `X-Admin-Token`

## Что дальше?

После настройки вы сможете:
- ✅ Управлять пользователями во всех окружениях из одного места
- ✅ Просматривать статистику всех окружений
- ✅ Переключаться между окружениями одним кликом
- ✅ В будущем: управлять правами, логами, техработами удаленно
