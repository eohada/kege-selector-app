# Устранение проблем с расписанием

## Проблема: Расписание работает в песочнице, но сломано в проде

### Шаг 1: Диагностика данных

Запустите скрипт для сравнения данных между окружениями:

```bash
# Получите DATABASE_URL из Railway для обоих окружений
# Песочница: Railway Dashboard -> Sandbox Service -> Variables -> DATABASE_URL
# Продакшн: Railway Dashboard -> Production Service -> Variables -> DATABASE_URL

python scripts/compare_sandbox_prod.py \
  --sandbox-url "postgresql://..." \
  --prod-url "postgresql://..."
```

Скрипт покажет:
- Количество уроков в каждом окружении
- Дубликаты уроков
- Уроки, которые есть только в проде
- Различия во времени уроков
- Статистику по дням недели

### Шаг 2: Проверка дубликатов в проде

Если найдены дубликаты:

```bash
# Сначала посмотрите, что будет удалено
python scripts/find_duplicate_lessons.py

# Затем удалите дубликаты (оставит самый заполненный урок)
python scripts/find_duplicate_lessons.py --no-dry-run
```

### Шаг 3: Проверка данных в проде

Запустите диагностический скрипт для прода:

```bash
# Установите DATABASE_URL для прода
export DATABASE_URL="postgresql://..."

python scripts/check_schedule_data.py
```

### Шаг 4: Проверка логов Railway

После деплоя проверьте логи Railway на наличие предупреждений:

1. Откройте Railway Dashboard
2. Выберите Production Service
3. Перейдите в раздел "Logs"
4. Ищите сообщения типа:
   - "День X: обнаружено N параллельных уроков, возможны дубликаты"
   - "Урок X вне недели"

### Шаг 5: Проверка часовых поясов

Убедитесь, что в обоих окружениях одинаковые настройки:

1. Проверьте переменные окружения `TZ` или `TIMEZONE`
2. Проверьте, что `RAILWAY_ENVIRONMENT` установлен правильно
3. Проверьте диагностическую страницу: `/admin/diagnostics`

### Возможные причины проблем:

1. **Дубликаты уроков** - при синхронизации из песочницы в прод создались дубликаты
2. **Неправильные даты** - уроки были созданы с неправильным часовым поясом
3. **Разные данные** - в проде есть уроки, которых нет в песочнице
4. **Проблемы с фильтрацией** - код фильтрует уроки по-разному в разных окружениях

### Быстрое решение:

Если проблема критична и нужно быстро исправить:

1. Удалите все дубликаты в проде:
   ```bash
   python scripts/find_duplicate_lessons.py --no-dry-run
   ```

2. Проверьте, что код одинаковый в обоих окружениях (последний коммит)

3. Перезапустите сервис в Railway (Redeploy)

4. Очистите кеш браузера и проверьте расписание снова

### Контакты для помощи:

Если проблема не решается:
- Проверьте логи Railway
- Запустите все диагностические скрипты
- Сохраните вывод скриптов для анализа

