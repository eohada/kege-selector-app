# Полная структура проекта

## Обзор

Платформа для подготовки к ЕГЭ по математике с системой управления учениками, уроками, заданиями и автоматической генерацией вариантов КЕГЭ.

**Технологии:**
- Backend: Flask (Python)
- База данных: PostgreSQL (production) / SQLite (local)
- Frontend: Jinja2 templates, HTML/CSS/JavaScript
- Аутентификация: Flask-Login
- Безопасность: Flask-WTF (CSRF), RBAC (Role-Based Access Control)

---

## Архитектура

### Структура директорий

```
kege_selector_app/
├── app/                    # Основное приложение Flask
│   ├── __init__.py        # Фабрика приложений, инициализация
│   ├── models/            # Экспорт моделей БД
│   ├── auth/              # Аутентификация и авторизация
│   ├── main/              # Главная страница и dashboard
│   ├── students/          # Управление учениками
│   ├── lessons/           # Управление уроками
│   ├── assignments/       # Распределение и проверка работ
│   ├── kege_generator/    # Генератор заданий КЕГЭ
│   ├── schedule/          # Расписание занятий
│   ├── parents/           # Дашборд для родителей
│   ├── reminders/         # Напоминания
│   ├── templates_manager/ # Управление шаблонами уроков
│   ├── designer/          # Управление графическими ассетами
│   ├── api/               # REST API endpoints
│   └── utils/              # Утилиты и хуки
├── core/                   # Ядро приложения
│   ├── db_models.py       # Все модели SQLAlchemy
│   ├── selector_logic.py  # Логика выбора уникальных заданий
│   ├── audit_logger.py    # Система аудита действий
│   └── audit_decorators.py # Декораторы для аудита
├── templates/              # Jinja2 шаблоны
├── static/                 # Статические файлы (CSS, JS, изображения)
├── scripts/                # Вспомогательные скрипты
├── data/                   # Локальная база данных (SQLite)
└── docs/                   # Документация
```

---

## Модули приложения (Blueprints)

### 1. `app/auth` - Аутентификация и авторизация

**Файлы:**
- `routes.py` - Маршруты входа/выхода, профиль
- `permissions.py` - Реестр прав доступа (RBAC)
- `rbac_utils.py` - Утилиты для проверки прав

**Маршруты:**
- `GET/POST /auth/login` - Страница входа
- `POST /auth/logout` - Выход из системы
- `GET /auth/user/profile` - Профиль пользователя
- `POST /auth/user/profile/update` - Обновление профиля

**Роли пользователей:**
- `creator` - Создатель (все права)
- `admin` - Администратор (все права)
- `tutor` - Преподаватель
- `student` - Ученик
- `parent` - Родитель
- `tester` - Тестировщик
- `chief_tester` - Главный тестировщик
- `designer` - Дизайнер

**Права доступа:**
- `user.*` - Управление пользователями
- `lesson.*` - Управление уроками
- `task.manage` - Управление банком заданий
- `assignment.*` - Распределение и проверка работ
- `tools.*` - Инструменты (тестировщики, расписание)
- `assets.manage` - Управление графикой
- `system.*` - Системные настройки

---

### 2. `app/main` - Главная страница и Dashboard

**Файлы:**
- `routes.py` - Главная страница, dashboard, health check

**Маршруты:**
- `GET /` - Главная страница (редирект на dashboard для авторизованных)
- `GET /index`, `/home` - Алиасы главной страницы
- `GET /dashboard` - Дашборд пользователя (зависит от роли)
- `GET /health` - Health check endpoint

**Функциональность:**
- Редирект в зависимости от роли пользователя
- Отображение статистики и последних действий
- Навигация по основным разделам

---

### 3. `app/students` - Управление учениками

**Файлы:**
- `routes.py` - CRUD операции с учениками
- `forms.py` - Формы для работы с учениками
- `utils.py` - Утилиты (нормализация класса)
- `stats_service.py` - Сервис статистики учеников

**Маршруты:**
- `GET /students` - Список всех учеников
- `GET/POST /student/new` - Создание нового ученика
- `GET /student/<id>` - Профиль ученика
- `GET/POST /student/<id>/edit` - Редактирование ученика
- `POST /student/<id>/delete` - Удаление ученика
- `POST /student/<id>/archive` - Архивирование ученика
- `GET /student/<id>/statistics` - Статистика ученика
- `POST /student/<id>/statistics/update` - Обновление статистики
- `POST /student/<id>/statistics/reset` - Сброс статистики
- `GET /student/<id>/analytics` - Аналитика ученика
- `GET/POST /student/<id>/lesson/new` - Создание урока для ученика
- `GET /student/<id>/lesson-mode` - Режим урока
- `POST /student/<id>/start-lesson` - Начало урока

**Модель Student:**
- Основная информация: имя, телефон, email, telegram
- Целевой балл, дедлайн
- Диагностический уровень, предпочтения
- Сильные/слабые стороны, общий рейтинг
- Связи: уроки, семейные связи, зачисления

---

### 4. `app/lessons` - Управление уроками

**Файлы:**
- `routes.py` - CRUD уроков, управление заданиями
- `forms.py` - Формы для уроков
- `utils.py` - Утилиты (сортировка, автопроверка)
- `export.py` - Экспорт уроков в Markdown

**Маршруты:**
- `GET/POST /lesson/<id>/edit` - Редактирование урока
- `GET /lesson/<id>/view` - Просмотр урока
- `POST /lesson/<id>/delete` - Удаление урока
- `POST /lesson/<id>/start` - Начало урока
- `POST /lesson/<id>/complete` - Завершение урока
- `GET /lesson/<id>/homework-tasks` - Домашние задания
- `GET /lesson/<id>/classwork-tasks` - Классная работа
- `GET /lesson/<id>/exam-tasks` - Проверочные работы
- `POST /lesson/<id>/homework-tasks/save` - Сохранение домашних заданий
- `POST /lesson/<id>/task/<id>/set-status` - Изменение статуса задания
- `POST /lesson/<id>/homework-auto-check` - Автопроверка домашних заданий
- `POST /lesson/<id>/classwork-auto-check` - Автопроверка классной работы
- `POST /lesson/<id>/exam-auto-check` - Автопроверка проверочных
- `POST /lesson/<id>/homework-tasks/<id>/delete` - Удаление задания

**Модель Lesson:**
- Дата и время урока
- Продолжительность
- Тип урока (обычный, диагностика, экзамен)
- Статус (planned, in_progress, completed)
- Связи: ученик, задания урока (LessonTask)

**Типы заданий в уроке:**
- `homework` - Домашнее задание
- `classwork` - Классная работа
- `exam` - Проверочная работа

---

### 5. `app/assignments` - Распределение и проверка работ

**Файлы:**
- `routes.py` - Создание, распределение и проверка работ

**Маршруты:**
- `POST /assignments/distribute` - Распределение работы ученикам
- `GET /assignments` - Список всех работ
- `GET /assignments/<id>` - Просмотр работы
- `GET /submissions` - Список сданных работ
- `GET /submissions/<id>` - Просмотр сданной работы
- `POST /submissions/<id>/start` - Начало выполнения работы
- `PUT /submissions/<id>/autosave` - Автосохранение ответов
- `POST /submissions/<id>/submit` - Сдача работы
- `GET /submissions/<id>/grade` - Страница проверки работы
- `POST /submissions/<id>/grade` - Сохранение оценки

**Модели:**
- `Assignment` - Работа (набор заданий)
- `AssignmentTask` - Задание в работе
- `Submission` - Сданная работа ученика
- `Answer` - Ответ ученика на задание

**Функциональность:**
- Создание работ из шаблонов или вручную
- Распределение работ ученикам
- Автоматическая проверка заданий с ответами
- Ручная проверка развернутых ответов
- Автосохранение прогресса

---

### 6. `app/kege_generator` - Генератор заданий КЕГЭ

**Файлы:**
- `routes.py` - Генерация заданий
- `forms.py` - Формы выбора заданий

**Маршруты:**
- `GET/POST /kege-generator` - Генератор заданий
- `GET/POST /kege-generator/<lesson_id>` - Генератор для урока

**Функциональность:**
- Выбор заданий по номерам (1-21)
- Фильтрация по темам
- Использование шаблонов заданий
- Учет истории использования (уникальность)
- Черный список заданий
- Сброс истории использования
- Поиск заданий по содержимому

**Логика выбора:**
- Исключение уже использованных заданий
- Исключение заданий из черного списка
- Исключение заданий, использованных в уроках ученика
- Случайный выбор из доступных

---

### 7. `app/schedule` - Расписание занятий

**Файлы:**
- `routes.py` - Календарь, создание уроков

**Маршруты:**
- `GET /schedule` - Календарь расписания
- `POST /schedule/lesson/create` - Создание урока из расписания
- `POST /schedule/lesson/<id>/update` - Обновление урока
- `POST /schedule/lesson/<id>/delete` - Удаление урока

**Функциональность:**
- Календарное отображение уроков
- Проверка пересечений по времени
- Поддержка разных часовых поясов (Москва, Томск)
- Создание уроков из расписания
- Редактирование и удаление уроков

---

### 8. `app/parents` - Дашборд для родителей

**Файлы:**
- `routes.py` - Дашборд родителя

**Маршруты:**
- `GET /parent/dashboard` - Дашборд родителя

**Функциональность:**
- Просмотр информации о детях
- Статистика по каждому ребенку
- Предстоящие уроки
- Недавние уроки
- Прогресс обучения

**Связи:**
- `FamilyTie` - Связь родителя с учеником
- Подтверждение связи родителем

---

### 9. `app/reminders` - Напоминания

**Файлы:**
- `routes.py` - Управление напоминаниями

**Маршруты:**
- `GET /reminders` - Список напоминаний
- `POST /reminders/create` - Создание напоминания
- `POST /reminders/<id>/delete` - Удаление напоминания

**Модель Reminder:**
- Текст напоминания
- Дата и время
- Связь с пользователем

---

### 10. `app/templates_manager` - Управление шаблонами

**Файлы:**
- `routes.py` - CRUD шаблонов

**Маршруты:**
- `GET /templates` - Список шаблонов
- `GET/POST /template/new` - Создание шаблона
- `GET /template/<id>` - Просмотр шаблона
- `GET/POST /template/<id>/edit` - Редактирование шаблона
- `POST /template/<id>/delete` - Удаление шаблона

**Модели:**
- `TaskTemplate` - Шаблон набора заданий
- `TemplateTask` - Задание в шаблоне

**Функциональность:**
- Создание шаблонов из генератора
- Применение шаблонов к урокам
- Редактирование и удаление шаблонов

---

### 11. `app/designer` - Управление графическими ассетами

**Файлы:**
- `routes.py` - Управление ассетами

**Маршруты:**
- `GET /designer/assets` - Список ассетов

**Функциональность:**
- Просмотр графических файлов
- Управление иконками и изображениями

---

### 12. `app/api` - REST API

**Файлы:**
- `routes.py` - API endpoints

**Маршруты:**
- Публичные и внутренние API endpoints
- Интеграция с внешними системами

---

## Ядро приложения (`core/`)

### `core/db_models.py` - Модели базы данных

**Основные модели:**

1. **Tasks** - Задания КЕГЭ
   - `task_id`, `task_number` (1-21)
   - `content_html` - HTML содержимое
   - `answer` - Ответ
   - `source_url` - URL источника
   - `attached_files` - Прикрепленные файлы

2. **Student** - Ученики
   - Основная информация, контакты
   - Целевой балл, дедлайн
   - Диагностика, предпочтения

3. **Lesson** - Уроки
   - Дата, время, продолжительность
   - Тип, статус
   - Связь с учеником

4. **LessonTask** - Задания в уроке
   - Связь урока и задания
   - Тип (homework/classwork/exam)
   - Статус выполнения

5. **User** - Пользователи системы
   - Аутентификация
   - Роли и права
   - Профиль

6. **UserProfile** - Профили пользователей
   - Дополнительная информация
   - Контакты

7. **FamilyTie** - Семейные связи
   - Связь родителя и ученика
   - Подтверждение

8. **Enrollment** - Зачисления
   - Связь ученика и преподавателя
   - Статус зачисления

9. **TaskTemplate** - Шаблоны заданий
   - Набор заданий для повторного использования

10. **Assignment** - Работы
    - Набор заданий для распределения

11. **Submission** - Сданные работы
    - Ответы ученика
    - Оценка

12. **Topic** - Темы заданий
    - Тегирование заданий
    - Категоризация

13. **UsageHistory** - История использования
    - Отслеживание использованных заданий

14. **SkippedTasks** - Пропущенные задания
    - Задания, которые ученик пропустил

15. **BlacklistTasks** - Черный список
    - Задания, исключенные из использования

16. **Reminder** - Напоминания
    - Напоминания для пользователей

17. **AuditLog** - Лог аудита
    - Запись всех действий в системе

18. **RolePermission** - Права ролей
    - RBAC система

19. **MaintenanceMode** - Режим обслуживания
    - Управление доступом к системе

---

### `core/selector_logic.py` - Логика выбора заданий

**Основные функции:**

- `get_unique_tasks()` - Получение уникальных заданий
- `record_usage()` - Запись использования задания
- `record_skipped()` - Запись пропущенного задания
- `record_blacklist()` - Добавление в черный список
- `reset_history()` - Сброс истории
- `get_accepted_tasks()` - Получение принятых заданий
- `get_skipped_tasks()` - Получение пропущенных заданий
- `get_next_unique_task()` - Следующее уникальное задание

**Логика:**
- Исключение уже использованных заданий
- Исключение заданий из черного списка
- Учет заданий из уроков ученика
- Случайный выбор из доступных

---

### `core/audit_logger.py` - Система аудита

**Функциональность:**
- Асинхронное логирование действий
- Запись в базу данных
- Метаданные действий
- Статусы (success, error, warning)

**Типы действий:**
- `login`, `logout`
- `create`, `update`, `delete`
- `view`, `export`
- И другие

---

### `core/audit_decorators.py` - Декораторы аудита

**Декораторы:**
- `@audit_action()` - Автоматическое логирование действий
- Параметры: action, entity, status

---

## Утилиты (`app/utils/`)

### `app/utils/hooks.py` - Хуки Flask

**Функции:**
- `register_hooks()` - Регистрация всех хуков
- `require_login()` - Проверка авторизации
- `check_maintenance_mode()` - Проверка режима обслуживания
- `initialize_on_first_request()` - Инициализация схемы БД
- `auto_update_lesson_status()` - Автообновление статусов уроков

---

### `app/utils/db_migrations.py` - Миграции БД

**Функции:**
- `ensure_schema_columns()` - Проверка и создание колонок
- `check_and_fix_rbac_schema()` - Проверка RBAC схемы
- `_fix_postgres_sequences()` - Исправление sequences PostgreSQL

---

### `app/utils/jinja_filters.py` - Фильтры Jinja2

**Фильтры:**
- `mask_contact()` - Маскирование контактов
- Другие пользовательские фильтры

---

## Шаблоны (`templates/`)

**Структура:**
- Базовые шаблоны: `_primary_nav.html`, `_user_menu.html`
- Модульные шаблоны: `_active_lesson_banner.html`, `_mobile_menu.html`
- Страницы модулей: `student_*.html`, `lesson_*.html`, и т.д.

**Основные шаблоны:**
- `index.html` - Главная страница
- `dashboard.html` - Дашборд
- `login.html` - Вход
- `student_profile.html` - Профиль ученика
- `lesson_form.html` - Форма урока
- `kege_generator.html` - Генератор заданий
- `schedule.html` - Расписание
- И другие

---

## Статические файлы (`static/`)

- CSS стили
- JavaScript файлы
- Изображения и иконки
- Шрифты
- Загруженные файлы (аватары, ассеты)

---

## Скрипты (`scripts/`)

**Категории скриптов:**

1. **Инициализация:**
   - `create_user.py` - Создание пользователей
   - `init_role_permissions.py` - Инициализация прав

2. **Миграции:**
   - `update_rbac_db.py` - Обновление RBAC
   - `add_role_column.py` - Добавление колонки роли

3. **Парсинг:**
   - Скрипты для парсинга заданий

4. **Бэкапы:**
   - `backup_database.py` - Резервное копирование

5. **Утилиты:**
   - Различные вспомогательные скрипты

---

## Конфигурация

### Переменные окружения

**Обязательные:**
- `DATABASE_URL` - URL базы данных
- `SECRET_KEY` - Секретный ключ для сессий
- `ENVIRONMENT` - Окружение (production, sandbox, local)

**Опциональные:**
- `DATABASE_EXTERNAL_URL` - Внешний URL БД
- `POSTGRES_URL` - Альтернативный URL PostgreSQL

### Инициализация приложения

**`app/__init__.py`:**
- Фабрика приложений `create_app()`
- Инициализация расширений (Flask-Login, CSRF, БД)
- Регистрация blueprints
- Настройка логирования
- Регистрация хуков
- Регистрация фильтров Jinja2

---

## Безопасность

1. **Аутентификация:**
   - Flask-Login для управления сессиями
   - Хеширование паролей (werkzeug)

2. **Авторизация:**
   - RBAC система
   - Проверка прав через декораторы

3. **CSRF защита:**
   - Flask-WTF для всех форм
   - Исключения для API endpoints

4. **Аудит:**
   - Логирование всех действий
   - Запись в AuditLog

5. **Режим обслуживания:**
   - Блокировка доступа при необходимости

---

## База данных

**Поддержка:**
- PostgreSQL (production)
- SQLite (local development)

**Миграции:**
- Автоматическое создание таблиц
- Проверка и исправление схемы
- Синхронизация sequences (PostgreSQL)

---

## Логирование

**Уровни:**
- INFO - Общая информация
- WARNING - Предупреждения
- ERROR - Ошибки
- DEBUG - Отладочная информация

**Направления:**
- Консоль (stdout)
- Файл `logs/app.log`

---

## Развертывание

**Платформа:**
- Railway (production, sandbox, admin)

**Процесс:**
- Nixpacks для сборки
- Автоматический деплой из Git
- Переменные окружения через Railway

---

## Зависимости

**Основные библиотеки:**
- Flask - веб-фреймворк
- SQLAlchemy - ORM
- Flask-Login - аутентификация
- Flask-WTF - формы и CSRF
- Werkzeug - утилиты (хеширование паролей)

**Дополнительные:**
- psycopg2 - драйвер PostgreSQL
- markdown - рендеринг Markdown (опционально)

---

## Примечания

- Проект использует модульную архитектуру с Flask Blueprints
- Все модели БД находятся в `core/db_models.py`
- Логика выбора заданий изолирована в `core/selector_logic.py`
- Система аудита автоматически логирует действия
- RBAC система позволяет гибко управлять правами доступа
